(function(){function p(C,E,z,A){var G=h("Total_Estimated_Price__c",C);var y=h("Estimated_Price2__c",C);var D=h("Discount__c",C);var F=h("Product__c",C);var B=a(F,E,z);var H=h("Covered__c",C);y.value=B;G.value=A.quantity*B;if(!q(H,A.so,"Parts_Discount_Covered__c","Parts_Discount_Not_Covered__c")){x(H,A.warranty,"Material_Covered__c");}var I=s(F,E);D.value=I;}function a(C,A,D){var y=-1,z=null;y=c(C,A);if(y==-1){var B=t(A,"RECORDTYPEINFO_PARTS_CONTRACT");if(B){z=j(D,B);if(z){y=f(z,A,C);}}}if(y==-1){y=g(C,A,D);}if(y==-1){y=i(C,A,D);}if(y==-1){y=0;}return y;}function i(C,A,D){var B=t(A,"RECORDTYPEINFO_PARTS_STANDARD"),y=-1,z=null;if(B){if(B){z=j(D,B);}}if(z){y=f(z,A,C);}return y;}function g(C,A,D){var B=t(A,"RECORDTYPEINFO_PARTS"),y=-1,z=null;if(B){if(B){z=j(D,B);}}if(z){y=f(z,A,C);}return y;}function c(E,C){var B=t(C,"CONTRACT_SPECIALPARTSPRICING");if(B){var D=B.data,y=D.length,A,z=-1;for(A=0;A<y;A++){if(D[A][k("Product__c")]==E.value){z=D[A][k("Price_Per_Unit__c")];$EXPR.Logger.info("A special price is available for PRODUCT => "+E.value);break;}}}return z;}function f(D,C,F){var y=t(C,"PARTSPRICING");if(y){var E=y.data,z=E.length,B,A=-1;for(B=0;B<z;B++){if(D==E[B].Pricebook2Id&&E[B].Product2Id==F.value){A=E[B].UnitPrice;break;}}}return A;}function s(L,K){var A=t(K,"PRODUCT_DEFINITION"),E=null,J=0;if(A){var H=A.data,F,B=H.length;for(F=0;F<B;F++){if(H[F].Id==L.value){E=H[F];break;}}}if(E){var z=t(K,"CONTRACT_PARTSDISCOUNT");if(z){var G=z.data,D,C=G.length,y=true;for(D=0;D<C;D++){y=false;var I=G[D];if(I[k("Product__c")]==E.Id){y=true;}else{if(I[k("Product_Family__c")]==E.Family){y=true;}else{if(I[k("Product_Line__c")]==E[k("Product_Family__c")]){y=true;}}}if(y){J=I[k("Discount_Percentage__c")];break;}}}}return J;}function w(B,z,A,O){var I=h("Total_Estimated_Price__c",B);var F=h("Estimated_Price2__c",B);var E=h("Activity_Type__c",B);var H=m(E,z,A,B);var N=h("Covered__c",B);if(H==null){$EXPR.Logger.warn("No labor price found for activity =>"+E.value);return;}var D=H.rateType,P=0,y,J;var L=H.regularRate;if(D=="Per Hour"){var C=h("Start_Date_and_Time__c",B);var M=h("End_Date_and_Time__c",B);var G=H.minimumUnit;if(C==null||C.value==null||C.value==""||M==null||M.value==null||M.value==""){J=O.quantity;}else{C=l(C.value);M=l(M.value);var K=(M-C)/(1000*60*60);if(K>0){J=Math.ceil(K);}else{J=O.quantity;}}y=(G>J)?G:J;P=y*L;}else{P=L;I.value=P;O.quantityField.value=1;F.value=P;}F.value=L;I.value=P;if(!q(N,O.so,"Labor_Discount_Covered__c","Labor_Discount_Not_Covered__c")){x(N,O.warranty,"Time_Covered__c");}}function m(z,C,E,y){var A=null,B=null;A=n(z,C,y);if(A==null){var D=t(C,"RECORDTYPEINFO_LABOR_CONTRACT");if(D){B=j(E,D);if(B){A=d(B,C,z,y);}}}if(A==null){A=r(z,C,E,y);}return A;}function r(z,C,E,y){var D=t(C,"RECORDTYPEINFO_LABOR"),A=null,B=null;if(D){B=j(E,D);}if(B){A=d(B,C,z,y);}return A;}function n(G,F,B){var y=t(F,"CONTRACT_SPECIALLABORPRICING");if(y){var E=y.data,z=E.length,A,C=null;for(A=0;A<z;A++){var D=E[A];if(D[k("Activity_Type__c")]==G.value){C=e(D,B);if(C){break;}}}}if(C){$EXPR.Logger.info("A special price is available for LABOR => "+G.value);}return C;}function d(C,F,H,A){var B=t(F,"LABORPRICING"),D=null;if(B){var G=B.data,y=G.length,z;for(z=0;z<y;z++){var E=G[z];if(C==E[k("Price_Book__c")]&&E[k("Activity_Type__c")]==H.value){D=e(E,A);if(D){break;}}}}return D;}function e(z,y){var C=!!z[k("Activity_Product__c")],A=null;if(C){var B=h("Product__c",y);if(B&&B.value&&(z[k("Product__c")]==B.value)){A={rateType:z[k("Unit__c")],regularRate:z[k("Regular_Rate__c")],minimumUnit:z[k("Minimum_Labor__c")]};}}else{A={rateType:z[k("Unit__c")],regularRate:z[k("Regular_Rate__c")],minimumUnit:z[k("Minimum_Labor__c")]};}return A;}function o(F,I,B){var E=h("Expense_Type__c",F);if(E!=""&&E.value!=null&&E.value!=""){var M=t(I,"CONTRACT_EXPENSE"),C=null;if(M){var K=M.data,A=K.length,D;for(D=0;D<A;D++){if(K[D][k("Expense_Type__c")]==E.value){C=K[D];break;}}if(C!=null){var J=h("Total_Estimated_Price__c",F);var z=h("Estimated_Price2__c",F);var G=h("Discount__c",F);var z=h("Estimated_Price2__c",F);var H=C[k("Rate__c")];var y=C[k("Unit__c")];if(y=="Per Unit"){z.value=H;J.value=B.quantity*H;}else{if(y=="Flat Rate"){J.value=H;B.quantityField.value=1;z.value=H;}else{if(y=="Actuals"){}else{if(y=="Discount"){}else{}}}}var L=h("Covered__c",F);if(!q(L,B.so,"Expense_Discount_Covered__c","Expense_Discount_Not_Covered__c")){x(L,B.warranty,"Expenses_Covered__c");}}}}}function x(z,y,A){if(y){z.value=y[k(A)];}else{$EXPR.Logger.info("No Warranty found.");}}function q(B,D,z,E){var A=false,C=null,y=null;if(D){if(D.isCovered){y=z;}else{y=E;}C=D[k(y)];if(C==null){C=0;}B.value=C;A=true;}else{$EXPR.Logger.info("No Service Offering found.");}return A;}function j(E,D){var C=D.valueMap,y=C.length,B,A=null;for(B=0;B<y;B++){var z=C[B];if(z.key==E.value){A=z.value;break;}}return A;}function t(C,B){var A,y=C.length,z=null;for(A=0;A<y;A++){if(C[A].key==B){z=C[A];break;}}return z;}function v(z){var A=t(z,"WARRANTYDEFINITION"),y=null;if(A){y=A.data[0];}return y;}function u(z){var A=t(z,"CONTRACT_SERVICEOFFERING"),y=null;
if(A){y=A.data[0];y.isCovered=A.value=="COVERED"?true:false;}return y;}function h(C,y){if(C.indexOf("__c",C.length-"__c".length)!==-1){C=$EXPR.getOrgNamespace()+"__"+C;}var D=y.length,z,A="";for(z=0;z<D;z++){var B=y[z];if(B.key==C){A=B;break;}}return A;}function k(y){return $EXPR.getOrgNamespace()+"__"+y;}function l(y){var A=y.split(" ");var z=A[0].split("-");var B=A[1].split(":");return new Date(parseInt(z[0]),parseInt(z[1]),parseInt(z[2]),parseInt(B[0]),parseInt(B[1]),parseInt(B[2]));}function b(A,y){var M,L=A.detailRecords,I=L.length;var H=v(y);var O=u(y);for(var M=0;M<I;M++){var N=L[M].records,K,G=N.length;for(K=0;K<G;K++){var B=N[K].targetRecordAsKeyValue,D=B.length,J;var C=h("Use_Price_From_Pricebook__c",B);if(C!=""&&C.value!="true"){continue;}var Q=h("Line_Type__c",B);var z=h("RecordTypeId",B);var E=h("Estimated_Quantity2__c",B);var F=0;try{F=parseInt(E.value);if(isNaN(F)){F=0;}}catch(P){}if(Q.value=="Parts"){p(B,y,z,{quantity:F,warranty:H,so:O});}else{if(Q.value=="Labor"){w(B,y,z,{quantity:F,warranty:H,quantityField:E,so:O});}else{if(Q.value=="Expenses"){o(B,y,{quantity:F,warranty:H,quantityField:E,so:O});}else{if(Q.value=="Travel"){}}}}}}}$EXPR.getPricingDefinition(context,function(y){if(!y){$EXPR.Logger.error("Could not get the price book definition!");$RETURN(context);}else{b(context,y);$RETURN(context);}});})();
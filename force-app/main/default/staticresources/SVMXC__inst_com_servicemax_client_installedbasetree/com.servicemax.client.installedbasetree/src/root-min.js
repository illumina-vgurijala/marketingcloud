(function(){var a=SVMX.Package("com.servicemax.client.installedbasetree.root");a.init=function(){var b=com.servicemax.client.ui.components;Ext.define("com.servicemax.client.installedbasetree.root.RootPanel",{extend:"com.servicemax.client.ui.components.composites.impl.SVMXSection",layout:"border",width:"100%",cls:"svmx-ibtree-root-container",constructor:function(d){d=d||{};d.renderTo=SVMX.getDisplayRootId();d.autoScroll=true;this.callParent([d]);var c=window.innerHeight-this.getPosition()[1];this.setHeight(c);if(!window.$TR){$TR=this.translations();}this.__recordID=d.recordId;this.__objName=d.objName;this.__treeData=d.treeData;this.__loadMoreIndex=-1;this.__lMoreObjects=[];this._recordsLimit=40;this._doneInitialLoad=false;this.processInitData(d);},processInitData:function(g){var d=false;var k=[];var f=this.getHeight();var e=this.getWidth();if(this.__treeData.hasOwnProperty("status")&&this.__treeData.status==false){d=true;var h=this.__treeData.message;var j={xtype:"svmx.label",text:h,cls:"svmx-ibtree-invalid",width:"100%",height:50,margin:"20 0 20 0",};k.push(j);}else{var i=this.addHeader();k.push(i);this.processMetaData(g.metaData);var l={xtype:"svmx.section",collapsible:false,width:e-10,height:f-115,layout:"auto",itemId:"contentPanel",cls:"svmx-ibtree-grid-container",};k.push(l);}var c={xtype:"svmx.section",collapsible:false,width:"100%",layout:"auto",items:k,};this.add(c);if(!d){this.blockUI();this.updateColumns();this.addLoading(e);}},addLoading:function(d){var c={xtype:"svmx.section",collapsible:false,width:d-10,layout:"vbox",itemId:"loadingPanel",cls:"svmx-tree-loadingview",hidden:true,items:[{xtype:"svmx.label",text:$TR.LOADING+"...",width:"100%",height:30,margin:"10 0 20 0",}]};this.add(c);},processMetaData:function(c){this.__configuredFields=c.defaultFieldObject;this.__allFields=c.sforceObjectDescribes[this.__objName].fields;},addHeader:function(){var g=this;var d=this.__treeData.ibAccount;var e="<a";if(d.accountId){e+=" href='/"+d.accountId+"'";}if(d.accountName){e+=">"+Ext.String.htmlEncode(d.accountName)+"</a>";}else{e+="></a>";}var c="";if(d.ibName){c=d.ibName;}var f=this.getWidth();var h={xtype:"svmx.toolbar",itemId:"topBar",cls:"svmx-ibtree-top-toolbar",width:f-10,items:[{xtype:"svmx.section",layout:"vbox",collapsible:false,width:"75%",items:[{xtype:"svmx.label",html:e,itemId:"accountName",width:"100%",},{xtype:"svmx.label",text:c,itemId:"ibName",width:"100%",},]},"->",{text:$TR.CC,disabled:false,itemId:"configureColumns",cls:"svmx-ibtree-btn",handler:function(){g.configureColumns();}},]};return h;},configureColumns:function(){SVMX.create("com.servicemax.client.installedbasetree.configureColumns.CongigureColumn",{allFields:this.__allFields,selectedFields:this.__configuredFields,parent:this});},getTreeData:function(){var c=SVMX.create("com.servicemax.client.lib.api.Event","IBTREE.GET_TREE_DATA",this,{request:{context:this,recordId:this.__recordID,objName:this.__objName,reload:true,}});SVMX.getCurrentApplication().getEventBus().triggerEvent(c);},onGetTreeDataComplete:function(c){this.__treeData=c;this.updateColumns();},updateColumns:function(){var f=this;var h=this.query("#IBTree")[0];if(h){h.destroy();}this.__tree=null;var g=this.query("#contentPanel")[0];this.__selectedPath=[];this.__lMoreObjects=[];this._nodeHighlighted=false;this.__tree=this.addTree();g.add(this.__tree);var d=this.__tree.store.getRootNode();d.raw.loadChildren=true;var e=this.__selectedPath.length;if(e>1){this.__levelLength=e-1;}else{this.__levelLength=0;}this.__tree.disable();this.getChildren(d);this._lastScrollValue=0;this.__rowHeight=0;this._scrollDiff=0;var c=this.__tree.view;var i=c.getHeight();this.__clearLimit=i;this.__tree.view.getEl().on("scroll",function(l,k){var j=false;if(f._lastScrollValue>k.scrollTop){j=true;f._scrollDiff+=f._lastScrollValue-k.scrollTop;}else{j=false;f._scrollDiff+=k.scrollTop-f._lastScrollValue;}f.updateScrolling(k,j);f._lastScrollValue=k.scrollTop;});},updateScrolling:function(d,c){var e=d.scrollTop;if(this.__rowHeight>0&&this._scrollDiff>2*this.__rowHeight){this._scrollDiff=2*this.__rowHeight;if(c){e=this._lastScrollValue-this._scrollDiff;this.__tree.scrollByDeltaY(-this._scrollDiff);}else{e=this._lastScrollValue+this._scrollDiff;this.__tree.scrollByDeltaY(this._scrollDiff);}}this.findFirstLoadMore(e);this.checkForClearing(d,c);},findFirstLoadMore:function(d){var f=this.__tree.view;var g=f.getHeight();var c=this.__lMoreObjects;var m=-1;var e;for(var l=0;l<c.length;l++){var n=c[l];var k=f.getNode(n);if(k){var j=Ext.fly(k);var h=k.offsetTop;if((g+d)>=h&&j.isVisible()){this.__tree.disable();if(m==-1){m=h;e=n;this.__loadMoreIndex=l;}else{if(h<m){m=h;e=n;this.__loadMoreIndex=l;}}}}}if(e){this.setLoadMoreBottom(e,d);if(!this._loadMoreCalled){this._loadMoreCalled=true;this.loadMoreClicked(e.parentNode);}}},setLoadMoreBottom:function(i,h){var d=this.__tree.view;var j=d.getHeight();var e=d.getNode(i);if(e){var f=e.offsetTop;var g=j+h;var c=f-g;this.__tree.scrollByDeltaY(c);}},checkForClearing:function(f,e){if(this.__rowHeight==0){this.getRowHeight();
}if(this.__rowHeight>0){if(this.__borderNode){this.handleClearing(f,e);}else{var d=this.__tree.view;var h=d.getHeight();var c=h*3;if(f.scrollTop>c){var g=d.all.elements;this.__borderNode=g[0];this.handleClearing(f,e);}}}},getRowHeight:function(){var c=this.__tree.view;var d=c.getNode(0);if(d){this.__rowHeight=Ext.get(d).getHeight();}},handleClearing:function(k,g){var v=this;var j=this.__tree.view;var p=j.getHeight();var e=j.all.elements;var h=Math.floor(this._scrollDiff/this.__rowHeight);this._scrollDiff=this._scrollDiff%this.__rowHeight;if(h==0){return;}var n=Math.floor(p/this.__rowHeight);var f=5*n;var d=e.indexOf(this.__borderNode);if(g){var r=0;if(d>0){var l=d+2*n+1;if(l<e.length){var w=e[l];if(w){var m=w.offsetTop;var s=m-k.scrollTop;this.__tree.scrollByDeltaY(s);}}for(var o=d;o>=d-h;o--){var c=e[o];var u=Ext.fly(c);if(u){u.setDisplayed(true);}}this.__borderNode=e[d-h];if(k.scrollTop==0){r=d;for(var o=d;o>=0;o--){var c=e[o];var u=Ext.fly(c);if(u){u.setDisplayed(true);}}this.__borderNode=e[0];}}var q=f+d;if(q<e.length){for(var o=q+h;o>=q-r;o--){if(o==e.length){break;}var c=e[o];var u=Ext.fly(c);if(u){u.setDisplayed(false);}}}}else{if(k.scrollTop>2*p){var d=e.indexOf(this.__borderNode);if(d>0){var l=d+2*n+2;if(l<e.length){var w=e[l];var u=Ext.fly(w);if(w&&u.isVisible()){var m=w.offsetTop;var s=m-k.scrollTop;this.__tree.scrollByDeltaY(s);}}}var q=f+d;for(var o=q;o<q+h;o++){if(o==e.length){break;}var c=e[o];var u=Ext.fly(c);if(u){u.setDisplayed(true);}}for(var o=d;o<d+h;o++){var c=e[o];var u=Ext.fly(c);if(u){u.setDisplayed(false);}}this.__borderNode=e[d+h];}}},expandTree:function(){var e=this;var c=this.__levelLength;var f=this.__selectedPath[c];var d=this.__tree.getStore().getNodeById(f);if(d){d.raw.loadChildren=true;d.expand();c=c-1;this.__levelLength=c;if(this.__levelLength==0){this._moveToNode=true;}}else{this.unblockUI();}},addTree:function(){var k=this;var f=[];var n=[];f.push("Name");var h=this.__objName;var j;if(h==SVMX.getCustomFieldName("Site")){j="Location";}else{j="Installed Product";}n.push({xtype:"treecolumn",text:j,dataIndex:"Name",width:400,hideable:false,draggable:false,renderer:function(i){return Ext.String.htmlEncode(i);}});var d=this.__configuredFields;for(var g=0;g<d.length;g++){var l=d[g];var m=l.fieldName;var c=Ext.String.htmlEncode(l.fieldLabel);f.push(m);n.push({text:c,dataIndex:m,width:130,hideable:false,draggable:false,renderer:function(s,p,i,u,r,q,t){if(s==""||!s||k.__objName!=i.raw.objectName){return"-";}return Ext.String.htmlEncode(s);}});}var e=this.getTreeStore();this._colWidth=0;var o=Ext.create("Ext.tree.Panel",{fields:f,columns:n,root:e,rootVisible:false,itemId:"IBTree",sortableColumns:false,cls:"svmx-ibtree-grid",viewConfig:{listeners:{refresh:function(i){Ext.each(i.panel.columns,function(u){var q=u.getEl();var t=Ext.getDom(q);if(t.scrollWidth>u.width){u.width=t.scrollWidth+15;}var s=u.getIndex();if(s==0){k._colWidth=0;}k._colWidth+=u.width;var p=i.panel.columns.length;if(s==p-1){var v=i.getWidth();if(k._colWidth<v){var r=v-k._colWidth;u.width+=r;}}});}}},listeners:{afteritemexpand:function(q,i,p){k.getChildren(q);},afteritemcollapse:function(q,i,p){k.updateChildrenVisiblity(q,false);},itemexpand:function(){k.highlightNode();},itemcollapse:function(){k.highlightNode();},cellclick:function(p,t,q,i,r,s){if(i.raw.id!==k.__recordID){k.__tree.selModel.deselect(i);k.highlightNode();}},}});return o;},highlightNode:function(){var f=this.__tree.getStore().getNodeById(this.__recordID);if(f){var d=this.__tree.getSelectionModel();if(this._moveToNode){d.select(f);this._moveToNode=false;}else{var e=this.__tree.getView();var g=e.getNode(f);if(g){var c=Ext.get(g);if(c){d.selected.clear();c.addCls("svmx-grid-row-selected");this._nodeHighlighted=true;}}}}},loadMoreClicked:function(f){if(f){var e=this;this.removeLoadingNode(f);if(this.__loadMoreIndex>-1){this.__lMoreObjects.splice(this.__loadMoreIndex,1);this.__loadMoreIndex=-1;}f.appendChild(this.getLoadingNodeObject());this.__lMoreObjects.push(f.lastChild);f.raw.loadChildren=true;setTimeout(function(){e.getChildren(f);},100);var d=this.query("#loadingPanel")[0];if(d){d.setVisible(true);var h=this.__tree.getPosition();var c=this.getPosition();var g=h[1]-c[1];var i=this.__tree.getHeight();d.setPosition(d.x,g+i-25);}}},updateChildrenVisiblity:function(e,p){if(this.__rowHeight==0){this.getRowHeight();}if(this.__rowHeight>0){var f=this.__tree.view;var g=f.getHeight();var o=f.all.elements;var j=Math.floor(g/this.__rowHeight);var q=f.getNode(e);var n=o.indexOf(q);var c=0;var h=0;var d=true;if(p){c=n+5*j;d=false;h=o.length;}else{c=n;d=true;h=n+5*j;}if(c>-1&&c<o.length){for(var m=c;m<h;m++){if(m==o.length){break;}var l=o[m];var k=Ext.fly(l);if(k){k.setDisplayed(d);}}}}},getChildren:function(d){if(!d.raw.loadChildren){this.highlightNode();this.updateChildrenVisiblity(d,true);return;}var g=d.raw.objectName;var c=this.__treeData.ibAccount;var j=d.raw.topLevelId;var i=0;if(d.raw.index){i=d.raw.index;}else{d.raw.index=0;}i*=this._recordsLimit;var h=d.childNodes.length;
var k=false;var e=0;if(d.raw.posAssigned){k=true;e=h-d.raw.ibIndex-1;}var f={objType:d.raw.objectName,sfdcId:d.raw.Id,accountId:c.accountId,index:i,recordsLimit:this._recordsLimit,topLevelIb:j,treeType:this.__objName,isIB:k,ibIndex:e};this.callForChildren(d,f);},callForChildren:function(e,d){var c=SVMX.create("com.servicemax.client.lib.api.Event","IBTREE.GET_LOAD_MORE_DATA",this,{request:{context:this,requestData:d,parentNode:e}});SVMX.getCurrentApplication().getEventBus().triggerEvent(c);},onGetLoadMoreDataComplete:function(d){var e=d.result;var c=d.parentNode;if(e.success==false||e.status==false){if(c.raw.index*this._recordsLimit>2000){Ext.Msg.alert($TR.ERROR,$TR.MAX_LIMIT);if(this.__loadMoreIndex>-1){this.__lMoreObjects.splice(this.__loadMoreIndex,1);this.__loadMoreIndex=-1;}this.removeLoadingNode(c);}this.enableTree();return;}this.loadTreeStore(e);this.loadChildren(c);},loadChildren:function(f){f.raw.loadChildren=false;this.removeLoadingNode(f);var e=this;var g=f.raw.index;if(!f.raw.childLength){f.raw.childLength=0;}var c=this.getChildNodes(f);if(c.length){var d=f.childNodes[f.childNodes.length-1];f.appendChild(c);f.raw.childLength+=c.length;}if(f.raw.childLength<parseInt(f.raw.childrenCount)){f.appendChild(this.getLoadMoreNode());this.__lMoreObjects.push(f.lastChild);f.raw.index=g+1;}if(this.__levelLength>0){setTimeout(function(){e.expandTree();},500);}else{this.unblockUI();this._doneInitialLoad=true;if(!this._nodeHighlighted||f.raw.id===this.__recordID){this.highlightNode();}}if(this.__loadMoreIndex>-1){this.__lMoreObjects.splice(this.__loadMoreIndex,1);this.__loadMoreIndex=-1;}this.enableTree();},enableTree:function(){if(this.__tree.disabled&&this._doneInitialLoad){this.__tree.enable();}this._loadMoreCalled=false;var c=this.query("#loadingPanel")[0];if(c){c.setVisible(false);}},removeLoadingNode:function(d){var c=d.childNodes;d.removeChild(c[c.length-1]);},getLoadMoreNode:function(){var d="Load More...";var c={Name:d,iconCls:"svmx-tree-load-more",href:"#",leaf:true,loadMore:true};return c;},getTreeStore:function(){var d=this.__treeData.ibTree;this.mapInstalledBase={};this.mapParrentChild={};this.mapInstalledBase.root=this.getRootElement();this.loadTreeStore(d);this.findPath();var c=this.getNode("root");return c;},getRootElement:function(){var d=this.__treeData.ibAccount;var c={};c.Id="root";c.Name="root";c.childrenCount=d.childrenCount;return c;},findPath:function(){var c=this.mapInstalledBase[this.__recordID];this.__selectedPath=["root"];while(c&&c.parentNodeId&&c.parentNodeId!="root"){this.__selectedPath.push(c.parentNodeId);c=this.mapInstalledBase[c.parentNodeId];}},loadTreeStore:function(e){for(var c=0;c<e.length;c++){var d=e[c];if(!this.mapParrentChild.root){this.mapParrentChild.root=[];}if(!d.parentNodeId){d.parentNodeId="root";}if(!this.mapParrentChild[d.parentNodeId]){this.mapParrentChild[d.parentNodeId]=[];}if(this.mapParrentChild[d.parentNodeId].indexOf(d.Id)==-1){this.mapParrentChild[d.parentNodeId].push(d.Id);}this.mapInstalledBase[d.Id]=d;}},getChildNodes:function(h){var k=h.raw.Id;var l=h.raw.objectName;var f=this.mapParrentChild[k];var d=[];if(f){var g=h.raw.childLength;for(var e=g;e<f.length;e++){var c=f[e];var j=this.getNode(c);if((l=="root"||l==SVMX.getCustomFieldName("Site"))&&!h.raw.posAssigned&&this.__selectedPath.indexOf(j.id)<0&&j.id!=this.__recordID){if(j.objectName==SVMX.getCustomFieldName("Installed_Product")){h.raw.ibIndex=g+e;h.raw.posAssigned=true;}}d.push(j);}}return d;},getNode:function(d){var c=this.mapInstalledBase[d];c.children=[];c.expanded=false;c.href="/"+c.Id;c.id=c.Id;var e=c.objectName;if(e==SVMX.getCustomFieldName("Installed_Product")){c.iconCls="svmx-tree-ib-icon";}else{c.iconCls="svmx-tree-loc-icon";}if(d!=="root"){if(parseInt(c.childrenCount)){c.children.push(this.getLoadingNodeObject());c.loadChildren=true;}else{c.leaf=true;}}return c;},getLoadingNodeObject:function(){var d="Please wait";var c={Name:d,iconCls:"svmx-piq-loading-node",leaf:true};return c;},blockUI:function(){if(this.__spinner){this.__spinner.spin($("#"+SVMX.getDisplayRootId())[0]);}else{var c={lines:25,length:25,width:5,radius:30,corners:1,rotate:0,direction:1,color:"#ffa384",speed:3,trail:60,shadow:false,hwaccel:false,className:"spinner",zIndex:2000000000};this.__spinner=new Spinner(c).spin($("#"+SVMX.getDisplayRootId())[0]);}},unblockUI:function(){if(this.__spinner){this.__spinner.stop();}},translations:function(){return{AF:"Available Fields",APPLY:"Apply",CANCEL:"Cancel",CC:"Choose Columns",PARAMS_ERROR:"Insufficient number of parameters provided to IB Tree View. Please contact your ServiceMax administrator to resolve this.",SF:"Selected Fields",SF_ERROR:"Select at least one field",LOADING:"Loading",MAX_LIMIT:"Maximum Limit of Expanded node is reached.",ERROR:"Error"};},});};})();
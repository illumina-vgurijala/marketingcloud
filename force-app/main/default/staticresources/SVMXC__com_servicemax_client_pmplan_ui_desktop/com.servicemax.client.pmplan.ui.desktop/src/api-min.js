(function(){var a=SVMX.Package("com.servicemax.client.pmplan.ui.desktop.api");a.init=function(){var b=SVMX.getClient().getServiceRegistry().getServiceInstance("com.servicemax.client.translation").getDictionary("PMPLAN");Ext.define("com.servicemax.client.pmplan.ui.desktop.api.RootContainer",{extend:"com.servicemax.client.ui.components.composites.impl.SVMXSection",cls:"pmplan-root-container",width:"100%",id:"pmplan",constructor:function(c){c=Ext.apply({title:b.T("TAG001","Preventive Maintenance Plan"),titleAlign:"center",collapsible:false,header:{items:[{xtype:"svmx.button",itemId:"BackButton",padding:"0",text:SVMX.getUrlParameter("mode").toLowerCase()=="sc"?b.T("TAG002","Back to Service Contract"):(SVMX.getUrlParameter("mode").toLowerCase()=="account"?b.T("TAG068","Back to Account"):(SVMX.getUrlParameter("mode").toLowerCase()=="location"?b.T("TAG069","Back to Location"):b.T("TAG070","Back to Installed Product"))),hidden:SVMX.getUrlParameter("pmPlanId")!=null?true:false,handler:function(i,g,d,f){var h="";if(SVMX.getUrlParameter("sourceId")!=null){h="/"+SVMX.getUrlParameter("sourceId");}else{h="/"+SVMX.getUrlParameter("pmPlanId");}if((typeof sforce!="undefined")&&(sforce!=null)){sforce.one.navigateToURL(h);}else{window.location=h;}}}]},},c||{});this.callParent(arguments);},initComponent:function(){this.callParent(arguments);var I=this;var n=I.__engine.__pmplanData.pmPlanRecord;I.conditionrulePanel=SVMX.create("com.servicemax.client.pmplan.ui.desktop.api.ConditionrulePanel",{__parent:I,__engine:I.__engine,border:false,collapsible:false,hidden:true,});var q=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXText",{id:"planName",name:"planName",labelAlign:"top",fieldLabel:b.T("TAG003","Plan Name"),value:n.pmPlanName,labelSeparator:"",allowBlank:false,msgTarget:"under",style:"top: 10px;",});I.planTemplateStore=SVMX.create("Ext.data.Store",{fields:[{name:"Id"},{name:"name"}],proxy:{type:"memory"},data:I.__engine.getPMTemplatelist()});var t=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXPicklist",{id:"planTemplateName",name:"planTemplateName",labelAlign:"top",fieldLabel:b.T("TAG004","Plan Template"),labelField:"label",valueField:"Id",displayField:"name",queryMode:"local",store:I.planTemplateStore,labelSeparator:"",margins:"0 0 0 6",editable:false,listConfig:{getInnerTpl:function(K){return"{[Ext.String.htmlEncode(values."+K+")]}";}},listeners:{beforeselect:function(O,K,M){var L=this.getValue();var N=K.getData().Id;if(I.covergaeStore.data.length==0){if(N!="NONE"){I.createPMTemplateReq(N);}else{I.createPMTemplateReq(null);Ext.getCmp("conditionTypeCombo").setReadOnly(false);}}else{if(N!=="NONE"&&I.covergaeStore.data.length!=0){if(!(I.__engine.__mode.toLowerCase()=="ib")){Ext.MessageBox.confirm("Confirm",b.T("TAG027","This operation will remove all coverages and schedules. Do you want to continue?"),function(P){if(P=="yes"){if(K!=null){I.createPMTemplateReq(N);}I.covergaeStore.removeAll();}else{O.setValue(L);Ext.getCmp("conditionTypeCombo").setReadOnly(true);}});}else{I.createPMTemplateReq(N);}}else{if(N==="NONE"&&I.covergaeStore.data.length!=0){Ext.getCmp("conditionTypeCombo").setReadOnly(false);if(!(I.__engine.__mode.toLowerCase()=="ib")){Ext.MessageBox.confirm("Confirm",b.T("TAG027","This operation will remove all coverages and schedules. Do you want to continue?"),function(P){if(P=="yes"){I.covergaeStore.removeAll();I.__engine.__pmplanData.pmPlanRecord.pmTemplateDetail={};}else{O.setValue(L);Ext.getCmp("conditionTypeCombo").setReadOnly(true);}});}else{I.createPMTemplateReq(null);}}}}},afterrender:function(K){if(n.pmPlanTemplateId!=null){K.setValue(n.pmPlanTemplateId);}else{K.setValue("NONE");}}},style:"top: 10px;",});var u=SVMX.create("com.servicemax.client.ui.components.composites.impl.SVMXSection",{layout:"column",defaults:{columnWidth:0.5},collapsible:false,border:false,header:false,hidden:(I.__engine.__mode).toLowerCase()=="account"||(I.__engine.__mode).toLowerCase()=="location",cls:"img-header-default",});I.serviceContractStore=SVMX.create("Ext.data.Store",{fields:[{name:"Id"},{name:"name"}],proxy:{type:"memory"},data:I.__engine.getServiceContract()});var m=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXPicklist",{id:"serviceContractName",name:"serviceContractName",labelAlign:"top",fieldLabel:b.T("TAG005","Service/Maintenance Contract"),labelField:"label",valueField:"Id",displayField:"name",value:n.serviceContractId,labelSeparator:"",columnWidth:0.95,queryMode:"local",store:I.serviceContractStore,listConfig:{getInnerTpl:function(K){return"{[Ext.String.htmlEncode(values."+K+")]}";}},listeners:{select:function(M,K,L){if(Ext.getCmp("planTemplateName").getValue()!="NONE"){I.createPMTemplateReq(Ext.getCmp("planTemplateName").getValue());}}}});u.add(m);u.add({iconCls:"svmx-filter-icon",cursor:"pointer",scale:"medium",border:false,columnWidth:0.05,style:"top: 20px",cls:"img-header-default",listeners:{el:{click:function(){var K=Ext.getCmp("serviceContractName");var M={};
M.objAPIName=SVMX.OrgNamespace+"__Service_Contract__c";M.searchtext=K.getRawValue();if(M.searchtext.length<3){SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(b.T("TAG025","You must enter more than 3 characters to perform search"),7000,"success");}else{var L=Ext.getCmp("pmplan");L.__engine.searchObject(M,function(N){if(N.success){if(N.searchResponse.length>0){I.loadData(N);}else{SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(b.T("TAG024","No matches found. Refine your search. "),7000,"success");}}else{SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(N.messageList[0],7000,"success");}});}}}},});var f=SVMX.create("Ext.data.Store",{fields:[{name:"key"},{name:"value"}],proxy:{type:"memory"},data:I.__engine.getCoverageType()});var v=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXPicklist",{id:"coverageTypeName",name:"coverageTypeName",labelAlign:"top",fieldLabel:b.T("TAG006","Coverage Type"),labelField:"label",valueField:"value",displayField:"key",defaultValue:1,readOnly:true,value:"Product (Must Have IB)",labelSeparator:"",queryMode:"local",store:f,style:"top: 10px;",});var z=SVMX.create("Ext.data.Store",{fields:[{name:"key"},{name:"value"}],proxy:{type:"memory"},data:I.__engine.getScheduleType()});var l=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXPicklist",{id:"scheduleTypeName",name:"coverageTypeName",labelAlign:"top",fieldLabel:b.T("TAG007","Schedule Type"),labelField:"label",valueField:"value",displayField:"key",defaultValue:1,readOnly:true,value:"Condition Based",labelSeparator:"",queryMode:"local",store:z,style:"top: 10px;",});var k=SVMX.create("com.servicemax.client.ui.components.composites.impl.SVMXSection",{layout:"column",defaults:{columnWidth:0.5},collapsible:false,border:false,hidden:(I.__engine.__mode).toLowerCase()=="location",header:false});I.accountStore=SVMX.create("Ext.data.Store",{fields:[{name:"Id"},{name:"name"}],proxy:{type:"memory"},data:I.__engine.getAccount()});var h=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXPicklist",{id:"accountName",name:"accountName",labelAlign:"top",fieldLabel:b.T("TAG008","Account"),labelField:"label",valueField:"Id",displayField:"name",value:n.accountId,labelSeparator:"",queryMode:"local",store:I.accountStore,listConfig:{getInnerTpl:function(K){return"{[Ext.String.htmlEncode(values."+K+")]}";}},columnWidth:0.95,});k.add(h);k.add({iconCls:"svmx-filter-icon",cursor:"pointer",scale:"large",border:false,style:"top: 20px",columnWidth:0.05,cls:"img-header-default",listeners:{el:{click:function(){var L=Ext.getCmp("accountName");var M={};M.objAPIName="Account";M.searchtext=L.getRawValue();if(M.searchtext.length<3){SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(b.T("TAG025","You must enter more than 3 characters to perform search"),7000,"success");}else{var K=Ext.getCmp("pmplan");K.__engine.searchObject(M,function(N){if(N.success){if(N.searchResponse.length>0){I.loadData(N);}else{SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(b.T("TAG024","No matches found. Refine your search. "),7000,"success");}}else{SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(N.messageList[0],7000,"success");}});}}}},});I.slaTermsStore=SVMX.create("Ext.data.Store",{fields:[{name:"Id"},{name:"name"}],proxy:{type:"memory"},data:I.__engine.getSLAlist()});var o=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXPicklist",{id:"slaTermsName",name:"slaTermsName",labelAlign:"top",fieldLabel:b.T("TAG009","SLA Terms"),labelField:"label",valueField:"Id",displayField:"name",value:n.slaId,labelSeparator:"",queryMode:"local",store:I.slaTermsStore,listConfig:{getInnerTpl:function(K){return"{[Ext.String.htmlEncode(values."+K+")]}";}},hidden:(I.__engine.__mode).toLowerCase()=="account"||(I.__engine.__mode).toLowerCase()=="location",style:"margin-top: 10px;",});var g=SVMX.create("com.servicemax.client.ui.components.composites.impl.SVMXSection",{layout:"column",defaults:{columnWidth:0.5},collapsible:false,border:false,hidden:!((I.__engine.__mode).toLowerCase()=="location"),header:false});I.locationStore=SVMX.create("Ext.data.Store",{fields:[{name:"Id"},{name:"name"}],proxy:{type:"memory"},data:I.__engine.getLocationlist()});var c=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXPicklist",{id:"locationName",name:"locationName",labelAlign:"top",fieldLabel:b.T("TAG029","Location"),labelField:"label",valueField:"Id",displayField:"name",value:n.locationId,labelSeparator:"",columnWidth:0.95,queryMode:"local",store:I.locationStore,listConfig:{getInnerTpl:function(K){return"{[Ext.String.htmlEncode(values."+K+")]}";}},hidden:!((I.__engine.__mode).toLowerCase()=="location"),style:"margin-top: 10px;",});g.add(c);g.add({iconCls:"svmx-filter-icon",cursor:"pointer",scale:"large",border:false,style:"top: 20px",columnWidth:0.05,cls:"img-header-default",listeners:{el:{click:function(){var K=Ext.getCmp("locationName");
var M={};M.objAPIName=SVMX.OrgNamespace+"__Site__c";M.searchtext=K.getRawValue();if(M.searchtext.length<3){SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(b.T("TAG025","You must enter more than 3 characters to perform search"),7000,"success");}else{var L=Ext.getCmp("pmplan");L.__engine.searchObject(M,function(N){if(N.success){if(N.searchResponse.length>0){I.loadData(N);}else{SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(b.T("TAG024","No matches found. Refine your search. "),7000,"success");}}else{SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(N.messageList[0],7000,"success");}});}}}},});var i=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXDate",{fieldLabel:b.T("TAG010","Start Date"),labelAlign:"top",id:"startDate",allowBlank:false,msgTarget:"under",value:n.startDate,style:"top: 10px;",labelSeparator:"",invalidText:b.T("TAG079","Enter valid date"),listeners:{select:function(){if(this.getValue()!=""){y.enable();}if(y.getValue()!=null){if(this.getValue()>y.getValue()){alert("Error! End Date Must Be Later Than The Start Date.");this.setValue(y.getValue());}}y.setMinValue(i.getValue());},change:function(){I.startEndDateScheduleGeneration();},render:function(){if(this.getValue()!=""){y.enable();y.setMinValue(i.getValue());}}}});var y=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXDate",{fieldLabel:b.T("TAG011","End Date"),labelAlign:"top",allowBlank:false,id:"endDate",disabled:n.endDate!=null?false:true,labelSeparator:"",msgTarget:"under",style:"top: 10px;",value:n.endDate,invalidText:b.T("TAG079","Enter valid date"),listeners:{change:function(){I.startEndDateScheduleGeneration();}}});I.activityDateStore=SVMX.create("Ext.data.Store",{fields:[{name:"key"},{name:"value"}],proxy:{type:"memory"},data:I.__engine.getActivityDateList()});var H=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXPicklist",{id:"activityDate",name:"activityDate",labelAlign:"top",fieldLabel:b.T("TAG012","Activity Date"),labelField:"key",valueField:"key",displayField:"value",defaultValue:1,value:n.selectedActivityDate,queryMode:"local",store:I.activityDateStore,listConfig:{getInnerTpl:function(K){return"{[Ext.String.htmlEncode(values."+K+")]}";}},labelSeparator:"",style:"margin-top: 10px;",});var F=Ext.create("Ext.data.Store",{storeId:"Condition_Type_Store",fields:["name","label"],data:[{name:"Usage_Frequency",label:b.T("TAG077","Usage/Frequency Based")},{name:"Criteria_Comparison",label:b.T("TAG078","Criteria/Comparison Based")}]});var w=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXPicklist",{fieldLabel:b.T("TAG074","Condition Type"),labelSeparator:"",name:"conditionType",id:"conditionTypeCombo",store:F,queryMode:"local",displayField:"label",valueField:"name",labelAlign:"top",editable:false,listConfig:{getInnerTpl:function(K){return"{[Ext.String.htmlEncode(values."+K+")]}";}},value:n.conditionType!=null?n.conditionType:"Usage_Frequency",readOnly:(n.pmPlanId!=null&&n.coverageList!=null&&n.coverageList.length>0)?true:false});I.WOPurposeStore=SVMX.create("Ext.data.Store",{fields:[{name:"Id"},{name:"name"}],proxy:{type:"memory"},data:I.__engine.getWOPurposelist()});var E=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXPicklist",{id:"WOPurpose",name:"WOPurpose",labelAlign:"top",fieldLabel:b.T("TAG013","Work Order Purpose"),labelField:"label",valueField:"Id",displayField:"name",defaultValue:1,value:n.woPurposeId,queryMode:"local",store:I.WOPurposeStore,listConfig:{getInnerTpl:function(K){return"{[Ext.String.htmlEncode(values."+K+")]}";}},labelSeparator:"",style:"top: 10px;",});var x=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXTextArea",{grow:true,columnWidth:0.98,labelAlign:"top",id:"description",fieldLabel:b.T("TAG014","Description"),width:"100%",height:86,resizable:false,bodyPadding:4,labelSeparator:"",value:n.description,style:"margin-left: 10px;",});var G={xtype:"fieldset",columnWidth:0.5,border:false,defaults:{anchor:"100%"},layout:"anchor",style:"top: 10px;",items:[q,l,u,k,g,i,H]};var A={xtype:"fieldset",columnWidth:0.5,border:false,defaults:{anchor:"100%"},layout:"anchor",style:"top: 10px;",items:[t,v,w,o,E,y]};var j=SVMX.create("com.servicemax.client.ui.components.composites.impl.SVMXSection",{collapsible:false,region:"center",width:"99%",layout:"column",border:false,id:"pmPlanData",style:"margin-left: 8px;",defaults:{bodyPadding:8,},items:[G,A,x]});I.add(j);var C=SVMX.create("com.servicemax.client.ui.components.composites.impl.SVMXSection",{layout:"column",margin:"0 20 10 20",defaults:{columnWidth:0.5},collapsible:false,border:false,header:false,hidden:true,id:"coveredIBSec",cls:"img-header-default",});this.coveredIBStore=SVMX.create("Ext.data.Store",{fields:[{name:"Id"},{name:"name"}],proxy:{type:"memory"},data:[]});var r=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXPicklist",{id:"coveredIBName",name:"coveredIBName",labelAlign:"top",labelField:"label",valueField:"Id",displayField:"name",labelSeparator:"",columnWidth:0.8,queryMode:"local",store:this.coveredIBStore,listConfig:{getInnerTpl:function(K){return"{[Ext.String.htmlEncode(values."+K+")]}";
}},listeners:{select:function(P,Q,M,N){var L=I.covergaeStore.getCount();var O=I.__ibSearchList[Q[0].data.Id][SVMX.OrgNamespace+"__Product__c"];var K=true;if(I.__engine.__pmplanData.pmPlanRecord.pmTemplateDetail!=null&&I.__engine.__pmplanData.pmPlanRecord.pmTemplateDetail.product!=null&&I.__engine.__pmplanData.pmPlanRecord.pmTemplateDetail.product!=""){if(I.__engine.__pmplanData.pmPlanRecord.pmTemplateDetail.product==O){K=false;}}var R={installedProductName:Q[0].data.name,installedProductId:Q[0].data.Id,conditionRuleList:[],scheduleList:[],productId:O,isNewAddCov:true,isDifferentProduct:K,};I.covergaeStore.insert(L,R);Ext.getCmp("coveredIBSec").hide();this.clearValue();}}});C.add(r);C.add({iconCls:"svmx-filter-icon",cursor:"pointer",scale:"medium",border:false,columnWidth:0.1,style:"top: -4px",cls:"img-header-default",listeners:{el:{click:function(){var K=Ext.getCmp("coveredIBName");var M={};M.objAPIName=SVMX.OrgNamespace+"__Installed_Product__c";M.searchtext=K.getRawValue();if(M.searchtext.length<3){SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(b.T("TAG025","You must enter more than 3 characters to perform search"),7000,"success");}else{var L=Ext.getCmp("pmplan");L.__engine.searchObject(M,function(N){if(N.success){if(N.searchResponse.length>0){I.loadData(N);I.__ibSearchList=N.mapSearchRecord;}else{SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(b.T("TAG024","No matches found. Refine your search. "),7000,"success");}}else{SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(N.messageList[0],7000,"success");}});}}}},});C.add({iconCls:"pmplan-delete-row-icon",cls:"pmplan-add-coverage",cursor:"pointer",border:false,columnWidth:0.1,tooltip:b.T("TAG017","Remove Coverage"),listeners:{el:{click:function(){Ext.getCmp("coveredIBSec").hide();Ext.getCmp("coveredIBName").clearValue();}}}});var d=SVMX.create("com.servicemax.client.ui.components.composites.impl.SVMXSection",{collapsible:false,border:false,header:false,id:"coveragesGridSec",cls:"img-header-default",});I.covergaeStore=SVMX.create("com.servicemax.client.ui.components.composites.impl.SVMXStore",{fields:[{name:"installedProductName"},{name:"delete"},{name:"pmCovergaeId"},{name:"advancedExpression"},{name:"conditionRuleList",type:"object"},{name:"pmCoverageName"},{name:"productId"},{name:"installedProductId"},{name:"scheduleList",type:"object"},{name:"isNewAddCov"},{name:"isDifferentProduct"}],proxy:{type:"memory"},sorters:[{property:"productName",direction:"asc"}],data:I.__engine.getCovergaeList()});var s=SVMX.create("com.servicemax.client.ui.components.composites.impl.SVMXListComposite",{autoScroll:true,maxHeight:450,margin:"40 20 10",anchor:"100%",store:I.covergaeStore,border:false,id:"coverageGrid",emptyText:b.T("TAG015","No Coverages to display"),viewConfig:{deferEmptyText:false,},columns:[{flex:1,text:b.T("TAG016","Coverages"),dataIndex:"installedProductName",align:"left",resizable:true,readOnly:true,renderer:function(M,N,K,L){if(K.data.isDifferentProduct){N.tdCls="make-cell-dirty-lt";N.tdAttr="data-errorqtip='"+b.T("TAG071","Please add condition to newly added coverage as it's product is different from PM template product.")+"'";}return Ext.String.htmlEncode(K.data.installedProductName);}},{xtype:"actioncolumn",flex:10/100,align:"center",resizable:false,dataIndex:"delete",readOnly:true,sortable:false,menuDisabled:true,align:"center",items:[{iconCls:"pmplan-delete-row-icon",cursor:"pointer",tooltip:b.T("TAG017","Remove Coverage"),handler:function(L,M,K){Ext.MessageBox.confirm("Confirm",b.T("TAG026","Are you sure you want to delete coverage?"),function(O){if(O=="yes"){var N=L.getStore().getAt(M);I.covergaeStore.remove(N);if(I.covergaeStore.getCount()==0&&Ext.getCmp("planTemplateName").getValue()=="NONE"){Ext.getCmp("conditionTypeCombo").setReadOnly(false);}}});}}]}],listeners:{cellclick:function(K,N,R,O,Q,S,P){if(R==0){var M=O.getData();var U=[];U=(M.conditionRuleList!=""&&M.conditionRuleList!=null)?M.conditionRuleList:(I.__engine.__pmplanData.pmPlanRecord.pmTemplateDetail!=null?I.__engine.__pmplanData.pmPlanRecord.pmTemplateDetail.conditionRuleList:[]);var V=M.scheduleList;var L={};var T={};L.coverageId=M.installedProductId;L.productId=M.productId;var W=Ext.getCmp("conditionTypeCombo").getValue();L.pmPlanRecord={conditionType:W};I.__engine.getCoverageTechnicalAtt(L,function(ai){if(ai.success){T=ai.mapOfKeyAndListOfKeyValue;var ah=Ext.getCmp("conditionTypeCombo").getValue();if(ah==="Criteria_Comparison"){I.loadAttributeStoreOfCriteriaType(T);}var af=M.advancedExpression!=null&&M.advancedExpression!=""?M.advancedExpression:(I.__engine.__pmplanData.pmPlanRecord.pmTemplateDetail!=null?I.__engine.__pmplanData.pmPlanRecord.pmTemplateDetail.advancedExpression:"");if(V!=""&&V!=null){I.showConditionRulePanel(U,V,M,af,S,T);}else{var ag=SVMX.getClient().getApplicationParameter("svmx-pmplan-userinfo");var ad={};ad.coverageId=M.installedProductId;if(!M.isNewAddCov){ad.conditionRuleList=U;
ad.advancedExpression=af;}else{if(M.conditionRuleList!=null&&M.conditionRuleList.length>0){ad.conditionRuleList=M.conditionRuleList;}else{ad.conditionRuleList=[];}if(M.advancedExpression!=null&&M.advancedExpression!=""){ad.advancedExpression=M.advancedExpression;af=ad.advancedExpression;}else{ad.advancedExpression="";af="";}}ad.pmPlanRecord={};ad.pmPlanRecord.pmPlanId=I.__engine.__pmplanData.pmPlanRecord.pmPlanId;ad.pmPlanRecord.pmTemplateDetail=JSON.parse(JSON.stringify(I.__engine.__pmplanData.pmPlanRecord.pmTemplateDetail));ad.pmPlanRecord.conditionType=Ext.getCmp("conditionTypeCombo").getValue();var X=Ext.getCmp("startDate").getValue();var ac=Ext.getCmp("endDate").getValue();if(X!=null){ad.pmPlanRecord.startDate=com.servicemax.client.lib.datetimeutils.DatetimeUtil.convertToTimezone(Ext.getCmp("startDate").getValue(),ag.TimezoneOffset,false);ad.pmPlanRecord.startDate=ad.pmPlanRecord.startDate.substr(0,ad.pmPlanRecord.startDate.indexOf(" "));}if(ac!=null){ad.pmPlanRecord.endDate=com.servicemax.client.lib.datetimeutils.DatetimeUtil.convertToTimezone(Ext.getCmp("endDate").getValue(),ag.TimezoneOffset,false);ad.pmPlanRecord.endDate=ad.pmPlanRecord.endDate.substr(0,ad.pmPlanRecord.endDate.indexOf(" "));}ad.workOrderPurposeId=Ext.getCmp("WOPurpose").getValue();if(ad.conditionRuleList!=null&&ad.conditionRuleList.length>0&&(ad.advancedExpression==""||ad.advancedExpression==null)){af=advancedExp(ai.conditionRuleList.length);}if(ad.pmPlanRecord.conditionType==="Criteria_Comparison"&&ad.conditionRuleList!=null&&ad.conditionRuleList.length>0){var ae=Ext.data.StoreManager.lookup("Field_List_Store_CB");for(var Z=0;Z<ad.conditionRuleList.length;Z++){var ab=ad.conditionRuleList[Z].selectedField;var Y=ae.findRecord("fieldApiName",ab,0,false,true,true);var aa=Y&&Y.getData().fieldLabel;ad.conditionRuleList[Z].selectedFieldLabel=aa;}}I.__engine.getCoverageScheduleData(ad,function(ak){if(ak.success){var aj=ak.scheduleList;if(ak.conditionRuleList==null||ak.conditionRuleList.length==0){af="";}I.showConditionRulePanel(ak.conditionRuleList,aj,M,af,S,T);}else{SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(ak.messageList[0],7000,"success");}});}}else{SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(ai.messageList[0],7000,"success");}});}}}});d.add(s);d.add(C);I.add(d);var p=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXButton",{text:b.T("TAG018","Add Coverages"),scale:"medium",height:30,id:"addCovBtn",cls:"pmplan-coverages-btn",handler:function(K,L){Ext.getCmp("coveredIBSec").show();}});I.add(p);var J=SVMX.create("com.servicemax.client.ui.components.composites.impl.SVMXToolbar",{width:"calc(100% - 30px)",dock:"bottom",style:"margin-top: 20px",border:false,});var B=SVMX.create("Ext.Toolbar.Fill",{});J.add(B);var e=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXButton",{text:b.T("TAG022","Cancel"),scale:"medium",height:30,cls:"pmplan-cancel-btn",handler:function(){var K="";if(I.__engine.__sourceId!=undefined){K="/"+I.__engine.__sourceId;}else{K="/"+I.__engine.__planId;}if((typeof sforce!="undefined")&&(sforce!=null)){sforce.one.navigateToURL(K);}else{window.location=K;}}});var D=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXButton",{text:b.T("TAG023","Save"),scale:"medium",height:30,id:"savePMPlanBtn",cls:"pmplan-save-btn",handler:function(K,L){I.savePMPlan("button");}});J.add(e);J.add(D);I.add(J);},onAddClick:function(c){Ext.getCmp("gridBbar").add(coveredIBSec);},advancedExp:function(e){var d="";for(var c=0;c<e;c++){if(d.length>0){d+=" AND ";}d+=c+1;}return d;},loadData:function(c){if(c.objAPIName=="Account"){this.accountStore.loadData(c.searchResponse);}if(c.objAPIName==SVMX.OrgNamespace+"__PM_Plan_Template__c"){this.planTemplateStore.loadData(c.searchResponse);}if(c.objAPIName==SVMX.OrgNamespace+"__Service_Contract__c"){this.serviceContractStore.loadData(c.searchResponse);}if(c.objAPIName==SVMX.OrgNamespace+"SLA_Terms__c"){this.slaTermsStore.loadData(c.searchResponse);}if(c.objAPIName==SVMX.OrgNamespace+"__Installed_Product__c"){this.coveredIBStore.loadData(c.searchResponse);}if(c.objAPIName==SVMX.OrgNamespace+"__Site__c"){this.locationStore.loadData(c.searchResponse);}},loadTemplateDetails:function(c){var e=Ext.getCmp("activityDate");e.setValue(c.pmPlanRecord.pmTemplateDetail.activityDate);var f=Ext.getCmp("WOPurpose");f.setValue(c.pmPlanRecord.pmTemplateDetail.workOrderPurpose);var d=Ext.getCmp("conditionTypeCombo");var g=(c.pmPlanRecord.pmTemplateDetail.conditionType!=null&&(c.pmPlanRecord.pmTemplateDetail.conditionType)!="")?c.pmPlanRecord.pmTemplateDetail.conditionType:"Usage_Frequency";d.setValue(g);if(c.pmPlanRecord.coverageList!=null&&c.pmPlanRecord.coverageList.length>0){d.setReadOnly(true);}this.__engine.__pmplanData.pmPlanRecord.pmTemplateDetail=c.pmPlanRecord.pmTemplateDetail;this.__engine.__pmplanData.pmPlanRecord.pmPlanMappedValues=c.pmPlanRecord.pmPlanMappedValues;Ext.getCmp("planName").setValue(this.__engine.__pmplanData.pmPlanRecord.pmPlanMappedValues.Name);
Ext.getCmp("serviceContractName").setValue(this.__engine.__pmplanData.pmPlanRecord.pmPlanMappedValues[SVMX.OrgNamespace+"__Service_Contract__c"]);Ext.getCmp("accountName").setValue(this.__engine.__pmplanData.pmPlanRecord.pmPlanMappedValues[SVMX.OrgNamespace+"__Account__c"]);Ext.getCmp("slaTermsName").setValue(this.__engine.__pmplanData.pmPlanRecord.pmPlanMappedValues[SVMX.OrgNamespace+"__SLA_Terms__c"]);Ext.getCmp("locationName").setValue(this.__engine.__pmplanData.pmPlanRecord.pmPlanMappedValues[SVMX.OrgNamespace+"__Location__c"]);Ext.getCmp("startDate").setValue(this.__engine.__pmplanData.pmPlanRecord.pmPlanMappedValues[SVMX.OrgNamespace+"__Start_Date__c"]);Ext.getCmp("endDate").setValue(this.__engine.__pmplanData.pmPlanRecord.pmPlanMappedValues[SVMX.OrgNamespace+"__End_Date__c"]);if(Ext.getCmp("endDate").getValue()!=null){Ext.getCmp("endDate").setDisabled(false);}Ext.getCmp("activityDate").setValue(this.__engine.__pmplanData.pmPlanRecord.pmPlanMappedValues[SVMX.OrgNamespace+"__SM_Adjustment_Activity_Date__c"]);Ext.getCmp("description").setValue(this.__engine.__pmplanData.pmPlanRecord.pmPlanMappedValues[SVMX.OrgNamespace+"__Description__c"]);Ext.getCmp("WOPurpose").setValue(this.__engine.__pmplanData.pmPlanRecord.pmPlanMappedValues[SVMX.OrgNamespace+"__Task_Template__c"]);this.covergaeStore.removeAll();if(this.__engine.__mode.toLowerCase()=="ib"){if(c.pmPlanRecord.coverageList!=null&&c.pmPlanRecord.coverageList.length>0){c.pmPlanRecord.coverageList.forEach(function(k,h){var i=Ext.getCmp("pmplan");if(i.__engine.__pmplanData.pmPlanRecord.pmTemplateDetail!=null&&i.__engine.__pmplanData.pmPlanRecord.pmTemplateDetail!=""){if(i.__engine.__pmplanData.pmPlanRecord.pmTemplateDetail.product!=null&&i.__engine.__pmplanData.pmPlanRecord.pmTemplateDetail.product!=k.productId){k.isDifferentProduct=true;i.__engine.__pmplanData.pmPlanRecord.pmTemplateDetail.conditionRuleList=[];i.__engine.__pmplanData.pmPlanRecord.pmTemplateDetail.advancedExpression="";}}});}}if(c.pmPlanRecord.coverageList!=null){this.covergaeStore.loadData(c.pmPlanRecord.coverageList);}},createPMTemplateReq:function(c){var d={};d.pmTemplateId=c;d.pmPlanDataUpdates={};d.pmPlanDataUpdates.serviceContractId=Ext.getCmp("serviceContractName").getValue();var i=Ext.getCmp("accountName");d.pmPlanDataUpdates.accountId=i.getValue();d.pmPlanDataUpdates.locationId=Ext.getCmp("locationName").getValue();d.pmPlanDataUpdates.pmPlanMappedValues=this.__engine.__pmplanData.pmPlanRecord.pmPlanMappedValues;d.pmPlanDataUpdates.pmTemplatePMPlanMapping=this.__engine.__pmplanData.pmPlanRecord.pmTemplatePMPlanMapping;d.pmPlanDataUpdates.pmPlanMappedValues[SVMX.OrgNamespace+"__Account__c"]=d.pmPlanDataUpdates.accountId;d.pmPlanDataUpdates.pmPlanMappedValues[SVMX.OrgNamespace+"__Location__c"]=d.pmPlanDataUpdates.locationId;d.pmPlanDataUpdates.pmPlanMappedValues[SVMX.OrgNamespace+"__Service_Contract__c"]=d.pmPlanDataUpdates.serviceContractId;d.pmPlanDataUpdates.pmPlanMappedValues.Name=Ext.getCmp("planName").getValue();d.pmPlanDataUpdates.pmPlanMappedValues[SVMX.OrgNamespace+"__SLA_Terms__c"]=Ext.getCmp("slaTermsName").getValue();d.pmPlanDataUpdates.pmPlanMappedValues[SVMX.OrgNamespace+"__Task_Template__c"]=Ext.getCmp("WOPurpose").getValue();d.pmPlanDataUpdates.pmPlanMappedValues[SVMX.OrgNamespace+"__Description__c"]=Ext.getCmp("description").getValue();d.pmPlanDataUpdates.pmPlanMappedValues[SVMX.OrgNamespace+"__SM_Adjustment_Activity_Date__c"]=Ext.getCmp("activityDate").getValue();var j=SVMX.getClient().getApplicationParameter("svmx-pmplan-userinfo");var e=Ext.getCmp("startDate").getValue();var f=Ext.getCmp("endDate").getValue();if(e!=null){d.pmPlanDataUpdates.startDate=com.servicemax.client.lib.datetimeutils.DatetimeUtil.convertToTimezone(Ext.getCmp("startDate").getValue(),j.TimezoneOffset,false);var h=com.servicemax.client.lib.datetimeutils.DatetimeUtil.convertToTimezone(Ext.getCmp("startDate").getValue(),j.TimezoneOffset,false);d.pmPlanDataUpdates.pmPlanMappedValues[SVMX.OrgNamespace+"__Start_Date__c"]=h.substring(0,h.indexOf(" "));}if(f!=null){d.pmPlanDataUpdates.endDate=com.servicemax.client.lib.datetimeutils.DatetimeUtil.convertToTimezone(Ext.getCmp("endDate").getValue(),j.TimezoneOffset,false);var g=com.servicemax.client.lib.datetimeutils.DatetimeUtil.convertToTimezone(Ext.getCmp("endDate").getValue(),j.TimezoneOffset,false);d.pmPlanDataUpdates.pmPlanMappedValues[SVMX.OrgNamespace+"__End_Date__c"]=g.substring(0,g.indexOf(" "));}d.mode=this.__engine.__mode;if(d.mode.toLowerCase()=="ib"){var k=[];Ext.getCmp("coverageGrid").getStore().data.items.forEach(function(m,l){k.push(m.data);});d.pmPlanDataUpdates.coverageList=k;}this.__engine.getPMTemplateData(d,function(l){if(l.success){var m=Ext.getCmp("pmplan");m.loadTemplateDetails(l);}else{SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(Ext.String.htmlEncode(l.messageList[0]),7000,"success");}});},showConditionRulePanel:function(h,c,d,g,e,f){this.conditionrulePanel.loadStore(h,c,g,f);this.conditionrulePanel.setTitle(Ext.String.htmlEncode(d.installedProductName));
this.conditionrulePanel.__recordIndex=e;this.conditionrulePanel.__covergaeId=d.productId;this.conditionrulePanel.__runScheduleCoverageId=d.pmCovergaeId;this.conditionrulePanel.show();this.disable();},loadAttributeStoreOfCriteriaType:function(c){this.conditionrulePanel.loadAttributeStoreForCriteria(c);},startEndDateScheduleGeneration:function(){var c=0;Ext.getCmp("coverageGrid").getStore().data.items.forEach(function(e,d){if(e.data.scheduleList!=null&&e.data.scheduleList!=""){c++;}});if(c>0){Ext.MessageBox.confirm("Confirm",b.T("TAG063","Changing this will regenerate all unprocessed schedules for this Preventive maintenance plan. Do you want to continue?"),function(d){if(d=="yes"){Ext.getCmp("coverageGrid").getStore().data.items.forEach(function(f,e){if(f.data.scheduleList!=null&&f.data.scheduleList!=""){f.data.scheduleList=[];}});}});}},savePMPlan:function(j){var f={};f.sourceId=this.__engine.__sourceId;f.mode=this.__engine.__mode;f.pmPlanDataUpdates={};var d=SVMX.getClient().getApplicationParameter("svmx-pmplan-userinfo");var g=[];var i=false;var c=Ext.getCmp("coverageGrid");var e=true;c.getStore().data.items.forEach(function(m,l){var k=c.getNode(l).childNodes[0].getAttribute("class");if(k.indexOf("make-cell-dirty-lt")!=-1){e=false;i=true;SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(b.T("TAG072","Add conditions to save the coverage."),7000,"success");}g.push(m.data);});if(Ext.getCmp("planName").getValue().length==0){Ext.getCmp("planName").markInvalid(b.T("TAG019","Enter PM Plan Name"));i=true;}else{f.pmPlanDataUpdates.pmPlanName=Ext.getCmp("planName").getValue();}if(Ext.getCmp("endDate").getValue()==null){Ext.getCmp("endDate").markInvalid(b.T("TAG020","Enter End Date"));i=true;}else{f.pmPlanDataUpdates.endDate=com.servicemax.client.lib.datetimeutils.DatetimeUtil.convertToTimezone(Ext.getCmp("endDate").getValue(),d.TimezoneOffset,false);}if(Ext.getCmp("startDate").getValue()==null){Ext.getCmp("startDate").markInvalid(b.T("TAG021","Enter Start Date"));i=true;}else{f.pmPlanDataUpdates.startDate=com.servicemax.client.lib.datetimeutils.DatetimeUtil.convertToTimezone(Ext.getCmp("startDate").getValue(),d.TimezoneOffset,false);}if(!i){Ext.getCmp("savePMPlanBtn").setDisabled(true);var h=Ext.getCmp("planTemplateName").getValue();f.pmPlanDataUpdates.pmPlanTemplateId=(h!=="NONE")?h:null;f.pmPlanDataUpdates.serviceContractId=Ext.getCmp("serviceContractName").getValue();f.pmPlanDataUpdates.selectedCovergaeType=Ext.getCmp("coverageTypeName").getValue();f.pmPlanDataUpdates.conditionType=Ext.getCmp("conditionTypeCombo").getValue();f.pmPlanDataUpdates.slaId=Ext.getCmp("slaTermsName").getValue();f.pmPlanDataUpdates.accountId=Ext.getCmp("accountName").getValue();f.pmPlanDataUpdates.locationId=Ext.getCmp("locationName").getValue();f.pmPlanDataUpdates.description=Ext.getCmp("description").getValue();f.pmPlanDataUpdates.selectedScheduleType=Ext.getCmp("scheduleTypeName").getValue();f.pmPlanDataUpdates.coverageList=g;f.pmPlanDataUpdates.pmPlanId=this.__engine.__pmplanData.pmPlanRecord.pmPlanId;f.pmPlanDataUpdates.pmTemplateDetail=this.__engine.__pmplanData.pmPlanRecord.pmTemplateDetail;f.pmPlanDataUpdates.pmTemplateDetail.workOrderPurpose=Ext.getCmp("WOPurpose").getValue();f.pmPlanDataUpdates.pmTemplateDetail.activityDate=Ext.getCmp("activityDate").getValue();f.pmPlanDataUpdates.woPurposeId=Ext.getCmp("WOPurpose").getValue();f.pmPlanDataUpdates.selectedActivityDate=Ext.getCmp("activityDate").getValue();f.pmPlanDataUpdates.activatePMPlan=this.__engine.__pmplanData.pmPlanRecord.activatePMPlan;f.pmPlanDataUpdates.pmPlanMappedValues=this.__engine.__pmplanData.pmPlanRecord.pmPlanMappedValues;this.__engine.savePMPlan(f,function(l){if(l.success&&j=="button"){var k="/"+l.pmPlanRecord.pmPlanId;if((typeof sforce!="undefined")&&(sforce!=null)){sforce.one.navigateToURL(k);}else{window.location=k;}}else{SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(Ext.String.htmlEncode(l.messageList[0]),7000,"success");}Ext.getCmp("savePMPlanBtn").setDisabled(false);});}}});};})();
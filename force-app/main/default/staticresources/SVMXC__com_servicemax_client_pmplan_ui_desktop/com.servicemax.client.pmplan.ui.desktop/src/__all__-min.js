(function(){var a=SVMX.Package("com.servicemax.client.pmplan.ui.desktop.api");a.init=function(){var b=SVMX.getClient().getServiceRegistry().getServiceInstance("com.servicemax.client.translation").getDictionary("PMPLAN");Ext.define("com.servicemax.client.pmplan.ui.desktop.api.RootContainer",{extend:"com.servicemax.client.ui.components.composites.impl.SVMXSection",cls:"pmplan-root-container",width:"100%",id:"pmplan",constructor:function(c){c=Ext.apply({title:b.T("TAG001","Preventive Maintenance Plan"),titleAlign:"center",collapsible:false,header:{items:[{xtype:"svmx.button",itemId:"BackButton",padding:"0",text:SVMX.getUrlParameter("mode").toLowerCase()=="sc"?b.T("TAG002","Back to Service Contract"):(SVMX.getUrlParameter("mode").toLowerCase()=="account"?b.T("TAG068","Back to Account"):(SVMX.getUrlParameter("mode").toLowerCase()=="location"?b.T("TAG069","Back to Location"):b.T("TAG070","Back to Installed Product"))),hidden:SVMX.getUrlParameter("pmPlanId")!=null?true:false,handler:function(i,g,d,f){var h="";if(SVMX.getUrlParameter("sourceId")!=null){h="/"+SVMX.getUrlParameter("sourceId");}else{h="/"+SVMX.getUrlParameter("pmPlanId");}if((typeof sforce!="undefined")&&(sforce!=null)){sforce.one.navigateToURL(h);}else{window.location=h;}}}]},},c||{});this.callParent(arguments);},initComponent:function(){this.callParent(arguments);var I=this;var n=I.__engine.__pmplanData.pmPlanRecord;I.conditionrulePanel=SVMX.create("com.servicemax.client.pmplan.ui.desktop.api.ConditionrulePanel",{__parent:I,__engine:I.__engine,border:false,collapsible:false,hidden:true,});var q=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXText",{id:"planName",name:"planName",labelAlign:"top",fieldLabel:b.T("TAG003","Plan Name"),value:n.pmPlanName,labelSeparator:"",allowBlank:false,msgTarget:"under",style:"top: 10px;",});I.planTemplateStore=SVMX.create("Ext.data.Store",{fields:[{name:"Id"},{name:"name"}],proxy:{type:"memory"},data:I.__engine.getPMTemplatelist()});var t=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXPicklist",{id:"planTemplateName",name:"planTemplateName",labelAlign:"top",fieldLabel:b.T("TAG004","Plan Template"),labelField:"label",valueField:"Id",displayField:"name",queryMode:"local",store:I.planTemplateStore,labelSeparator:"",margins:"0 0 0 6",editable:false,listConfig:{getInnerTpl:function(K){return"{[Ext.String.htmlEncode(values."+K+")]}";}},listeners:{beforeselect:function(O,K,M){var L=this.getValue();var N=K.getData().Id;if(I.covergaeStore.data.length==0){if(N!="NONE"){I.createPMTemplateReq(N);}else{I.createPMTemplateReq(null);Ext.getCmp("conditionTypeCombo").setReadOnly(false);}}else{if(N!=="NONE"&&I.covergaeStore.data.length!=0){if(!(I.__engine.__mode.toLowerCase()=="ib")){Ext.MessageBox.confirm("Confirm",b.T("TAG027","This operation will remove all coverages and schedules. Do you want to continue?"),function(P){if(P=="yes"){if(K!=null){I.createPMTemplateReq(N);}I.covergaeStore.removeAll();}else{O.setValue(L);Ext.getCmp("conditionTypeCombo").setReadOnly(true);}});}else{I.createPMTemplateReq(N);}}else{if(N==="NONE"&&I.covergaeStore.data.length!=0){Ext.getCmp("conditionTypeCombo").setReadOnly(false);if(!(I.__engine.__mode.toLowerCase()=="ib")){Ext.MessageBox.confirm("Confirm",b.T("TAG027","This operation will remove all coverages and schedules. Do you want to continue?"),function(P){if(P=="yes"){I.covergaeStore.removeAll();I.__engine.__pmplanData.pmPlanRecord.pmTemplateDetail={};}else{O.setValue(L);Ext.getCmp("conditionTypeCombo").setReadOnly(true);}});}else{I.createPMTemplateReq(null);}}}}},afterrender:function(K){if(n.pmPlanTemplateId!=null){K.setValue(n.pmPlanTemplateId);}else{K.setValue("NONE");}}},style:"top: 10px;",});var u=SVMX.create("com.servicemax.client.ui.components.composites.impl.SVMXSection",{layout:"column",defaults:{columnWidth:0.5},collapsible:false,border:false,header:false,hidden:(I.__engine.__mode).toLowerCase()=="account"||(I.__engine.__mode).toLowerCase()=="location",cls:"img-header-default",});I.serviceContractStore=SVMX.create("Ext.data.Store",{fields:[{name:"Id"},{name:"name"}],proxy:{type:"memory"},data:I.__engine.getServiceContract()});var m=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXPicklist",{id:"serviceContractName",name:"serviceContractName",labelAlign:"top",fieldLabel:b.T("TAG005","Service/Maintenance Contract"),labelField:"label",valueField:"Id",displayField:"name",value:n.serviceContractId,labelSeparator:"",columnWidth:0.95,queryMode:"local",store:I.serviceContractStore,listConfig:{getInnerTpl:function(K){return"{[Ext.String.htmlEncode(values."+K+")]}";}},listeners:{select:function(M,K,L){if(Ext.getCmp("planTemplateName").getValue()!="NONE"){I.createPMTemplateReq(Ext.getCmp("planTemplateName").getValue());}}}});u.add(m);u.add({iconCls:"svmx-filter-icon",cursor:"pointer",scale:"medium",border:false,columnWidth:0.05,style:"top: 20px",cls:"img-header-default",listeners:{el:{click:function(){var K=Ext.getCmp("serviceContractName");var M={};
M.objAPIName=SVMX.OrgNamespace+"__Service_Contract__c";M.searchtext=K.getRawValue();if(M.searchtext.length<3){SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(b.T("TAG025","You must enter more than 3 characters to perform search"),7000,"success");}else{var L=Ext.getCmp("pmplan");L.__engine.searchObject(M,function(N){if(N.success){if(N.searchResponse.length>0){I.loadData(N);}else{SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(b.T("TAG024","No matches found. Refine your search. "),7000,"success");}}else{SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(N.messageList[0],7000,"success");}});}}}},});var f=SVMX.create("Ext.data.Store",{fields:[{name:"key"},{name:"value"}],proxy:{type:"memory"},data:I.__engine.getCoverageType()});var v=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXPicklist",{id:"coverageTypeName",name:"coverageTypeName",labelAlign:"top",fieldLabel:b.T("TAG006","Coverage Type"),labelField:"label",valueField:"value",displayField:"key",defaultValue:1,readOnly:true,value:"Product (Must Have IB)",labelSeparator:"",queryMode:"local",store:f,style:"top: 10px;",});var z=SVMX.create("Ext.data.Store",{fields:[{name:"key"},{name:"value"}],proxy:{type:"memory"},data:I.__engine.getScheduleType()});var l=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXPicklist",{id:"scheduleTypeName",name:"coverageTypeName",labelAlign:"top",fieldLabel:b.T("TAG007","Schedule Type"),labelField:"label",valueField:"value",displayField:"key",defaultValue:1,readOnly:true,value:"Condition Based",labelSeparator:"",queryMode:"local",store:z,style:"top: 10px;",});var k=SVMX.create("com.servicemax.client.ui.components.composites.impl.SVMXSection",{layout:"column",defaults:{columnWidth:0.5},collapsible:false,border:false,hidden:(I.__engine.__mode).toLowerCase()=="location",header:false});I.accountStore=SVMX.create("Ext.data.Store",{fields:[{name:"Id"},{name:"name"}],proxy:{type:"memory"},data:I.__engine.getAccount()});var h=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXPicklist",{id:"accountName",name:"accountName",labelAlign:"top",fieldLabel:b.T("TAG008","Account"),labelField:"label",valueField:"Id",displayField:"name",value:n.accountId,labelSeparator:"",queryMode:"local",store:I.accountStore,listConfig:{getInnerTpl:function(K){return"{[Ext.String.htmlEncode(values."+K+")]}";}},columnWidth:0.95,});k.add(h);k.add({iconCls:"svmx-filter-icon",cursor:"pointer",scale:"large",border:false,style:"top: 20px",columnWidth:0.05,cls:"img-header-default",listeners:{el:{click:function(){var L=Ext.getCmp("accountName");var M={};M.objAPIName="Account";M.searchtext=L.getRawValue();if(M.searchtext.length<3){SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(b.T("TAG025","You must enter more than 3 characters to perform search"),7000,"success");}else{var K=Ext.getCmp("pmplan");K.__engine.searchObject(M,function(N){if(N.success){if(N.searchResponse.length>0){I.loadData(N);}else{SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(b.T("TAG024","No matches found. Refine your search. "),7000,"success");}}else{SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(N.messageList[0],7000,"success");}});}}}},});I.slaTermsStore=SVMX.create("Ext.data.Store",{fields:[{name:"Id"},{name:"name"}],proxy:{type:"memory"},data:I.__engine.getSLAlist()});var o=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXPicklist",{id:"slaTermsName",name:"slaTermsName",labelAlign:"top",fieldLabel:b.T("TAG009","SLA Terms"),labelField:"label",valueField:"Id",displayField:"name",value:n.slaId,labelSeparator:"",queryMode:"local",store:I.slaTermsStore,listConfig:{getInnerTpl:function(K){return"{[Ext.String.htmlEncode(values."+K+")]}";}},hidden:(I.__engine.__mode).toLowerCase()=="account"||(I.__engine.__mode).toLowerCase()=="location",style:"margin-top: 10px;",});var g=SVMX.create("com.servicemax.client.ui.components.composites.impl.SVMXSection",{layout:"column",defaults:{columnWidth:0.5},collapsible:false,border:false,hidden:!((I.__engine.__mode).toLowerCase()=="location"),header:false});I.locationStore=SVMX.create("Ext.data.Store",{fields:[{name:"Id"},{name:"name"}],proxy:{type:"memory"},data:I.__engine.getLocationlist()});var c=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXPicklist",{id:"locationName",name:"locationName",labelAlign:"top",fieldLabel:b.T("TAG029","Location"),labelField:"label",valueField:"Id",displayField:"name",value:n.locationId,labelSeparator:"",columnWidth:0.95,queryMode:"local",store:I.locationStore,listConfig:{getInnerTpl:function(K){return"{[Ext.String.htmlEncode(values."+K+")]}";}},hidden:!((I.__engine.__mode).toLowerCase()=="location"),style:"margin-top: 10px;",});g.add(c);g.add({iconCls:"svmx-filter-icon",cursor:"pointer",scale:"large",border:false,style:"top: 20px",columnWidth:0.05,cls:"img-header-default",listeners:{el:{click:function(){var K=Ext.getCmp("locationName");
var M={};M.objAPIName=SVMX.OrgNamespace+"__Site__c";M.searchtext=K.getRawValue();if(M.searchtext.length<3){SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(b.T("TAG025","You must enter more than 3 characters to perform search"),7000,"success");}else{var L=Ext.getCmp("pmplan");L.__engine.searchObject(M,function(N){if(N.success){if(N.searchResponse.length>0){I.loadData(N);}else{SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(b.T("TAG024","No matches found. Refine your search. "),7000,"success");}}else{SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(N.messageList[0],7000,"success");}});}}}},});var i=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXDate",{fieldLabel:b.T("TAG010","Start Date"),labelAlign:"top",id:"startDate",allowBlank:false,msgTarget:"under",value:n.startDate,style:"top: 10px;",labelSeparator:"",invalidText:b.T("TAG079","Enter valid date"),listeners:{select:function(){if(this.getValue()!=""){y.enable();}if(y.getValue()!=null){if(this.getValue()>y.getValue()){alert("Error! End Date Must Be Later Than The Start Date.");this.setValue(y.getValue());}}y.setMinValue(i.getValue());},change:function(){I.startEndDateScheduleGeneration();},render:function(){if(this.getValue()!=""){y.enable();y.setMinValue(i.getValue());}}}});var y=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXDate",{fieldLabel:b.T("TAG011","End Date"),labelAlign:"top",allowBlank:false,id:"endDate",disabled:n.endDate!=null?false:true,labelSeparator:"",msgTarget:"under",style:"top: 10px;",value:n.endDate,invalidText:b.T("TAG079","Enter valid date"),listeners:{change:function(){I.startEndDateScheduleGeneration();}}});I.activityDateStore=SVMX.create("Ext.data.Store",{fields:[{name:"key"},{name:"value"}],proxy:{type:"memory"},data:I.__engine.getActivityDateList()});var H=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXPicklist",{id:"activityDate",name:"activityDate",labelAlign:"top",fieldLabel:b.T("TAG012","Activity Date"),labelField:"key",valueField:"key",displayField:"value",defaultValue:1,value:n.selectedActivityDate,queryMode:"local",store:I.activityDateStore,listConfig:{getInnerTpl:function(K){return"{[Ext.String.htmlEncode(values."+K+")]}";}},labelSeparator:"",style:"margin-top: 10px;",});var F=Ext.create("Ext.data.Store",{storeId:"Condition_Type_Store",fields:["name","label"],data:[{name:"Usage_Frequency",label:b.T("TAG077","Usage/Frequency Based")},{name:"Criteria_Comparison",label:b.T("TAG078","Criteria/Comparison Based")}]});var w=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXPicklist",{fieldLabel:b.T("TAG074","Condition Type"),labelSeparator:"",name:"conditionType",id:"conditionTypeCombo",store:F,queryMode:"local",displayField:"label",valueField:"name",labelAlign:"top",editable:false,listConfig:{getInnerTpl:function(K){return"{[Ext.String.htmlEncode(values."+K+")]}";}},value:n.conditionType!=null?n.conditionType:"Usage_Frequency",readOnly:(n.pmPlanId!=null&&n.coverageList!=null&&n.coverageList.length>0)?true:false});I.WOPurposeStore=SVMX.create("Ext.data.Store",{fields:[{name:"Id"},{name:"name"}],proxy:{type:"memory"},data:I.__engine.getWOPurposelist()});var E=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXPicklist",{id:"WOPurpose",name:"WOPurpose",labelAlign:"top",fieldLabel:b.T("TAG013","Work Order Purpose"),labelField:"label",valueField:"Id",displayField:"name",defaultValue:1,value:n.woPurposeId,queryMode:"local",store:I.WOPurposeStore,listConfig:{getInnerTpl:function(K){return"{[Ext.String.htmlEncode(values."+K+")]}";}},labelSeparator:"",style:"top: 10px;",});var x=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXTextArea",{grow:true,columnWidth:0.98,labelAlign:"top",id:"description",fieldLabel:b.T("TAG014","Description"),width:"100%",height:86,resizable:false,bodyPadding:4,labelSeparator:"",value:n.description,style:"margin-left: 10px;",});var G={xtype:"fieldset",columnWidth:0.5,border:false,defaults:{anchor:"100%"},layout:"anchor",style:"top: 10px;",items:[q,l,u,k,g,i,H]};var A={xtype:"fieldset",columnWidth:0.5,border:false,defaults:{anchor:"100%"},layout:"anchor",style:"top: 10px;",items:[t,v,w,o,E,y]};var j=SVMX.create("com.servicemax.client.ui.components.composites.impl.SVMXSection",{collapsible:false,region:"center",width:"99%",layout:"column",border:false,id:"pmPlanData",style:"margin-left: 8px;",defaults:{bodyPadding:8,},items:[G,A,x]});I.add(j);var C=SVMX.create("com.servicemax.client.ui.components.composites.impl.SVMXSection",{layout:"column",margin:"0 20 10 20",defaults:{columnWidth:0.5},collapsible:false,border:false,header:false,hidden:true,id:"coveredIBSec",cls:"img-header-default",});this.coveredIBStore=SVMX.create("Ext.data.Store",{fields:[{name:"Id"},{name:"name"}],proxy:{type:"memory"},data:[]});var r=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXPicklist",{id:"coveredIBName",name:"coveredIBName",labelAlign:"top",labelField:"label",valueField:"Id",displayField:"name",labelSeparator:"",columnWidth:0.8,queryMode:"local",store:this.coveredIBStore,listConfig:{getInnerTpl:function(K){return"{[Ext.String.htmlEncode(values."+K+")]}";
}},listeners:{select:function(P,Q,M,N){var L=I.covergaeStore.getCount();var O=I.__ibSearchList[Q[0].data.Id][SVMX.OrgNamespace+"__Product__c"];var K=true;if(I.__engine.__pmplanData.pmPlanRecord.pmTemplateDetail!=null&&I.__engine.__pmplanData.pmPlanRecord.pmTemplateDetail.product!=null&&I.__engine.__pmplanData.pmPlanRecord.pmTemplateDetail.product!=""){if(I.__engine.__pmplanData.pmPlanRecord.pmTemplateDetail.product==O){K=false;}}var R={installedProductName:Q[0].data.name,installedProductId:Q[0].data.Id,conditionRuleList:[],scheduleList:[],productId:O,isNewAddCov:true,isDifferentProduct:K,};I.covergaeStore.insert(L,R);Ext.getCmp("coveredIBSec").hide();this.clearValue();}}});C.add(r);C.add({iconCls:"svmx-filter-icon",cursor:"pointer",scale:"medium",border:false,columnWidth:0.1,style:"top: -4px",cls:"img-header-default",listeners:{el:{click:function(){var K=Ext.getCmp("coveredIBName");var M={};M.objAPIName=SVMX.OrgNamespace+"__Installed_Product__c";M.searchtext=K.getRawValue();if(M.searchtext.length<3){SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(b.T("TAG025","You must enter more than 3 characters to perform search"),7000,"success");}else{var L=Ext.getCmp("pmplan");L.__engine.searchObject(M,function(N){if(N.success){if(N.searchResponse.length>0){I.loadData(N);I.__ibSearchList=N.mapSearchRecord;}else{SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(b.T("TAG024","No matches found. Refine your search. "),7000,"success");}}else{SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(N.messageList[0],7000,"success");}});}}}},});C.add({iconCls:"pmplan-delete-row-icon",cls:"pmplan-add-coverage",cursor:"pointer",border:false,columnWidth:0.1,tooltip:b.T("TAG017","Remove Coverage"),listeners:{el:{click:function(){Ext.getCmp("coveredIBSec").hide();Ext.getCmp("coveredIBName").clearValue();}}}});var d=SVMX.create("com.servicemax.client.ui.components.composites.impl.SVMXSection",{collapsible:false,border:false,header:false,id:"coveragesGridSec",cls:"img-header-default",});I.covergaeStore=SVMX.create("com.servicemax.client.ui.components.composites.impl.SVMXStore",{fields:[{name:"installedProductName"},{name:"delete"},{name:"pmCovergaeId"},{name:"advancedExpression"},{name:"conditionRuleList",type:"object"},{name:"pmCoverageName"},{name:"productId"},{name:"installedProductId"},{name:"scheduleList",type:"object"},{name:"isNewAddCov"},{name:"isDifferentProduct"}],proxy:{type:"memory"},sorters:[{property:"productName",direction:"asc"}],data:I.__engine.getCovergaeList()});var s=SVMX.create("com.servicemax.client.ui.components.composites.impl.SVMXListComposite",{autoScroll:true,maxHeight:450,margin:"40 20 10",anchor:"100%",store:I.covergaeStore,border:false,id:"coverageGrid",emptyText:b.T("TAG015","No Coverages to display"),viewConfig:{deferEmptyText:false,},columns:[{flex:1,text:b.T("TAG016","Coverages"),dataIndex:"installedProductName",align:"left",resizable:true,readOnly:true,renderer:function(M,N,K,L){if(K.data.isDifferentProduct){N.tdCls="make-cell-dirty-lt";N.tdAttr="data-errorqtip='"+b.T("TAG071","Please add condition to newly added coverage as it's product is different from PM template product.")+"'";}return Ext.String.htmlEncode(K.data.installedProductName);}},{xtype:"actioncolumn",flex:10/100,align:"center",resizable:false,dataIndex:"delete",readOnly:true,sortable:false,menuDisabled:true,align:"center",items:[{iconCls:"pmplan-delete-row-icon",cursor:"pointer",tooltip:b.T("TAG017","Remove Coverage"),handler:function(L,M,K){Ext.MessageBox.confirm("Confirm",b.T("TAG026","Are you sure you want to delete coverage?"),function(O){if(O=="yes"){var N=L.getStore().getAt(M);I.covergaeStore.remove(N);if(I.covergaeStore.getCount()==0&&Ext.getCmp("planTemplateName").getValue()=="NONE"){Ext.getCmp("conditionTypeCombo").setReadOnly(false);}}});}}]}],listeners:{cellclick:function(K,N,R,O,Q,S,P){if(R==0){var M=O.getData();var U=[];U=(M.conditionRuleList!=""&&M.conditionRuleList!=null)?M.conditionRuleList:(I.__engine.__pmplanData.pmPlanRecord.pmTemplateDetail!=null?I.__engine.__pmplanData.pmPlanRecord.pmTemplateDetail.conditionRuleList:[]);var V=M.scheduleList;var L={};var T={};L.coverageId=M.installedProductId;L.productId=M.productId;var W=Ext.getCmp("conditionTypeCombo").getValue();L.pmPlanRecord={conditionType:W};I.__engine.getCoverageTechnicalAtt(L,function(ai){if(ai.success){T=ai.mapOfKeyAndListOfKeyValue;var ah=Ext.getCmp("conditionTypeCombo").getValue();if(ah==="Criteria_Comparison"){I.loadAttributeStoreOfCriteriaType(T);}var af=M.advancedExpression!=null&&M.advancedExpression!=""?M.advancedExpression:(I.__engine.__pmplanData.pmPlanRecord.pmTemplateDetail!=null?I.__engine.__pmplanData.pmPlanRecord.pmTemplateDetail.advancedExpression:"");if(V!=""&&V!=null){I.showConditionRulePanel(U,V,M,af,S,T);}else{var ag=SVMX.getClient().getApplicationParameter("svmx-pmplan-userinfo");var ad={};ad.coverageId=M.installedProductId;if(!M.isNewAddCov){ad.conditionRuleList=U;
ad.advancedExpression=af;}else{if(M.conditionRuleList!=null&&M.conditionRuleList.length>0){ad.conditionRuleList=M.conditionRuleList;}else{ad.conditionRuleList=[];}if(M.advancedExpression!=null&&M.advancedExpression!=""){ad.advancedExpression=M.advancedExpression;af=ad.advancedExpression;}else{ad.advancedExpression="";af="";}}ad.pmPlanRecord={};ad.pmPlanRecord.pmPlanId=I.__engine.__pmplanData.pmPlanRecord.pmPlanId;ad.pmPlanRecord.pmTemplateDetail=JSON.parse(JSON.stringify(I.__engine.__pmplanData.pmPlanRecord.pmTemplateDetail));ad.pmPlanRecord.conditionType=Ext.getCmp("conditionTypeCombo").getValue();var X=Ext.getCmp("startDate").getValue();var ac=Ext.getCmp("endDate").getValue();if(X!=null){ad.pmPlanRecord.startDate=com.servicemax.client.lib.datetimeutils.DatetimeUtil.convertToTimezone(Ext.getCmp("startDate").getValue(),ag.TimezoneOffset,false);ad.pmPlanRecord.startDate=ad.pmPlanRecord.startDate.substr(0,ad.pmPlanRecord.startDate.indexOf(" "));}if(ac!=null){ad.pmPlanRecord.endDate=com.servicemax.client.lib.datetimeutils.DatetimeUtil.convertToTimezone(Ext.getCmp("endDate").getValue(),ag.TimezoneOffset,false);ad.pmPlanRecord.endDate=ad.pmPlanRecord.endDate.substr(0,ad.pmPlanRecord.endDate.indexOf(" "));}ad.workOrderPurposeId=Ext.getCmp("WOPurpose").getValue();if(ad.conditionRuleList!=null&&ad.conditionRuleList.length>0&&(ad.advancedExpression==""||ad.advancedExpression==null)){af=advancedExp(ai.conditionRuleList.length);}if(ad.pmPlanRecord.conditionType==="Criteria_Comparison"&&ad.conditionRuleList!=null&&ad.conditionRuleList.length>0){var ae=Ext.data.StoreManager.lookup("Field_List_Store_CB");for(var Z=0;Z<ad.conditionRuleList.length;Z++){var ab=ad.conditionRuleList[Z].selectedField;var Y=ae.findRecord("fieldApiName",ab,0,false,true,true);var aa=Y&&Y.getData().fieldLabel;ad.conditionRuleList[Z].selectedFieldLabel=aa;}}I.__engine.getCoverageScheduleData(ad,function(ak){if(ak.success){var aj=ak.scheduleList;if(ak.conditionRuleList==null||ak.conditionRuleList.length==0){af="";}I.showConditionRulePanel(ak.conditionRuleList,aj,M,af,S,T);}else{SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(ak.messageList[0],7000,"success");}});}}else{SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(ai.messageList[0],7000,"success");}});}}}});d.add(s);d.add(C);I.add(d);var p=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXButton",{text:b.T("TAG018","Add Coverages"),scale:"medium",height:30,id:"addCovBtn",cls:"pmplan-coverages-btn",handler:function(K,L){Ext.getCmp("coveredIBSec").show();}});I.add(p);var J=SVMX.create("com.servicemax.client.ui.components.composites.impl.SVMXToolbar",{width:"calc(100% - 30px)",dock:"bottom",style:"margin-top: 20px",border:false,});var B=SVMX.create("Ext.Toolbar.Fill",{});J.add(B);var e=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXButton",{text:b.T("TAG022","Cancel"),scale:"medium",height:30,cls:"pmplan-cancel-btn",handler:function(){var K="";if(I.__engine.__sourceId!=undefined){K="/"+I.__engine.__sourceId;}else{K="/"+I.__engine.__planId;}if((typeof sforce!="undefined")&&(sforce!=null)){sforce.one.navigateToURL(K);}else{window.location=K;}}});var D=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXButton",{text:b.T("TAG023","Save"),scale:"medium",height:30,id:"savePMPlanBtn",cls:"pmplan-save-btn",handler:function(K,L){I.savePMPlan("button");}});J.add(e);J.add(D);I.add(J);},onAddClick:function(c){Ext.getCmp("gridBbar").add(coveredIBSec);},advancedExp:function(e){var d="";for(var c=0;c<e;c++){if(d.length>0){d+=" AND ";}d+=c+1;}return d;},loadData:function(c){if(c.objAPIName=="Account"){this.accountStore.loadData(c.searchResponse);}if(c.objAPIName==SVMX.OrgNamespace+"__PM_Plan_Template__c"){this.planTemplateStore.loadData(c.searchResponse);}if(c.objAPIName==SVMX.OrgNamespace+"__Service_Contract__c"){this.serviceContractStore.loadData(c.searchResponse);}if(c.objAPIName==SVMX.OrgNamespace+"SLA_Terms__c"){this.slaTermsStore.loadData(c.searchResponse);}if(c.objAPIName==SVMX.OrgNamespace+"__Installed_Product__c"){this.coveredIBStore.loadData(c.searchResponse);}if(c.objAPIName==SVMX.OrgNamespace+"__Site__c"){this.locationStore.loadData(c.searchResponse);}},loadTemplateDetails:function(c){var e=Ext.getCmp("activityDate");e.setValue(c.pmPlanRecord.pmTemplateDetail.activityDate);var f=Ext.getCmp("WOPurpose");f.setValue(c.pmPlanRecord.pmTemplateDetail.workOrderPurpose);var d=Ext.getCmp("conditionTypeCombo");var g=(c.pmPlanRecord.pmTemplateDetail.conditionType!=null&&(c.pmPlanRecord.pmTemplateDetail.conditionType)!="")?c.pmPlanRecord.pmTemplateDetail.conditionType:"Usage_Frequency";d.setValue(g);if(c.pmPlanRecord.coverageList!=null&&c.pmPlanRecord.coverageList.length>0){d.setReadOnly(true);}this.__engine.__pmplanData.pmPlanRecord.pmTemplateDetail=c.pmPlanRecord.pmTemplateDetail;this.__engine.__pmplanData.pmPlanRecord.pmPlanMappedValues=c.pmPlanRecord.pmPlanMappedValues;Ext.getCmp("planName").setValue(this.__engine.__pmplanData.pmPlanRecord.pmPlanMappedValues.Name);
Ext.getCmp("serviceContractName").setValue(this.__engine.__pmplanData.pmPlanRecord.pmPlanMappedValues[SVMX.OrgNamespace+"__Service_Contract__c"]);Ext.getCmp("accountName").setValue(this.__engine.__pmplanData.pmPlanRecord.pmPlanMappedValues[SVMX.OrgNamespace+"__Account__c"]);Ext.getCmp("slaTermsName").setValue(this.__engine.__pmplanData.pmPlanRecord.pmPlanMappedValues[SVMX.OrgNamespace+"__SLA_Terms__c"]);Ext.getCmp("locationName").setValue(this.__engine.__pmplanData.pmPlanRecord.pmPlanMappedValues[SVMX.OrgNamespace+"__Location__c"]);Ext.getCmp("startDate").setValue(this.__engine.__pmplanData.pmPlanRecord.pmPlanMappedValues[SVMX.OrgNamespace+"__Start_Date__c"]);Ext.getCmp("endDate").setValue(this.__engine.__pmplanData.pmPlanRecord.pmPlanMappedValues[SVMX.OrgNamespace+"__End_Date__c"]);if(Ext.getCmp("endDate").getValue()!=null){Ext.getCmp("endDate").setDisabled(false);}Ext.getCmp("activityDate").setValue(this.__engine.__pmplanData.pmPlanRecord.pmPlanMappedValues[SVMX.OrgNamespace+"__SM_Adjustment_Activity_Date__c"]);Ext.getCmp("description").setValue(this.__engine.__pmplanData.pmPlanRecord.pmPlanMappedValues[SVMX.OrgNamespace+"__Description__c"]);Ext.getCmp("WOPurpose").setValue(this.__engine.__pmplanData.pmPlanRecord.pmPlanMappedValues[SVMX.OrgNamespace+"__Task_Template__c"]);this.covergaeStore.removeAll();if(this.__engine.__mode.toLowerCase()=="ib"){if(c.pmPlanRecord.coverageList!=null&&c.pmPlanRecord.coverageList.length>0){c.pmPlanRecord.coverageList.forEach(function(k,h){var i=Ext.getCmp("pmplan");if(i.__engine.__pmplanData.pmPlanRecord.pmTemplateDetail!=null&&i.__engine.__pmplanData.pmPlanRecord.pmTemplateDetail!=""){if(i.__engine.__pmplanData.pmPlanRecord.pmTemplateDetail.product!=null&&i.__engine.__pmplanData.pmPlanRecord.pmTemplateDetail.product!=k.productId){k.isDifferentProduct=true;i.__engine.__pmplanData.pmPlanRecord.pmTemplateDetail.conditionRuleList=[];i.__engine.__pmplanData.pmPlanRecord.pmTemplateDetail.advancedExpression="";}}});}}if(c.pmPlanRecord.coverageList!=null){this.covergaeStore.loadData(c.pmPlanRecord.coverageList);}},createPMTemplateReq:function(c){var d={};d.pmTemplateId=c;d.pmPlanDataUpdates={};d.pmPlanDataUpdates.serviceContractId=Ext.getCmp("serviceContractName").getValue();var i=Ext.getCmp("accountName");d.pmPlanDataUpdates.accountId=i.getValue();d.pmPlanDataUpdates.locationId=Ext.getCmp("locationName").getValue();d.pmPlanDataUpdates.pmPlanMappedValues=this.__engine.__pmplanData.pmPlanRecord.pmPlanMappedValues;d.pmPlanDataUpdates.pmTemplatePMPlanMapping=this.__engine.__pmplanData.pmPlanRecord.pmTemplatePMPlanMapping;d.pmPlanDataUpdates.pmPlanMappedValues[SVMX.OrgNamespace+"__Account__c"]=d.pmPlanDataUpdates.accountId;d.pmPlanDataUpdates.pmPlanMappedValues[SVMX.OrgNamespace+"__Location__c"]=d.pmPlanDataUpdates.locationId;d.pmPlanDataUpdates.pmPlanMappedValues[SVMX.OrgNamespace+"__Service_Contract__c"]=d.pmPlanDataUpdates.serviceContractId;d.pmPlanDataUpdates.pmPlanMappedValues.Name=Ext.getCmp("planName").getValue();d.pmPlanDataUpdates.pmPlanMappedValues[SVMX.OrgNamespace+"__SLA_Terms__c"]=Ext.getCmp("slaTermsName").getValue();d.pmPlanDataUpdates.pmPlanMappedValues[SVMX.OrgNamespace+"__Task_Template__c"]=Ext.getCmp("WOPurpose").getValue();d.pmPlanDataUpdates.pmPlanMappedValues[SVMX.OrgNamespace+"__Description__c"]=Ext.getCmp("description").getValue();d.pmPlanDataUpdates.pmPlanMappedValues[SVMX.OrgNamespace+"__SM_Adjustment_Activity_Date__c"]=Ext.getCmp("activityDate").getValue();var j=SVMX.getClient().getApplicationParameter("svmx-pmplan-userinfo");var e=Ext.getCmp("startDate").getValue();var f=Ext.getCmp("endDate").getValue();if(e!=null){d.pmPlanDataUpdates.startDate=com.servicemax.client.lib.datetimeutils.DatetimeUtil.convertToTimezone(Ext.getCmp("startDate").getValue(),j.TimezoneOffset,false);var h=com.servicemax.client.lib.datetimeutils.DatetimeUtil.convertToTimezone(Ext.getCmp("startDate").getValue(),j.TimezoneOffset,false);d.pmPlanDataUpdates.pmPlanMappedValues[SVMX.OrgNamespace+"__Start_Date__c"]=h.substring(0,h.indexOf(" "));}if(f!=null){d.pmPlanDataUpdates.endDate=com.servicemax.client.lib.datetimeutils.DatetimeUtil.convertToTimezone(Ext.getCmp("endDate").getValue(),j.TimezoneOffset,false);var g=com.servicemax.client.lib.datetimeutils.DatetimeUtil.convertToTimezone(Ext.getCmp("endDate").getValue(),j.TimezoneOffset,false);d.pmPlanDataUpdates.pmPlanMappedValues[SVMX.OrgNamespace+"__End_Date__c"]=g.substring(0,g.indexOf(" "));}d.mode=this.__engine.__mode;if(d.mode.toLowerCase()=="ib"){var k=[];Ext.getCmp("coverageGrid").getStore().data.items.forEach(function(m,l){k.push(m.data);});d.pmPlanDataUpdates.coverageList=k;}this.__engine.getPMTemplateData(d,function(l){if(l.success){var m=Ext.getCmp("pmplan");m.loadTemplateDetails(l);}else{SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(Ext.String.htmlEncode(l.messageList[0]),7000,"success");}});},showConditionRulePanel:function(h,c,d,g,e,f){this.conditionrulePanel.loadStore(h,c,g,f);this.conditionrulePanel.setTitle(Ext.String.htmlEncode(d.installedProductName));
this.conditionrulePanel.__recordIndex=e;this.conditionrulePanel.__covergaeId=d.productId;this.conditionrulePanel.__runScheduleCoverageId=d.pmCovergaeId;this.conditionrulePanel.show();this.disable();},loadAttributeStoreOfCriteriaType:function(c){this.conditionrulePanel.loadAttributeStoreForCriteria(c);},startEndDateScheduleGeneration:function(){var c=0;Ext.getCmp("coverageGrid").getStore().data.items.forEach(function(e,d){if(e.data.scheduleList!=null&&e.data.scheduleList!=""){c++;}});if(c>0){Ext.MessageBox.confirm("Confirm",b.T("TAG063","Changing this will regenerate all unprocessed schedules for this Preventive maintenance plan. Do you want to continue?"),function(d){if(d=="yes"){Ext.getCmp("coverageGrid").getStore().data.items.forEach(function(f,e){if(f.data.scheduleList!=null&&f.data.scheduleList!=""){f.data.scheduleList=[];}});}});}},savePMPlan:function(j){var f={};f.sourceId=this.__engine.__sourceId;f.mode=this.__engine.__mode;f.pmPlanDataUpdates={};var d=SVMX.getClient().getApplicationParameter("svmx-pmplan-userinfo");var g=[];var i=false;var c=Ext.getCmp("coverageGrid");var e=true;c.getStore().data.items.forEach(function(m,l){var k=c.getNode(l).childNodes[0].getAttribute("class");if(k.indexOf("make-cell-dirty-lt")!=-1){e=false;i=true;SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(b.T("TAG072","Add conditions to save the coverage."),7000,"success");}g.push(m.data);});if(Ext.getCmp("planName").getValue().length==0){Ext.getCmp("planName").markInvalid(b.T("TAG019","Enter PM Plan Name"));i=true;}else{f.pmPlanDataUpdates.pmPlanName=Ext.getCmp("planName").getValue();}if(Ext.getCmp("endDate").getValue()==null){Ext.getCmp("endDate").markInvalid(b.T("TAG020","Enter End Date"));i=true;}else{f.pmPlanDataUpdates.endDate=com.servicemax.client.lib.datetimeutils.DatetimeUtil.convertToTimezone(Ext.getCmp("endDate").getValue(),d.TimezoneOffset,false);}if(Ext.getCmp("startDate").getValue()==null){Ext.getCmp("startDate").markInvalid(b.T("TAG021","Enter Start Date"));i=true;}else{f.pmPlanDataUpdates.startDate=com.servicemax.client.lib.datetimeutils.DatetimeUtil.convertToTimezone(Ext.getCmp("startDate").getValue(),d.TimezoneOffset,false);}if(!i){Ext.getCmp("savePMPlanBtn").setDisabled(true);var h=Ext.getCmp("planTemplateName").getValue();f.pmPlanDataUpdates.pmPlanTemplateId=(h!=="NONE")?h:null;f.pmPlanDataUpdates.serviceContractId=Ext.getCmp("serviceContractName").getValue();f.pmPlanDataUpdates.selectedCovergaeType=Ext.getCmp("coverageTypeName").getValue();f.pmPlanDataUpdates.conditionType=Ext.getCmp("conditionTypeCombo").getValue();f.pmPlanDataUpdates.slaId=Ext.getCmp("slaTermsName").getValue();f.pmPlanDataUpdates.accountId=Ext.getCmp("accountName").getValue();f.pmPlanDataUpdates.locationId=Ext.getCmp("locationName").getValue();f.pmPlanDataUpdates.description=Ext.getCmp("description").getValue();f.pmPlanDataUpdates.selectedScheduleType=Ext.getCmp("scheduleTypeName").getValue();f.pmPlanDataUpdates.coverageList=g;f.pmPlanDataUpdates.pmPlanId=this.__engine.__pmplanData.pmPlanRecord.pmPlanId;f.pmPlanDataUpdates.pmTemplateDetail=this.__engine.__pmplanData.pmPlanRecord.pmTemplateDetail;f.pmPlanDataUpdates.pmTemplateDetail.workOrderPurpose=Ext.getCmp("WOPurpose").getValue();f.pmPlanDataUpdates.pmTemplateDetail.activityDate=Ext.getCmp("activityDate").getValue();f.pmPlanDataUpdates.woPurposeId=Ext.getCmp("WOPurpose").getValue();f.pmPlanDataUpdates.selectedActivityDate=Ext.getCmp("activityDate").getValue();f.pmPlanDataUpdates.activatePMPlan=this.__engine.__pmplanData.pmPlanRecord.activatePMPlan;f.pmPlanDataUpdates.pmPlanMappedValues=this.__engine.__pmplanData.pmPlanRecord.pmPlanMappedValues;this.__engine.savePMPlan(f,function(l){if(l.success&&j=="button"){var k="/"+l.pmPlanRecord.pmPlanId;if((typeof sforce!="undefined")&&(sforce!=null)){sforce.one.navigateToURL(k);}else{window.location=k;}}else{SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(Ext.String.htmlEncode(l.messageList[0]),7000,"success");}Ext.getCmp("savePMPlanBtn").setDisabled(false);});}}});};})();(function(){var a=SVMX.Package("com.servicemax.client.pmplan.ui.desktop.api.conditionrule");a.init=function(){var b=SVMX.getClient().getServiceRegistry().getServiceInstance("com.servicemax.client.translation").getDictionary("PMPLAN");Ext.define("com.servicemax.client.pmplan.ui.desktop.api.ConditionrulePanel",{extend:"com.servicemax.client.ui.components.composites.impl.SVMXWindow",layout:"anchor",height:"100%",border:false,header:{titleAlign:"center",height:40,},style:"background-color: #FFFFFF;",hidden:true,width:"65%",height:"80%",layout:"anchor",closable:false,closeAction:"hide",resizable:false,autoScroll:true,cls:"pmplan-window-container",id:"conditionrule",listeners:{hide:function(d,c){d.hide();d.__parent.enable();}},constructor:function(c){this.callParent([c]);},initComponent:function(){this.callParent(arguments);var m=this;var o=Ext.create("Ext.data.Store",{storeId:"field_list_store",fields:["fieldApiName","fieldLabel","dataType","category","attributeType"],groupField:"category",});
var n=Ext.create("Ext.data.Store",{storeId:"Field_List_Store_CB",fields:["fieldApiName","fieldLabel","dataType","category","attributeType"],groupField:"category",});var i=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXLabel",{html:"<span>"+b.T("TAG064","Condition Rule:")+"</span>",style:"position: relative; top: 10px; margin: 10px 10px 0px 12px",padding:"5 5 5 4",cls:"pmplan-grid-title"});m.add(i);this.__conditionRulegrid=SVMX.create("com.servicemax.client.pmplan.ui.desktop.conditionRule.ConditionRuleGrid",{__fieldStore:o});this.add(this.__conditionRulegrid);this.__conditionRulegridCB=SVMX.create("com.servicemax.client.pmplan.ui.desktop.conditionRule.ConditionRuleGridCriteria",{__fieldStore:n});this.add(this.__conditionRulegridCB);var h=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXText",{id:"advExp",name:"advExp",labelAlign:"top",fieldLabel:b.T("TAG030","Advanced Expression"),labelSeparator:"",margin:"0 15 10 15",width:"calc(100% - 30px)",});m.add(h);var e=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXLabel",{html:"<span>"+b.T("TAG065",'If you have defined new conditions or changed existing ones, please click "Run schedule" to regenerate schedules for the updated conditions.')+"</span>",margin:"0 15 0",});m.add(e);var k=SVMX.create("com.servicemax.client.ui.components.composites.impl.SVMXSection",{layout:"hbox",collapsible:false,border:false,header:false,id:"scheduleSec",cls:"img-header-default",});var j=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXLabel",{html:"<span>"+b.T("TAG066","Scheduled Output:")+"</span>",cls:"pmplan-grid-title"});var g=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXButton",{text:b.T("TAG067","Run Schedule"),cls:"pmplan-schedule-link",disabled:true,id:"scheduleLink",style:"top: 14px !important",handler:function(x,y){var C=SVMX.getClient().getApplicationParameter("svmx-pmplan-userinfo");var z={};z.conditionRuleList=[];z.coverageId=Ext.getCmp("conditionrule").__covergaeId;z.runScheduleCoverageId=Ext.getCmp("conditionrule").__runScheduleCoverageId;var B=[];z.conditionRuleList=m.validateConditionRule();z.pmPlanRecord={};z.pmPlanRecord.conditionType=Ext.getCmp("conditionTypeCombo").getValue();var q=Ext.getCmp("startDate").getValue();var w=Ext.getCmp("endDate").getValue();var v=Ext.getCmp("conditionrule");if(q!=null){z.pmPlanRecord.startDate=com.servicemax.client.lib.datetimeutils.DatetimeUtil.convertToTimezone(Ext.getCmp("startDate").getValue(),C.TimezoneOffset,false);}if(w!=null){z.pmPlanRecord.endDate=com.servicemax.client.lib.datetimeutils.DatetimeUtil.convertToTimezone(Ext.getCmp("endDate").getValue(),C.TimezoneOffset,false);}z.advancedExpression=Ext.getCmp("advExp").getValue();if(z.conditionRuleList!=null&&z.conditionRuleList.length>0&&(z.advancedExpression==""||z.advancedExpression==null)){z.advancedExpression=m.__parent.advancedExp(z.conditionRuleList.length);}z.workOrderPurposeId=Ext.getCmp("WOPurpose").getValue();z.pmPlanRecord.pmTemplateDetail={};z.pmPlanRecord.pmTemplateDetail.conditionRuleList=z.conditionRuleList;if(z.pmPlanRecord.conditionType==="Criteria_Comparison"&&z.conditionRuleList!=null&&z.conditionRuleList.length>0){var A=Ext.data.StoreManager.lookup("Field_List_Store_CB");for(var s=0;s<z.conditionRuleList.length;s++){var u=z.conditionRuleList[s].selectedField;var r=A.findRecord("fieldApiName",u,0,false,true,true);var t=r.getData().fieldLabel;z.conditionRuleList[s].selectedFieldLabel=t;}}if(z.conditionRuleList!=null&&z.conditionRuleList!=""){var p={};p.conditionRuleList=z.conditionRuleList;p.advancedExpression=z.advancedExpression;m.__engine.validateExpression(p,function(D){if(D.success){v.__engine.getCoverageScheduleData(z,function(F){if(F.success){var E=F.scheduleList;var G=Ext.getStore("schedule_op_store");G.loadData(E);Ext.getCmp("advExp").setValue(p.advancedExpression);}else{SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(F.messageList[0],7000,"success");}});}else{SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(D.messageList[0],7000,"success");}});}}});k.add(j);k.add(g);m.add(k);this.__scheduleGrid=SVMX.create("com.servicemax.client.pmplan.ui.desktop.conditionRule.ScheduleGrid",{});m.add(this.__scheduleGrid);var d=SVMX.create("com.servicemax.client.ui.components.composites.impl.SVMXToolbar",{width:"100%",dock:"bottom",style:"margin-top: 20px",border:false,});var c=SVMX.create("Ext.Toolbar.Fill",{});d.add(c);var l=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXButton",{text:b.T("TAG022","Cancel"),scale:"medium",height:30,cls:"pmplan-cancel-btn",handler:function(){m.cancelAction();}});var f=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXButton",{text:b.T("TAG023","Save"),scale:"medium",margin:"0 10 0 10",height:30,id:"saveConditionRuleBtn",cls:"pmplan-save-btn",handler:function(q,u){var p=m.validateConditionRule();var v=m.__scheduleGrid.getStore().data.items;
var t=Ext.getCmp("coverageGrid");var s=[];v.forEach(function(x,w){s.push(x.data);});if(p!=null&&p!=""){var r={};r.conditionRuleList=p;r.advancedExpression=Ext.getCmp("advExp").getValue();if(r.advancedExpression==""||r.advancedExpression==null){r.advancedExpression=m.__parent.advancedExp(p.length);}m.__engine.validateExpression(r,function(w){if(w.success){if(s&&s.length===0){SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(b.T("TAG081","No PM Schedules have been generated for this coverage. This may be due to an issue with the Condition Rules. Please Review."),7000,"success");}else{t.getStore().data.items[m.__recordIndex].data.conditionRuleList=p;t.getStore().data.items[m.__recordIndex].data.scheduleList=s;t.getStore().data.items[m.__recordIndex].data.advancedExpression=r.advancedExpression;if(p!=null&&p!=""&&p.length>0){var x=t.getNode(m.__recordIndex).childNodes[0].getAttribute("class");if(x.indexOf("make-cell-dirty-lt")!=-1){t.getNode(m.__recordIndex).childNodes[0].setAttribute("class",x.replace("make-cell-dirty-lt","").trim());t.getNode(m.__recordIndex).childNodes[0].removeAttribute("data-errorqtip");}}var y=Ext.getCmp("conditionTypeCombo").getValue();m.__parent.__changeevent=true;if(y==="Usage_Frequency"){m.__conditionRulegrid.getStore().removeAll();Ext.getCmp("addRowButton").setDisabled(false);}else{if(y==="Criteria_Comparison"){m.__conditionRulegridCB.getStore().removeAll();Ext.getCmp("addRowButton_CB").setDisabled(false);}}Ext.getCmp("scheduleLink").setDisabled(true);Ext.getCmp("conditionTypeCombo").setReadOnly(true);m.hide();m.__parent.enable();}}else{SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(w.messageList[0],7000,"success");}});}else{SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(b.T("TAG072","Add conditions to save the coverage."),7000,"success");}}});d.add(l);d.add(f);m.add(d);},loadStore:function(u,p,l,B){this.__conditionRuleGridOldVal=u;var A=B;var d=[];for(var y=0;y<A.length;y++){var v=A[y].key;var o=A[y].lstOfKeyValue;for(var x=0;x<o.length;x++){var e=SVMX.sanitizeHTML(o[x].value);var f={fieldApiName:o[x].key,fieldLabel:e,dataType:o[x].dataType,category:v,attributeType:o[x].attrType};d.push(f);}}var h=Ext.getCmp("conditionTypeCombo").getValue();var s;if(h===""||h==="Usage_Frequency"){var w=Ext.getStore("field_list_store");s=Ext.getStore("condition_rule_store");if(u!=null&&u.length>0){var r=u;var q=r.length;for(var y=0;y<r.length;y++){var k;var t=r[y].selectedFreqUnit;var g=r[y].selectedField;if(t==="Count"){k=g;}else{k=t;}r[y].selectedField=k;if(k==="Weeks"||k==="Months"||k==="Years"){if(r[y].startAt!==null&&r[y].startAt!==""){var z=r[y].startAt.split("-");r[y].startAt=new Date(z[0],parseInt(z[1])-1,z[2]);}if(r[y].stopAt!==null&&r[y].stopAt!==""){z=r[y].stopAt.split("-");r[y].stopAt=new Date(z[0],parseInt(z[1])-1,z[2]);}}r[y].isRowHasError=false;}if(q>=5){Ext.getCmp("addRowButton").setDisabled(true);}}w.loadData(d);this.__conditionRulegrid.setVisible(true);this.__conditionRulegridCB.setVisible(false);Ext.getCmp("scheduleOPGrid").columns[3].setVisible(true);}else{if(h==="Criteria_Comparison"){s=Ext.getStore("Condition_Rule_Store_CB");var q=u.length;for(var y=0;y<q;y++){u[y].isRowHasError=false;}if(q>=5){Ext.getCmp("addRowButton_CB").setDisabled(true);}this.__conditionRulegrid.setVisible(false);this.__conditionRulegridCB.setVisible(true);Ext.getCmp("scheduleOPGrid").columns[3].setVisible(false);}}s.loadData(u);if(u.length>0){Ext.getCmp("scheduleLink").setDisabled(false);}var n=Ext.getStore("schedule_op_store");n.loadData(p);var c=Ext.getStore("workOrderPurposeStore");c.loadData(this.__engine.__pmplanData.pmPlanRecord.woPurposeList);var m=Ext.getCmp("advExp");m.setValue(l);},loadAttributeStoreForCriteria:function(h){var n=h;var p=[];var q=[];for(var g=0;g<n.length;g++){var c=n[g].key;var d=n[g].lstOfKeyValue;for(var f=0;f<d.length;f++){var m={fieldApiName:d[f].key,fieldLabel:d[f].value,dataType:d[f].dataType,category:c,attributeType:d[f].attrType};q.push(m);if(d[f].dataType.toUpperCase()==="PICKLIST"){var o=d[f].lstValues||[];for(var e=0;e<o.length;e++){var l={fieldApiName:d[f].key,label:o[e].label,value:o[e].value};p.push(l);}}}}Ext.getStore("Field_List_Store_CB").loadData(q);Ext.getStore("TA_PA_Store").loadData(p);},validateConditionRule:function(){var d=false;var u=false;var r=false;var j=SVMX.getClient().getApplicationParameter("svmx-pmplan-userinfo");var e=[];var f=Ext.getCmp("conditionTypeCombo").getValue();if(f==="Usage_Frequency"){var p=this.__conditionRulegrid.getStore().data.items;var q=Ext.getStore("field_list_store");for(var t=0;t<p.length;t++){if(!d){if(p[t].data.isRowHasError===true||p[t].data.isRowHasError===""){d=true;}}if(!u){var l=p[t].data.selectedField;if(l!=null&&l!=""){var c=q.findExact("fieldApiName",l);if(c===-1){u=true;}}}if(!r){var l=p[t].data.selectedField;var m=p[t].data.selectedOperator;var g=p[t].data.frequency;if(l===null||l===""){r=true;}else{if(m===null||m===""){r=true;
}else{if(g===null||g===""){r=true;}}}}}if(u){SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(b.T("TAG031","There is a mismatch between the product and attribute chosen. Please choose the correct attribute and save."),7000,"success");return;}else{if(r){SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(b.T("TAG032","Please fill the values for the following columns in Condition Rule list: Field, Operator and Frequency"),7000,"success");return;}else{if(d){SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(b.T("TAG033","One or more conditions is invalid. Please review the conditions and save"),7000,"success");return;}}}for(var t=0;t<p.length;t++){var s=JSON.parse(JSON.stringify(p[t].data));var l=p[t].data.selectedField;var o;var h;if(l==="Weeks"||l==="Months"||l==="Years"){h="";o=l;s.fieldDataType="Date";}else{h=l;o="Count";}var k=q.findRecord("fieldApiName",h,0,false,true,true);s.selectedField=h;s.selectedFreqUnit=o;if(k!=null){s.fieldAttType=k.getData().attributeType;s.fieldDataType=k.getData().dataType;}if(o==="Count"){s.startAt=p[t].data.startAt;s.stopAt=p[t].data.stopAt;}else{if(p[t].data.startAt!=null&&p[t].data.startAt!=""){s.startAt=com.servicemax.client.lib.datetimeutils.DatetimeUtil.convertToTimezone(p[t].data.startAt,j.TimezoneOffset,false).substring(0,10);}if(p[t].data.stopAt!=null&&p[t].data.stopAt!=""){s.stopAt=com.servicemax.client.lib.datetimeutils.DatetimeUtil.convertToTimezone(p[t].data.stopAt,j.TimezoneOffset,false).substring(0,10);}}e.push(s);}}else{if(f==="Criteria_Comparison"){var p=this.__conditionRulegridCB.getStore().data.items;var n=Ext.data.StoreManager.lookup("Field_List_Store_CB");var u=false;var r=false;for(var t=0;t<p.length;t++){if(!u){var l=p[t].data.selectedField;if(l!=null&&l!=""){var c=n.findExact("fieldApiName",l);if(c===-1){u=true;}}}if(!r){var l=p[t].data.selectedField;var m=p[t].data.selectedOperator;var g=p[t].data.value;if(l===null||l===""){r=true;}else{if(m===null||m===""){r=true;}else{if(g===null||g===""){r=true;}}}}}if(u){SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(b.T("TAG031","There is a mismatch between the product and attribute chosen. Please choose the correct attribute and save."),7000,"success");return;}else{if(r){SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(b.T("TAG076","Please fill values for the following columns in Condition Rule : Attribute, Operator and Value"),7000,"success");return;}}for(var t=0;t<p.length;t++){var s=JSON.parse(JSON.stringify(p[t].data));var h=p[t].data.selectedField;var k=n.findRecord("fieldApiName",h,0,false,true,true);s.selectedField=h;s.fieldAttType=k.getData().attributeType;s.fieldDataType=k.getData().dataType;if(s.fieldDataType==="DATE"){if(p[t].data.value!=null&&p[t].data.value!=""){s.value=com.servicemax.client.lib.datetimeutils.DatetimeUtil.convertToTimezone(p[t].data.value,j.TimezoneOffset,false).substring(0,10);}}e.push(s);}}}return e;},cancelAction:function(){var c=this.__conditionRuleGridOldVal;var l=SVMX.getClient().getApplicationParameter("svmx-pmplan-userinfo");var g=Ext.getCmp("conditionTypeCombo").getValue();if(g==="Usage_Frequency"){for(var f=0;f<c.length;f++){if(c[f].selectedFreqUnit!="Count"){if(c[f].startAt!=null&&c[f].startAt!=""){c[f].startAt=com.servicemax.client.lib.datetimeutils.DatetimeUtil.convertToTimezone(c[f].startAt,l.TimezoneOffset,false).substring(0,10);}if(c[f].stopAt!=null&&c[f].stopAt!=""){c[f].stopAt=com.servicemax.client.lib.datetimeutils.DatetimeUtil.convertToTimezone(c[f].stopAt,l.TimezoneOffset,false).substring(0,10);}}}this.__conditionRulegrid.getStore().removeAll();Ext.getCmp("addRowButton").setDisabled(false);}else{if(g==="Criteria_Comparison"){var j=Ext.data.StoreManager.lookup("Field_List_Store_CB");for(var f=0;f<c.length;f++){var h=c[f].selectedField;var d=j.findRecord("fieldApiName",h,0,false,true,true);var k=d.getData().dataType;if(k==="DATE"){if(c[f].value!=null&&c[f].value!=""){c[f].value=com.servicemax.client.lib.datetimeutils.DatetimeUtil.convertToTimezone(c[f].value,l.TimezoneOffset,false).substring(0,10);}}}this.__conditionRulegridCB.getStore().removeAll();Ext.getCmp("addRowButton_CB").setDisabled(false);}}var e=Ext.getCmp("coverageGrid");if(e.getStore().data.items[this.__recordIndex].data.conditionRuleList!=null&&e.getStore().data.items[this.__recordIndex].data.conditionRuleList.length>0){e.getStore().data.items[this.__recordIndex].data.conditionRuleList=c;}else{e.getStore().data.items[this.__recordIndex].data.conditionRuleList=null;}Ext.getCmp("scheduleLink").setDisabled(true);this.hide();this.__parent.enable();}});Ext.define("com.servicemax.client.pmplan.ui.desktop.conditionRule.GroupComboBox",{extend:"com.servicemax.client.ui.components.controls.impl.SVMXPicklist",groupField:"group",listConfig:{cls:"grouped-list",getInnerTpl:function(c){return"{[Ext.String.htmlEncode(values."+c+")]}";}},initComponent:function(){var c=this;
c.tpl=new Ext.XTemplate(["{[this.currentGroup = null]}",'<tpl for=".">','   <tpl if="this.shouldShowHeader('+c.groupField+')">','       <div class="group-header">{[this.showHeader(values.'+c.groupField+")]}</div>","   </tpl>",'   <div class="svmx-boundlist-item">{'+c.displayField+"}</div>","</tpl>",{shouldShowHeader:function(d){return this.currentGroup!=d;},showHeader:function(d){this.currentGroup=d;return d;}}]);c.callParent(arguments);}});Ext.define("com.servicemax.client.pmplan.ui.desktop.conditionRule.ConditionRuleGrid",{extend:"com.servicemax.client.ui.components.composites.impl.SVMXListComposite",xtype:"cell-editing",frame:true,__fieldStore:null,__rowData:null,viewConfig:{markDirty:false},initComponent:function(){this.fieldCombo=new SVMX.create("com.servicemax.client.pmplan.ui.desktop.conditionRule.GroupComboBox",{id:"fieldComboCmp",typeAhead:true,queryMode:"local",triggerAction:"all",selectOnTab:true,store:this.__fieldStore,displayField:"fieldLabel",valueField:"fieldApiName",groupField:"category",editable:false});var c=Ext.create("Ext.data.Store",{fields:["label","value","type"],data:{items:[{label:b.T("TAG034","Every"),value:"EYI",type:"Date"},{label:b.T("TAG035","Every decrement"),value:"EYD",type:"Number"}]},proxy:{type:"memory",reader:{type:"json",root:"items"}}});this.operatorCombo=new Ext.form.field.ComboBox({id:"operatorComboCmp",typeAhead:true,triggerAction:"all",queryMode:"local",selectOnTab:true,displayField:"label",valueField:"value",editable:false,store:c,listConfig:{getInnerTpl:function(e){return"{[Ext.String.htmlEncode(values."+e+")]}";}},__parent:this,listeners:{expand:function(f){var e=f.__parent.__rowData.selectedField;if(e!==null&&e!==""){if(e==="Months"||e==="Weeks"||e==="Years"){f.store.filter("type","Date");}}}}});this.adjustmentTypeCombo=new Ext.form.field.ComboBox({typeAhead:true,triggerAction:"all",selectOnTab:true,editable:false,queryMode:"local",store:[["None",b.T("COMM_TAG004","--None--")],["Actual",b.T("TAG036","Actual")],["Fixed",b.T("TAG037","Fixed")]],listConfig:{getInnerTpl:function(e){return"{[Ext.String.htmlEncode(values."+e+")]}";}},});var d=Ext.create("Ext.data.Store",{fields:["label","value","type"],data:{items:[{label:b.T("TAG038","Days"),value:"Days",type:"Date"},{label:b.T("TAG039","Count"),value:"Count",type:"Number"}]},proxy:{type:"memory",reader:{type:"json",root:"items"}}});this.adjustmentUnitCombo=new Ext.form.field.ComboBox({id:"adjustmentUnitComboCmp",displayField:"label",valueField:"value",queryMode:"local",typeAhead:true,triggerAction:"all",selectOnTab:true,editable:false,store:d,listConfig:{getInnerTpl:function(e){return"{[Ext.String.htmlEncode(values."+e+")]}";}},__parent:this,listeners:{expand:function(f){var e=f.__parent.__rowData.selectedField;if(e!==null&&e!==""){if(e==="Months"||e==="Weeks"||e==="Years"){f.store.filter("type","Date");}else{f.store.filter("type","Number");}}}}});this.cellEditing=new Ext.grid.plugin.CellEditing({clicksToEdit:1,__parent:this,listeners:{beforeedit:function(g,h){this.__parent.__rowData=h.record.data;var i=Ext.getCmp("adjustmentUnitComboCmp");i.store.clearFilter();var f=Ext.getCmp("operatorComboCmp");f.store.clearFilter();},edit:function(m,n){if(n.field==="selectedAdjustmentType"&&(n.value==="None")&&(n.value!==n.originalValue)){n.record.set("minAdjustment","");n.record.set("maxAdjustment","");n.record.set("adjustmentVal","");n.record.set("selectedAdjustedUnit","");}if(n.field==="selectedAdjustmentType"&&(n.value==="Actual")&&(n.value!==n.originalValue)){n.record.set("adjustmentVal","");}if(n.field==="selectedField"){if((n.value==="Weeks"||n.value==="Months"||n.value==="Years")&&(n.originalValue!==""&&n.originalValue!=="Weeks"&&n.originalValue!=="Months"&&n.originalValue!=="Years")){n.record.set("startAt","");n.record.set("stopAt","");n.record.set("threshold","");n.record.set("frequency","");n.record.set("selectedOperator","");n.record.set("selectedAdjustedUnit","");}else{if((n.value!=="Weeks"&&n.value!=="Months"&&n.value!=="Years")&&(n.originalValue!==""&&(n.originalValue==="Weeks"||n.originalValue==="Months"||n.originalValue==="Years"))){n.record.set("startAt","");n.record.set("stopAt","");n.record.set("frequency","");n.record.set("selectedOperator","");n.record.set("selectedAdjustedUnit","");}}}if(n.record.data.selectedOperator=="EYI"&&(n.record.data.stopAt===""||n.record.data.stopAt===null)){var i=n.row.childNodes[7];var f=i.firstChild.getAttribute("class");if(f.indexOf("make-cell-dirty")===-1){i.firstChild.setAttribute("class",f+" make-cell-dirty ");i.firstChild.setAttribute("data-qtip",b.T("TAG040","This is a required field."));}}if(n.record.data.selectedOperator=="EYD"&&(n.record.data.startAt===""||n.record.data.startAt===null)){var i=n.row.childNodes[5];var f=i.firstChild.getAttribute("class");if(f.indexOf("make-cell-dirty")===-1){i.firstChild.setAttribute("class",f+" make-cell-dirty ");i.firstChild.setAttribute("data-qtip",b.T("TAG040","This is a required field."));}}if(n.record.data.selectedAdjustmentType==="Fixed"&&(n.record.data.adjustmentVal===""||n.record.data.adjustmentVal===null)){var i=n.row.childNodes[11];
var f=i.firstChild.getAttribute("class");if(f.indexOf("make-cell-dirty")===-1){i.firstChild.setAttribute("class",f+" make-cell-dirty ");i.firstChild.setAttribute("data-qtip",b.T("TAG040","This is a required field."));}}else{if(n.record.data.selectedAdjustmentType!=="Fixed"){var i=n.row.childNodes[11];var f=i.firstChild.getAttribute("class");if(f.indexOf("make-cell-dirty")!==-1){i.firstChild.setAttribute("class",f.replace("make-cell-dirty","").trim());}}}if(n.record.data.selectedOperator=="EYI"&&(n.record.data.startAt!==""&&n.record.data.startAt!==null)&&(n.record.data.stopAt!==""&&n.record.data.stopAt!==null)){var k=false;if((n.record.data.selectedField==="Months"||n.record.data.selectedField==="Weeks"||n.record.data.selectedField==="Years")&&n.record.data.stopAt<n.record.data.startAt){k=true;}else{if((n.record.data.selectedField!=="Months"&&n.record.data.selectedField!=="Weeks"&&n.record.data.selectedField!=="Years")&&parseFloat(n.record.data.stopAt)<parseFloat(n.record.data.startAt)){k=true;}}if(k){var i=n.row.childNodes[7];var f=i.firstChild.getAttribute("class");if(f.indexOf("make-cell-dirty")===-1){i.firstChild.setAttribute("class",f+" make-cell-dirty ");i.firstChild.setAttribute("data-qtip",b.T("TAG041","Stop At cannot be less than Start At."));}}}if((n.record.data.selectedField!=="Months"&&n.record.data.selectedField!=="Weeks"&&n.record.data.selectedField!=="Years")&&n.record.data.selectedOperator=="EYD"&&(n.record.data.startAt!==""&&n.record.data.startAt!==null)&&(n.record.data.stopAt!==""&&n.record.data.stopAt!==null)&&parseFloat(n.record.data.stopAt)>parseFloat(n.record.data.startAt)){var i=n.row.childNodes[5];var f=i.firstChild.getAttribute("class");if(f.indexOf("make-cell-dirty")===-1){i.firstChild.setAttribute("class",f+" make-cell-dirty ");i.firstChild.setAttribute("data-qtip",b.T("TAG041","Start At cannot be less than Stop At."));}}if(n.record.data.selectedField!==null&&n.record.data.selectedField!==""){var i=n.row.childNodes[7];var f=i.firstChild.getAttribute("class");var s=i.firstChild.getAttribute("data-qtip");if(f.indexOf("make-cell-dirty")===-1&&s!==null&&s.length>0){i.firstChild.removeAttribute("data-qtip");}}if(n.record.data.selectedField!=="Weeks"&&n.record.data.selectedField!=="Months"&&n.record.data.selectedField!=="Years"){var i=n.row.childNodes[5];var f=i.firstChild.getAttribute("class");var s=i.firstChild.getAttribute("data-qtip");if(f.indexOf("make-cell-dirty")===-1&&s!==null&&s.length>0){i.firstChild.removeAttribute("data-qtip");}}if(n.record.data.selectedAdjustmentType==="Fixed"&&(n.record.data.adjustmentVal!==""&&n.record.data.adjustmentVal!==null)){var i=n.row.childNodes[11];var f=i.firstChild.getAttribute("class");var s=i.firstChild.getAttribute("data-qtip");if(f.indexOf("make-cell-dirty")===-1&&s!==null&&s.length>0){i.firstChild.removeAttribute("data-qtip");}}var t;var l;var j=false;var h=n.row.childNodes[5];var u=h.firstChild.getAttribute("class");if(u.indexOf("make-cell-dirty")!==-1){j=true;t=h;l=u;}var g=n.row.childNodes[7];var p=g.firstChild.getAttribute("class");if(p.indexOf("make-cell-dirty")!==-1){j=true;t=g;l=p;}var r=n.row.childNodes[11];var o=r.firstChild.getAttribute("class");if(o.indexOf("make-cell-dirty")!==-1){j=true;t=r;l=o;}if(j){n.record.set("isRowHasError",true);t.firstChild.setAttribute("class",l.replace("make-cell-dirty","").trim());t.firstChild.setAttribute("class",t.firstChild.getAttribute("class")+" make-cell-dirty ");var q=n.row.childNodes[0];var v=q.firstChild.getAttribute("class");if(v.indexOf("make-cell-dirty")===-1){q.firstChild.setAttribute("class",v+" make-cell-dirty ");q.firstChild.setAttribute("data-qtip",b.T("TAG042","This row has one or more issues. Please correct before proceeding"));}}else{n.record.set("isRowHasError",false);var q=n.row.childNodes[0];var v=q.firstChild.getAttribute("class");var s=q.firstChild.getAttribute("data-qtip");if(v.indexOf("make-cell-dirty")!==-1&&s!==null&&s.length>0){q.firstChild.removeAttribute("data-qtip");q.firstChild.setAttribute("class",v.replace("make-cell-dirty","").trim());}}}}});this.comboBoxRenderer=function(e){return function(g){var f=e.store.find(e.valueField,g);var h=e.store.getAt(f);return((h===null||h===undefined)?"":h.get(e.displayField));};};Ext.apply(this,{width:"60%",autoScroll:true,maxHeight:450,id:"conditionRuleGrid",margin:"10 10 30",plugins:[this.cellEditing],store:new Ext.data.Store({storeId:"condition_rule_store",fields:["isRowHasError","conditionRuleId","sequence","selectedField","selectedOperator","frequency","startAt","threshold","stopAt","selectedAdjustmentType","minAdjustment","maxAdjustment","adjustmentVal","selectedAdjustedUnit","fieldAttType","fieldDataType","selectedFreqUnit",]}),columns:[{xtype:"actioncolumn",width:40,height:40,align:"center",sortable:false,menuDisabled:true,items:[{iconCls:"pmplan-delete-row-icon",tooltip:b.T("TAG043","Delete"),scope:this,height:40,handler:this.onRemoveClick}]},{header:b.T("TAG044","Sequence"),dataIndex:"sequence",width:80,height:40,align:"center"},{header:b.T("TAG045","Field"),dataIndex:"selectedField",width:150,height:40,align:"center",sortable:false,menuDisabled:true,editor:this.fieldCombo,renderer:this.comboBoxRenderer(this.fieldCombo)},{header:b.T("TAG046","Operator"),dataIndex:"selectedOperator",width:120,height:40,align:"center",sortable:false,menuDisabled:true,renderer:this.comboBoxRenderer(this.operatorCombo),__parent:this,getEditor:function(e){var f=e.data.selectedField;
if(f!==null&&f!==""){return this.__parent.operatorCombo;}}},{header:b.T("TAG047","Frequency"),dataIndex:"frequency",width:100,height:40,align:"center",sortable:false,menuDisabled:true,getEditor:function(e){var f=e.data.selectedField;if(f!==null&&f!==""){if(f==="Weeks"||f==="Months"||f==="Years"){return Ext.create("Ext.grid.CellEditor",{field:Ext.create("Ext.form.field.Number",{minValue:1,allowDecimals:false,nanText:b.T("TAG080","Enter a valid number"),})});}else{return Ext.create("Ext.grid.CellEditor",{field:Ext.create("Ext.form.field.Number",{minValue:0.1,enableKeyEvents:true,nanText:b.T("TAG080","Enter a valid number"),listeners:{keypress:function(i,h){var g=i.getValue();if(!Ext.isEmpty(g)){if(/\.\d{2,}/.test(g)){h.stopEvent();}}}}})});}}}},{header:b.T("TAG048","Start At"),dataIndex:"startAt",width:120,height:40,align:"center",sortable:false,menuDisabled:true,renderer:function(l,e,i,f,h,m){if(l!=null&&l!=""&&(i.data.selectedField==="Weeks"||i.data.selectedField==="Months"||i.data.selectedField==="Years")){var g=new Date(l);var j=("0"+(g.getMonth()+1)).slice(-2);var k=("0"+g.getDate()).slice(-2);return[j,k,g.getFullYear()].join("-");}else{return l;}},getEditor:function(e){var g=e.data.selectedField;if(g==="Weeks"||g==="Months"||g==="Years"){var f=Ext.create("Ext.form.field.Date",{format:"m-d-Y",value:Ext.Date.dateFormat(e.data.startAt,"m-d-Y"),invalidText:b.T("TAG079","Enter a valid date")});return Ext.create("Ext.grid.CellEditor",{field:f});}else{return Ext.create("Ext.grid.CellEditor",{field:Ext.create("Ext.form.field.Number",{minValue:0,enableKeyEvents:true,nanText:b.T("TAG080","Enter a valid number"),listeners:{keypress:function(j,i){var h=j.getValue();if(!Ext.isEmpty(h)){if(/\.\d{2,}/.test(h)){i.stopEvent();}}}}})});}}},{header:b.T("TAG049","Threshold %"),dataIndex:"threshold",width:100,height:40,align:"center",sortable:false,menuDisabled:true,getEditor:function(e){var f=e.data.selectedField;if(f!=="Weeks"&&f!=="Months"&&f!=="Years"){return Ext.create("Ext.grid.CellEditor",{field:Ext.create("Ext.form.field.Number",{minValue:0,allowDecimals:false,nanText:b.T("TAG080","Enter a valid number"),})});}}},{header:b.T("TAG050","Stop At"),dataIndex:"stopAt",width:120,height:40,align:"center",sortable:false,menuDisabled:true,renderer:function(l,e,i,f,h,m){if(l!=null&&l!=""&&(i.data.selectedField==="Weeks"||i.data.selectedField==="Months"||i.data.selectedField==="Years")){var g=new Date(l);var j=("0"+(g.getMonth()+1)).slice(-2);var k=("0"+g.getDate()).slice(-2);return[j,k,g.getFullYear()].join("-");}else{return l;}},getEditor:function(e){var g=e.data.selectedField;if(g==="Weeks"||g==="Months"||g==="Years"){var f=Ext.create("Ext.form.field.Date",{format:"m-d-Y",value:Ext.Date.dateFormat(e.data.stopAt,"m-d-Y"),invalidText:b.T("TAG079","Enter a valid date")});return Ext.create("Ext.grid.CellEditor",{field:f});}else{return Ext.create("Ext.grid.CellEditor",{field:Ext.create("Ext.form.field.Number",{minValue:0,enableKeyEvents:true,nanText:b.T("TAG080","Enter a valid number"),listeners:{keypress:function(j,i){var h=j.getValue();if(!Ext.isEmpty(h)){if(/\.\d{2,}/.test(h)){i.stopEvent();}}}}})});}}},{header:b.T("TAG051","Adjustment Type"),dataIndex:"selectedAdjustmentType",width:110,align:"center",sortable:false,menuDisabled:true,editor:this.adjustmentTypeCombo,renderer:this.comboBoxRenderer(this.adjustmentTypeCombo)},{header:b.T("TAG052","Minimum Adjustment"),dataIndex:"minAdjustment",width:120,height:40,align:"center",sortable:false,menuDisabled:true,getEditor:function(e){var f=e.data.selectedAdjustmentType;if(f!==null&&f!==""&&f!=="None"){return Ext.create("Ext.grid.CellEditor",{field:Ext.create("Ext.form.field.Number",{minValue:0,enableKeyEvents:true,nanText:b.T("TAG080","Enter a valid number"),listeners:{keypress:function(i,h){var g=i.getValue();if(!Ext.isEmpty(g)){if(/\.\d{2,}/.test(g)){h.stopEvent();}}}}})});}}},{header:b.T("TAG053","Maximum Adjustment"),dataIndex:"maxAdjustment",width:120,height:40,align:"center",sortable:false,menuDisabled:true,getEditor:function(e){var f=e.data.selectedAdjustmentType;if(f!==null&&f!==""&&f!=="None"){return Ext.create("Ext.grid.CellEditor",{field:Ext.create("Ext.form.field.Number",{minValue:0,enableKeyEvents:true,nanText:b.T("TAG080","Enter a valid number"),listeners:{keypress:function(i,h){var g=i.getValue();if(!Ext.isEmpty(g)){if(/\.\d{2,}/.test(g)){h.stopEvent();}}}}})});}}},{header:b.T("TAG054","Adjustment Value"),dataIndex:"adjustmentVal",width:120,height:40,align:"center",sortable:false,menuDisabled:true,getEditor:function(e){var f=e.data.selectedAdjustmentType;if(f==="Fixed"){return Ext.create("Ext.grid.CellEditor",{field:Ext.create("Ext.form.field.Number",{minValue:0,enableKeyEvents:true,nanText:b.T("TAG080","Enter a valid number"),listeners:{keypress:function(i,h){var g=i.getValue();if(!Ext.isEmpty(g)){if(/\.\d{2,}/.test(g)){h.stopEvent();}}}}})});}}},{header:b.T("TAG055","Adjustment Unit"),dataIndex:"selectedAdjustedUnit",width:120,height:40,align:"center",sortable:false,menuDisabled:true,renderer:this.comboBoxRenderer(this.adjustmentUnitCombo),__parent:this,getEditor:function(e){var g=e.data.selectedAdjustmentType;
var f=e.data.selectedField;if(g!==null&&g!==""&&g!=="None"&&f!==null&&f!==""){return this.__parent.adjustmentUnitCombo;}}}],selModel:{selType:"cellmodel"},bbar:[{text:"+ "+b.T("TAG056","Add Row"),id:"addRowButton",scope:this,handler:this.onAddClick,cls:"pmplan-blue-link"}]});this.callParent();},onAddClick:function(d){var c=this.getStore().getCount();var e={sequence:c+1,isRowHasError:false};if(c<5){this.getStore().insert(c,e);if(c==4){d.setDisabled(true);}}if(this.getStore().getCount()>0){Ext.getCmp("scheduleLink").setDisabled(false);}else{Ext.getCmp("scheduleLink").setDisabled(true);}},onRemoveClick:function(d,h,c,g){var k=this.getStore();k.removeAt(h);var l=k.getCount();for(var f=h;f<l;f++){var e=k.getAt(f);e.set("sequence",f+1);}var j=Ext.getCmp("addRowButton");if(l<5&&j.isDisabled()){j.setDisabled(false);}if(this.getStore().getCount()>0){Ext.getCmp("scheduleLink").setDisabled(false);}else{Ext.getCmp("scheduleLink").setDisabled(true);}}});Ext.define("com.servicemax.client.pmplan.ui.desktop.conditionRule.ScheduleGrid",{extend:"com.servicemax.client.ui.components.composites.impl.SVMXListComposite",xtype:"cell-editing",emptyText:b.T("TAG057","No Schedules to display"),frame:true,viewConfig:{markDirty:false},initComponent:function(){this.cellEditing=new Ext.grid.plugin.CellEditing({clicksToEdit:1,});var c=SVMX.create("Ext.data.Store",{fields:[{name:"Id"},{name:"name"}],id:"workOrderPurposeStore",proxy:{type:"memory"}});this.workOrderPuproseTemplate=new Ext.form.field.ComboBox({typeAhead:true,triggerAction:"all",displayField:"name",valueField:"Id",queryMode:"local",typeAhead:true,triggerAction:"all",selectOnTab:true,store:c,listConfig:{getInnerTpl:function(d){return"{[Ext.String.htmlEncode(values."+d+")]}";}},});this.picklistRenderer=function(d){return function(f){var e=d.store.find(d.valueField,f);var g=d.store.getAt(e);return((g===null||g===undefined)?"":Ext.String.htmlEncode(g.get(d.displayField)));};};Ext.apply(this,{width:"60%",autoScroll:true,margin:"0 10 30 10",plugins:[this.cellEditing],id:"scheduleOPGrid",cls:"pmplan-schedule-grid",emptyText:b.T("TAG057","No Schedules to display"),viewConfig:{deferEmptyText:false,},store:new Ext.data.Store({storeId:"schedule_op_store",fields:["internalExpression","scheduleId","scheduleName","selectedWOPurpose","sequence","status","statusLabel","actualOpName","advancedExpression","actualOpExpression"],data:[],sorters:{field:"sequence",direction:"ASC"}}),columns:[{flex:1,text:b.T("TAG058","Sequence"),dataIndex:"sequence",align:"left",resizable:true,readOnly:true,hidden:true},{flex:1,text:b.T("TAG059","PM Schedule Output"),dataIndex:"scheduleName",align:"left",resizable:true,readOnly:true,renderer:function(e,d){d.style="white-space: normal;";return Ext.String.htmlEncode(e);}},{flex:1,text:b.T("TAG060","Status"),dataIndex:"statusLabel",align:"left",resizable:true,readOnly:true,renderer:function(d){return Ext.String.htmlEncode(d);}},{flex:1,text:b.T("TAG061","Actual Output"),dataIndex:"actualOpName",align:"left",resizable:true,readOnly:true,renderer:function(d){return Ext.String.htmlEncode(d);}},{flex:1,text:b.T("TAG062","Work Order Purpose"),dataIndex:"selectedWOPurpose",align:"left",resizable:true,readOnly:true,editor:this.workOrderPuproseTemplate,renderer:this.picklistRenderer(this.workOrderPuproseTemplate)},],selModel:{selType:"cellmodel"},});this.callParent();},});Ext.define("com.servicemax.client.pmplan.ui.desktop.conditionRule.ConditionRuleGridCriteria",{extend:"com.servicemax.client.ui.components.composites.impl.SVMXListComposite",xtype:"cell-editing",frame:true,__fieldStore:null,__rowData:null,viewConfig:{markDirty:false},initComponent:function(){this.fieldCombo=new SVMX.create("com.servicemax.client.pmplan.ui.desktop.conditionRule.GroupComboBox",{id:"fieldComboCmp_CB",typeAhead:true,queryMode:"local",triggerAction:"all",selectOnTab:true,store:this.__fieldStore,displayField:"fieldLabel",valueField:"fieldApiName",groupField:"category",editable:false});var c=Ext.create("Ext.data.Store",{fields:["label","value","type"],data:{items:[{label:b.T("COMM_TAG006","Equals"),value:"eq",type:"TEXT_PICKLIST"},{label:b.T("COMM_TAG008","Greater Than"),value:"gt",type:""},{label:b.T("COMM_TAG010","Less Than"),value:"lt",type:""}]},proxy:{type:"memory",reader:{type:"json",root:"items"}}});this.operatorCombo=new Ext.form.field.ComboBox({id:"operatorComboCmp_CB",typeAhead:true,triggerAction:"all",queryMode:"local",selectOnTab:true,displayField:"label",store:c,listConfig:{getInnerTpl:function(e){return"{[Ext.String.htmlEncode(values."+e+")]}";}},valueField:"value",editable:false,__parent:this,listeners:{expand:function(f){var e=f.__parent.__rowData.selectedField;var h=Ext.getStore("Field_List_Store_CB");var i=h.findRecord("fieldApiName",e,0,false,true,true);var g=i&&i.getData().dataType.toUpperCase();if(e!==null&&e!==""){if(g==="TEXT"||g==="PICKLIST"){f.store.filter("type","TEXT_PICKLIST");}}}}});var d=Ext.create("Ext.data.Store",{storeId:"TA_PA_Store",fields:["fieldApiName","label","value"]});
this.TA_PA_Combo=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXPicklist",{id:"TA_PA_ComboCmp",store:d,queryMode:"local",displayField:"label",valueField:"value",editable:false,listConfig:{getInnerTpl:function(e){return"{[Ext.String.htmlEncode(values."+e+")]}";}},__parent:this,listeners:{expand:function(f){var e=f.__parent.__rowData.selectedField;if(e!==null&&e!==""){f.store.filter("fieldApiName",e);}}}});this.cellEditing=new Ext.grid.plugin.CellEditing({clicksToEdit:1,__parent:this,listeners:{beforeedit:function(g,i){this.__parent.__rowData=i.record.data;var f=Ext.getCmp("operatorComboCmp_CB");f.store.clearFilter();var h=Ext.getCmp("TA_PA_ComboCmp");h.store.clearFilter();},edit:function(h,j){if(j.field==="selectedField"){var i=j.value;var g=j.originalValue;var f="";var l="";var k=Ext.getStore("Field_List_Store_CB");var m=k.findRecord("fieldApiName",i,0,false,true,true);var l=m&&m.getData().dataType.toUpperCase();if(g!==""&&g!==null){m=k.findRecord("fieldApiName",g,0,false,true,true);f=m&&m.getData().dataType.toUpperCase();}if((l==="TEXT"||l==="PICKLIST")&&(f!==""&&(f==="NUMBER"||f==="DATE"))){j.record.set("selectedOperator","");}else{if((l==="NUMBER"||l==="DATE")&&(f!==""&&(f==="TEXT"||f==="PICKLIST"))){j.record.set("selectedOperator","");}}if(f!==""&&(l!==f)){j.record.set("value","");}else{if(l==="PICKLIST"&&f!==""&&(l===f)&&(i!==g)){j.record.set("value","");}}}}}});this.comboBoxRenderer=function(e){return function(g){var f=e.store.find(e.valueField,g);var h=e.store.getAt(f);return((h===null||h===undefined)?"":h.get(e.displayField));};};Ext.apply(this,{width:"60%",autoScroll:true,maxHeight:450,id:"conditionRuleGridCB",margin:"10 10 30",plugins:[this.cellEditing],store:new Ext.data.Store({storeId:"Condition_Rule_Store_CB",fields:["isRowHasError","conditionRuleId","sequence","selectedField","selectedOperator","value"]}),columns:[{xtype:"actioncolumn",width:40,align:"center",sortable:false,menuDisabled:true,items:[{iconCls:"pmplan-delete-row-icon",tooltip:b.T("TAG043","Delete"),scope:this,handler:this.onRemoveClick}]},{header:b.T("TAG044","Sequence"),dataIndex:"sequence",width:70,sortable:false,menuDisabled:true,align:"center"},{header:b.T("TAG075","Attribute"),dataIndex:"selectedField",width:270,align:"center",sortable:false,menuDisabled:true,editor:this.fieldCombo,renderer:this.comboBoxRenderer(this.fieldCombo)},{header:b.T("TAG046","Operator"),dataIndex:"selectedOperator",width:180,align:"center",sortable:false,menuDisabled:true,renderer:this.comboBoxRenderer(this.operatorCombo),__parent:this,getEditor:function(e){var f=e.data.selectedField;if(f!==null&&f!==""){return this.__parent.operatorCombo;}}},{header:b.T("TAG073","Value"),dataIndex:"value",width:400,align:"center",sortable:false,menuDisabled:true,__parent:this,renderer:function(p,e,l,h,k,q){if(p!=null&&p!=""){var g=l.data.selectedField;var f=Ext.getStore("Field_List_Store_CB");var j=f.findRecord("fieldApiName",g,0,false,true,true);var m=j&&j.getData().dataType.toUpperCase();if(m==="DATE"){var i=new Date(p);var n=("0"+(i.getMonth()+1)).slice(-2);var o=("0"+i.getDate()).slice(-2);return[n,o,i.getFullYear()].join("-");}else{return Ext.String.htmlEncode(p);}}else{return p;}},getEditor:function(e){var g=e.data.selectedField;var i=Ext.getStore("Field_List_Store_CB");var j=i.findRecord("fieldApiName",g,0,false,true,true);var h=j&&j.getData().dataType.toUpperCase();if(h!==null&&h!==""){if(h==="DATE"){var f=Ext.create("Ext.form.field.Date",{format:"m-d-Y",value:Ext.Date.dateFormat(e.data.value,"m-d-Y"),invalidText:b.T("TAG079","Enter a valid date"),});return Ext.create("Ext.grid.CellEditor",{field:f});}else{if(h==="TEXT"){return Ext.create("Ext.grid.CellEditor",{field:Ext.create("Ext.form.field.Text",{})});}else{if(h==="NUMBER"){return Ext.create("Ext.grid.CellEditor",{field:Ext.create("Ext.form.field.Number",{minValue:0.1,enableKeyEvents:true,nanText:b.T("TAG080","Enter a valid number"),listeners:{keypress:function(m,l){var k=m.getValue();if(!Ext.isEmpty(k)){if(/\.\d{2,}/.test(k)){l.stopEvent();}}}}})});}else{if(h==="PICKLIST"){return Ext.create("Ext.grid.CellEditor",{field:this.__parent.TA_PA_Combo});}}}}}}}],selModel:{selType:"cellmodel"},bbar:[{text:"+ "+b.T("TAG056","Add row"),id:"addRowButton_CB",scope:this,handler:this.onAddClick,cls:"pmplan-blue-link"}]});this.callParent();},onAddClick:function(d){var c=this.getStore().getCount();var e={sequence:c+1,isRowHasError:false};if(c<5){this.getStore().insert(c,e);if(c==4){d.setDisabled(true);}}if(this.getStore().getCount()>0){Ext.getCmp("scheduleLink").setDisabled(false);}else{Ext.getCmp("scheduleLink").setDisabled(true);}},onRemoveClick:function(d,h,c,g){var k=this.getStore();k.removeAt(h);var l=k.getCount();for(var f=h;f<l;f++){var e=k.getAt(f);e.set("sequence",f+1);}var j=Ext.getCmp("addRowButton_CB");if(l<5&&j.isDisabled()){j.setDisabled(false);}if(this.getStore().getCount()>0){Ext.getCmp("scheduleLink").setDisabled(false);}else{Ext.getCmp("scheduleLink").setDisabled(true);}}});};})();
(function(){var a=SVMX.Package("com.servicemax.client.pmplan.ui.desktop.impl");a.Class("Module",com.servicemax.client.lib.api.ModuleActivator,{__constructor:function(){this.__base();},beforeInitialize:function(){com.servicemax.client.pmplan.ui.desktop.api.conditionrule.init();},initialize:function(){com.servicemax.client.pmplan.ui.desktop.api.init();com.servicemax.client.pmplan.ui.desktop.api.conditionrule.init();}},{instance:null});})();
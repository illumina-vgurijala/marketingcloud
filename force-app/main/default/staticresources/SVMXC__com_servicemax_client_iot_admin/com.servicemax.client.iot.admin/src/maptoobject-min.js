(function(){var a=SVMX.Package("com.servicemax.client.iot.admin.maptoobject");a.init=function(){Ext.define("com.servicemax.client.iot.admin.Maptoobject",{extend:"com.servicemax.client.installigence.ui.components.SVMXPanel",metadata:null,constructor:function(d){var e=this;e.refresh();e.metadata=d.metadata,d.items=[];e.eventStore=SVMX.create("com.servicemax.client.ui.components.composites.impl.SVMXStore",{fields:[{name:"eventName",type:"string"},{name:"eventDescription",type:"string"},{name:"objectName",type:"string"},{name:"sfdc",type:"string"},{name:"eventId",type:"string"},{name:"payload",type:"string"}],data:[]});e.eventGrid=SVMX.create("com.servicemax.client.iot.admin.EventGrid",{cls:"grid-panel-borderless panel-radiusless iot-setup-ta-grid iot-create-map-for-object-grid",store:e.eventStore,autoScroll:true,parentContext:e,selType:"cellmodel",plugins:[SVMX.create("com.servicemax.client.installigence.ui.components.SVMXCellEditorPlugin",{clicksToEdit:2})],viewConfig:{markDirty:false,getRowClass:function(g,h){return"iot-maptoobject-object-cell";}},listeners:{cellclick:function(q,g,m,i,l,n,j,k){if(q.config.grid.columns[m].dataIndex==="objectName"){var o=q.config.grid.getStore().data.items[n].data.payload,p=null;if(o!==""){p=JSON.parse(o);}var h=SVMX.create("com.servicemax.client.iot.admin.createevent.CreateEvent",{recordIndex:n,selectCell:q,parentContext:q.config.grid.parentContext,metadata:q.config.grid.parentContext.metadata,payload:p});}},edit:function(h,i,g){}}});var f=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXToolbar",{style:"border-width: 0"});var c=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXButton",{text:$TR.ADD,cls:"iot-setup-add-button",handler:function(){e.__onAddRecords();}});f.add("->");f.add(c);var b=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXFormPanel",{style:"margin: 1px 0",layout:"fit",cls:"grid-panel-borderless",defaults:{anchor:"40%"}});b.add(e.eventGrid);d.items.push(f);d.items.push(b);d.title=$TR.MAP_TO_OBJECT;d.id="MO";e.callParent([d]);e.__loadAllEventTemplates();},shouldSave:function(){var d=this;var b={isValid:true,message:""};var f=d.__getAllMappings();var e=d.getAllEventName();var c;if(Boolean($.inArray("",f)+1)){b.isValid=false;b.message=$TR.SELECT_FIELD_MAP;c=$.inArray("",f);}else{if(Boolean($.inArray("",e)+1)){b.isValid=false;b.message=$TR.EMPTY_EVENT_NAME;c=$.inArray("",e);}}if(!b.isValid){d.__highlightRow(c);}return b;},getAllEventName:function(){var e=[];var d=this;var c=d.eventStore.data.items;for(var b=0;b<c.length;b++){e.push(c[b].data.eventName);}return e;},__getAllMappings:function(){var e=[];var d=this;var c=d.eventStore.data.items;for(var b=0;b<c.length;b++){e.push(c[b].data.payload);}return e;},getMappingRecords:function(){var d=this.eventGrid;var f=d.getStore();f=f.getModifiedRecords();var c=[];var e=0,b=f.length;for(e=0;e<b;e++){delete f[e].data.id;c.push(f[e].data);}return{data:c,deletedEventMapIds:d.deletedEventMapIds};},getData:function(){var e=this.eventGrid;var h=e.getStore();h=h.getModifiedRecords();var d=[];var g=0,c=h.length;for(g=0;g<c;g++){delete h[g].data.id;var f=h[g].data;var b={eventName:f.eventName,className:"COMM_IoTRestApiEngine"};if(f.eventId!==""){b.eventId=f.eventId;}d.push(b);}return{data:d,deletedEvents:e.deletedEventIds};},__onAddRecords:function(c){var d=this;d.eventGrid.addItems({objectName:$TR.SELECT});d.eventGrid.getView().refresh();var e=d.eventGrid.store.data.items.length-1;var b=d.eventGrid.getView();Ext.get(b.getRow(e)).scrollIntoView(b.getEl(),null,true);b.select(e);},__loadAllEventTemplates:function(){var c=this;SVMX.getCurrentApplication().blockUI();var b=SVMX.create("com.servicemax.client.lib.api.Event","IOT.GET_ALL_EVENT_TEMPLATES",c,{request:{context:c}});SVMX.getCurrentApplication().getEventBus().triggerEvent(b);},loadAllEventTemplatesComplete:function(e){var j=this;var d=e.length;var m=[];for(var f=0;f<d;f++){var h=e[f];var i=JSON.parse(h[SVMX.OrgNamespace+"__SM_JSON_Payload__c"]);var g=i.objLbl;var k={eventName:h[SVMX.OrgNamespace+"__SM_Event_Name__c"],eventDescription:h[SVMX.OrgNamespace+"__SM_Description__c"],sfdc:h.Id,objectName:g,payload:h[SVMX.OrgNamespace+"__SM_JSON_Payload__c"]};var c=j.__getEventItems(j.metadata.events,k.eventName);if(c){var b=c.eventId;k.eventId=b;}m.push(k);}j.eventStore.loadData(m);SVMX.getCurrentApplication().unblockUI();},__getEventItems:function(c,b){var d=null;for(var e=0;e<c.length;e++){if(c[e].eventName===b){d=c[e];break;}}return d;},applyEvent:function(b,d,f){var e=this;var c=JSON.stringify(f);e.eventGrid.store.data.items[d].data.objectName=f.objLbl;e.eventGrid.store.data.items[d].data.payload=c;e.eventGrid.getView().refresh();},refresh:function(){var b=this;SVMX.getClient().bind("SAVE_SUCCESS",function(c){b.metadata=c.data;b.__loadAllEventTemplates();},b);},__highlightRow:function(e){var c=this;var b=c.eventGrid.getView();var d=b.getRow(e);Ext.get(d).scrollIntoView(b.getEl(),null,true);Ext.get(d).addCls("piq-setup-new-attributes-row");
},});Ext.define("com.servicemax.client.iot.admin.EventGrid",{extend:"com.servicemax.client.installigence.ui.components.SVMXGrid",deletedEventMapIds:null,deletedEventIds:null,constructor:function(b){var c=this;c.deletedEventMapIds=[];c.deletedEventIds=[];var b=b||{};c.addFieldButton=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXButton",{text:$TR.ADD,cls:"piq-setup-add-button",disabled:false,id:"addFieldRecordbutton",handler:function(){c.addFieldRecord({name:""});}});b.columns=[{menuDisabled:true,sortable:false,xtype:"actioncolumn",width:50,items:[{iconCls:"delet-icon",tooltip:$TR.DELETE}],handler:function(e,i,d){var f=e.getStore();var h=f.getAt(i);f.remove(h);var g=h.data;if(g.sfdc&&g.eventId){c.deletedEventMapIds.push(g.sfdc);c.deletedEventIds.push(g.eventId);}},renderer:function(f,e,d){b.columns[0].items[0].iconCls="delet-icon";}}];b.columns.push(c.createTextBoxColumn({text:$TR.EVENT_NAME,dataIndex:"eventName",flex:1,parentContext:c,maskRe:/[^ ]/,listeners:{blur:function(d){setTimeout(function(){var f=d.parentContext.__getAllEventsName();var g=d.value;var e=f.reduce(function(i,h){if(h.toLowerCase()===g.toLowerCase()){i++;}return i;},0);if(e>1){SVMX.getCurrentApplication().showQuickMessage("error","Event name already exists");}},200);}}}));b.columns.push(this.createTextBoxColumn({text:$TR.EVENT_DESCRIPTION,dataIndex:"eventDescription",flex:1,listeners:null}));b.columns.push(this.createObjectColumn({text:$TR.OBJECT,dataIndex:"objectName",flex:1,listeners:null,tdCls:"x-change-cell"}));c.callParent([b]);},__getAllEventsName:function(){var c=[];var e=this;var d=e.store.data.items;for(var b=0;b<d.length;b++){c.push(d[b].data.eventName);}return c;},addFieldRecord:function(c){if(!c){return;}var d=this.getStore().count();this.store.insert(this.getStore().count(),c);var b=this.getView();Ext.get(b.getRow(d)).scrollIntoView(b.getEl(),null,true);},createTextBoxColumn:function(b){var d=this;var c=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXTextField",{allowBlank:true,editable:true,listeners:b.listeners,parentContext:b.parentContext,maskRe:b.maskRe});var b=b||{};b.sortable=true;b.editable=true;b.getEditor=function(e){return c;};return b;},createObjectColumn:function(b){var c=this;var b=b||{};b.sortable=true;b.editable=true;b.getEditor=function(d){return null;};return b;}});};})();
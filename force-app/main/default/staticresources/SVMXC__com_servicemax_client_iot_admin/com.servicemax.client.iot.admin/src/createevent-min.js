(function(){var a=SVMX.Package("com.servicemax.client.iot.admin.createevent");a.init=function(){a.Class("CreateEvent",com.servicemax.client.lib.api.Object,{__config:null,__win:null,__applyButton:null,__searchTextField:null,__selectedCell:null,__parentContext:null,__recordIndex:null,__payload:null,__metadata:null,__constructor:function(b){var c=this;c.__config=b;c.__metadata=b.metadata;c.__selectedCell=b.selectCell;c.__parentContext=b.parentContext;c.__recordIndex=b.recordIndex;c.__payload=b.payload;c.__win=c.__getUI();c.__win.show();c.__refresh();},__refresh:function(){var e=this,f,d;if(!$.isEmptyObject(e.__payload)){f=e.__payload.objName;d=e.__payload.fld;e.showObjects.setValue(f);e.fieldGridStore.loadData(d);e.__describeSelectedObject(f);var b=[];for(var c=0;c<d.length;c++){if(d[c].fldType==="REFERENCE"){b.push(d[c].refObj);}}if(b){e.fieldGrid.__describeReferenceObject(b);}}else{e.showObjects.setValue("--None--");e.__resetFieldGrid();}},__getUI:function(){var c=this;c.__applyButton=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXButton",{text:$TR.APPLY,id:"applybutton",docked:"right",disabled:true,align:"right",cls:"piq-setup-picklist-apply-button",parentContext:c,handler:function(){this.parentContext.__apply();}});var d=["->",c.__applyButton];var b=c.__getObjectListData();c.objectStore=SVMX.create("com.servicemax.client.ui.components.composites.impl.SVMXStore",{fields:["objectName","objectLabel"],data:b});c.showObjects=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXComboBox",{fieldLabel:$TR.SELECT_OBJECT+' <span class="req" style="color:red">*</span>',store:c.objectStore,labelWidth:150,width:"60%",displayField:"objectLabel",valueField:"objectName",queryMode:"local",editable:true,disabled:false,selectedObject:undefined,listeners:{select:{fn:c.__onSelectObjects,scope:c},afterrender:function(g){var f=g.getStore().getAt(0);g.setValue(f.get("objectLabel"));}}});c.fieldGridStore=SVMX.create("com.servicemax.client.ui.components.composites.impl.SVMXStore",{fields:[{name:"fldLabel",type:"string"},{name:"fldApi",type:"string"},{name:"fldKey",type:"string"},{name:"fldType",type:"string"},{name:"refObj",type:"string"},{name:"refFld",type:"string"},{name:"refLabel",type:"string"},{name:"isExternalId",type:"boolean"}],data:[]});c.fieldStore=SVMX.create("com.servicemax.client.ui.components.composites.impl.SVMXStore",{fields:[{name:"fldApi",type:"string"},{name:"fldLabel",type:"string"},{name:"fldType",type:"string"},{name:"referenceTo",type:"string"},{name:"isExternalId",type:"boolean"}],data:[],sorters:[{property:"fldLabel",direction:"ASC"}]});c.fieldGrid=SVMX.create("com.servicemax.client.iot.admin.FieldsGrid",{cls:"grid-panel-borderless panel-radiusless piq-setup-ta-grid iot-create-map-for-object-grid",store:c.fieldGridStore,fieldStore:c.fieldStore,height:350,margin:"7 7 7 7",width:"calc(100% - 25px)",autoScroll:true,layout:"fit",selType:"cellmodel",parentContext:c,editRowIndex:0,plugins:[SVMX.create("com.servicemax.client.installigence.ui.components.SVMXCellEditorPlugin",{clicksToEdit:2})],viewConfig:{},listeners:{celldblclick:function(f,m,h,g,j,l,k,i){},cellclick:function(m,f,k,g,j,l,h,i){m.config.grid.editRowIndex=l;var n=this.getView().getRow(l);Ext.get(n).removeCls("piq-setup-new-attributes-row");},edit:function(g,h,f){}}});var e=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXWindow",{layout:{type:"vbox"},height:500,width:820,items:[c.fieldGrid],title:$TR.CREATE_EVENT,cls:"piq-setup-ta-picklist-window",closable:true,maximizable:false,titleAlign:"left",layout:{padding:5},layout:"fit",modal:true,dockedItems:[{dock:"top",xtype:"toolbar",margin:"0",items:c.showObjects},{dock:"bottom",xtype:"toolbar",margin:"0",items:d}],listeners:{show:function(h){if(this.modal){var j=Ext.dom.Query.select(".x-mask");for(var f=0;f<j.length;f++){Ext.get(j[f]).setStyle("opacity",1);var g=Ext.get(j[f]);g.addCls("customWinMask");}}},close:function(h){if(this.modal){var j=Ext.dom.Query.select(".x-mask");for(var f=0;f<j.length;f++){Ext.get(j[f]).setStyle("opacity",1);var g=Ext.get(j[f]);g.removeCls("customWinMask");}}}}});return e;},__getObjectListData:function(){var c=this;var b=[{objectName:"--None--",objectLabel:$TR.NONE}];if(c.__metadata.eventObjects){b.push.apply(b,c.__metadata.eventObjects);}return b;},__apply:function(){var d=this;var b=d.__shouldAllowApply();if(!b.isValid){SVMX.getCurrentApplication().showQuickMessage("error",b.message);d.__highlightRow(b.rowIndex);}else{var e=d.showObjects.getSelectedRecord().data.objectName;var h=d.showObjects.getSelectedRecord().data.objectLabel;var c=[];var g=d.__getAllFieldDetails();if(g){c=g;}var f={objName:e,fld:c,objLbl:h};d.__parentContext.applyEvent(d.__selectedCell,d.__recordIndex,f);d.__win.close();}},__getAllFieldDetails:function(){var e=this;var h=[];var c=e.fieldGridStore.data.items;var b=c.length;for(var d=0;d<b;d++){var f=c[d].data;var g={fldLabel:f.fldLabel,fldKey:f.fldKey,fldApi:f.fldApi,fldType:f.fldType,refLabel:f.refLabel,isExternalId:f.isExternalId};
if(f.fldType=="REFERENCE"){g.refObj=f.refObj;g.refFld=f.refFld;}h.push(g);}return h;},__shouldAllowApply:function(){var h=this;var k={isValid:false,message:"",rowIndex:0};var g=h.__getAllKeys();var i=h.__getAllFields();var c=h.__getAllLookups();var b=h.__validateDuplicateValues(i);var e=h.__checkEmptyValues(g);var j=h.__checkEmptyValues(i.apis);var f=h.__checkEmptyValues(c);var d=[];if(g.length==0&&i.apis.length==0){k.message=$TR.EMPTY_FIELD;k.rowIndex=0;}else{if(e!==-1){k.message=$TR.EMPTY_KEY;k.rowIndex=e;}else{if(j!==-1){k.message=$TR.EMPTY_FIELD;k.rowIndex=j;}else{if(b.isFound){d=b.duplicateValues.join();k.message=$TR.DUPLICATE_FIELD+" : "+d;k.rowIndex=b.rowIndex;}else{if(f!==-1){k.message=$TR.EMPTY_LOOKUP_ID;k.rowIndex=j;}else{k.isValid=true;}}}}}return k;},__validateDuplicateValues:function(k){var c=k.apis;var j=k.labels;var f=[];var b=[];var m=false;var h=0;for(var d=0;d<c.length;d++){var l=c[d];var e=c.reduce(function(n,i){if(i.toLowerCase()===l.toLowerCase()){n++;}return n;},0);if(e>1){if(b.indexOf(l.toLowerCase())>-1){}else{f.push(j[d]);b.push(l.toLowerCase());}m=true;h=d;}}var g={duplicateValues:f,isFound:m,rowIndex:h};return g;},__highlightRow:function(e){var c=this;var b=c.fieldGrid.getView();var d=b.getRow(e);Ext.get(d).scrollIntoView(b.getEl(),null,true);Ext.get(d).addCls("piq-setup-new-attributes-row");},__checkEmptyValues:function(b){return $.inArray("",b);},__checkIfArrayValuesAreUnique:function(b){return b.length===new Set(b).size;},__getAllLookups:function(){var e=[];var d=this;var c=d.fieldGridStore.data.items;for(var b=0;b<c.length;b++){e.push(c[b].data.refLabel);}return e;},__getAllKeys:function(){var d=[];var c=this;var b=c.fieldGridStore.data.items;for(var e=0;e<b.length;e++){d.push(b[e].data.fldKey);}return d;},__getAllFields:function(){var b=[];var d=[];var f=this;var c=f.fieldGridStore.data.items;for(var g=0;g<c.length;g++){b.push(c[g].data.fldApi);d.push(c[g].data.fldLabel);}var e={apis:b,labels:d};return e;},__onSelectObjects:function(e,c){var d=this;d.__resetFieldGrid();if(e.getSelectedRecord().get("objectName")=="--None--"){d.fieldGrid.addFieldButton.setDisabled(true);d.__applyButton.setDisabled(true);}else{var b=e.getSelectedRecord().get("objectName");d.__describeSelectedObject(b);}},__describeSelectedObject:function(c){var d=this;d.blockUI();var b=SVMX.create("com.servicemax.client.lib.api.Event","IOT.DESCRIBE_OBJECT",d,{request:{context:d,requestData:{allObjects:[{objectAPIName:c}]}}});SVMX.getCurrentApplication().getEventBus().triggerEvent(b);},describeSelectedObjectComplete:function(c){var b=this;b.fieldGrid.addFieldButton.setDisabled(false);b.__applyButton.setDisabled(false);b.__loadFieldStoreData(c);},__loadFieldStoreData:function(e){var d=this;var g=[];var b=e.sforceObjectDescribes[0];var h=b.fields;for(var c=0;c<h.length;c++){var f=h[c];g.push({fldApi:f.fieldAPIName,fldLabel:f.fieldLabel,fldType:f.type,referenceTo:f.referenceTo,isExternalId:f.isExternalId});}d.fieldStore.setData(g);d.unblockUI();},__resetFieldGrid:function(){var b=this;b.fieldGridStore.clearData();b.fieldGridStore.removeAll();b.fieldGrid.view.refresh();},blockUI:function(){var b={lines:25,length:25,width:5,radius:30,corners:1,rotate:0,direction:1,color:"#ffa384",speed:3,trail:60,shadow:false,hwaccel:false,className:"spinner",zIndex:2000000000};this.__spinner=new Spinner(b).spin($("#"+this.__win.el.dom.id)[0]);},unblockUI:function(){this.__spinner.stop();}});Ext.define("com.servicemax.client.iot.admin.FieldsGrid",{extend:"com.servicemax.client.installigence.ui.components.SVMXGrid",fieldStore:null,__refObjDescribes:null,constructor:function(b){var c=this;var b=b||{};c.__refObjDescribes={};if(b.fieldStore){c.fieldStore=b.fieldStore||{};}c.addFieldButton=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXButton",{text:$TR.ADD,cls:"piq-setup-add-button",disabled:true,id:"addFieldRecordbutton",handler:function(){c.addFieldRecord({name:""});}});b.dockedItems=[{xtype:"toolbar",dock:"top",items:[{xtype:"tbfill"},c.addFieldButton]}];b.columns=[{menuDisabled:true,sortable:false,xtype:"actioncolumn",width:50,items:[{iconCls:"delet-icon",tooltip:$TR.DELETE}],handler:function(e,h,d){var f=e.getStore();var g=f.getAt(h);f.remove(g);},renderer:function(f,e,d){b.columns[0].items[0].iconCls="delet-icon";}}];b.columns.push(c.createComboBoxColumn({text:$TR.FILED_NAME,dataIndex:"fldLabel",flex:1,store:c.fieldStore,renderer:function(d){return Ext.String.htmlEncode(d);}}));b.columns.push(c.createComboBoxColumnForReference({text:$TR.LOOKUP_FIELD_ID,dataIndex:"refLabel",flex:1,}));b.columns.push(c.createTextBoxColumn({text:$TR.FIELD_KEY,dataIndex:"fldKey",flex:1,listeners:null}));c.callParent([b]);},__describeReferenceObject:function(f){var c=[];for(var d=0;d<f.length;d++){c.push({objectAPIName:f[d]});}var e=this;var b=SVMX.create("com.servicemax.client.lib.api.Event","IOT.DESCRIBE_OBJECT",e,{request:{context:e,requestData:{allObjects:c},isRefobj:true}});SVMX.getCurrentApplication().getEventBus().triggerEvent(b);
},describeReferenceObjectComplete:function(b){this.__reloadObjectDescribes(b);},__reloadObjectDescribes:function(f){var e=f.sforceObjectDescribes;for(var g=0;g<e.length;g++){var j=e[g].objectAPIName;var k=e[g].objectLabel;var h=[];var b=e[g].fields;for(var c=0;c<b.length;c++){var d=b[c];if(d.fieldAPIName==="Name"||d.fieldAPIName==="Id"||d.isExternalId==true){h.push(d);}}var l={objName:j,objLbl:k,flds:h};this.__refObjDescribes[j]=l;}},addFieldRecord:function(c){if(!c){return;}var d=this.getStore().count();this.store.insert(this.getStore().count(),c);var b=this.getView();Ext.get(b.getRow(d)).scrollIntoView(b.getEl(),null,true);},__updateLookUpLabel:function(d){var c=this.getSelectionModel();var b=c.getSelection()[0];b.set("refLabel",d);},createComboBoxColumn:function(b){var d=this;var c=SVMX.create("com.servicemax.client.iot.admin.celleditors.SVMXComboBoxCellEditor",{displayField:"fldLabel",queryMode:"local",editable:false,valueField:"fldApi",fieldName:b.dataIndex,store:b.store,parentContext:d,rowIndex:-1,listeners:{select:function(j,e,g){var h=this;var i=h.parentContext.editRowIndex;var f=e.data;h.parentContext.store.data.items[i].data.fldType=f.fldType;h.parentContext.store.data.items[i].data.fldApi=f.fldApi;h.parentContext.store.data.items[i].data.refObj=f.referenceTo;h.parentContext.store.data.items[i].data.isExternalId=f.isExternalId;h.parentContext.store.data.items[i].data.refFld="";if(f.fldType==="REFERENCE"){if(!h.parentContext.__refObjDescribes[f.referenceTo]){h.parentContext.__describeReferenceObject([f.referenceTo]);}h.parentContext.__updateLookUpLabel("");}else{h.parentContext.__updateLookUpLabel($TR.NA);}},beforeedit:function(g,f,e){console.log(f.rowIdx);rowIndex=f.rowIdx;}}});var b=b||{};b.menuDisabled=false;b.sortable=true;b.parentContext=d,b.getEditor=function(e){c.setRecord(e);c.setValue(e.data.fldApi);return c;};return b;},createComboBoxColumnForReference:function(c){var e=this;var b=SVMX.create("com.servicemax.client.ui.components.composites.impl.SVMXStore",{fields:[{name:"fldApi",type:"string"},{name:"fldLabel",type:"string"},{name:"fldType",type:"string"}],data:[],sorters:[{property:"fldLabel",direction:"ASC"}]});var d=SVMX.create("com.servicemax.client.iot.admin.celleditors.SVMXComboBoxCellEditor",{displayField:"fldLabel",queryMode:"local",editable:false,valueField:"fldApi",fieldName:c.dataIndex,store:b,parentContext:e,rowIndex:-1,listeners:{select:function(j,f,g){var h=this;var i=h.parentContext.editRowIndex;h.parentContext.store.data.items[i].data.refFld=j.value;},beforeedit:function(h,g,f){}}});var c=c||{};c.menuDisabled=false;c.sortable=true;c.parentContext=e,c.getEditor=function(f){var j;var m=f.data;var h=m.fldType;if(!h||h!=="REFERENCE"){j=null;}else{d.setRecord(f);d.setValue(f.data.refFld);var k=this.parentContext.__refObjDescribes[m.refObj].flds;var l=[];for(var g=0;g<k.length;g++){var n=k[g];l.push({fldApi:n.fieldAPIName,fldLabel:n.fieldLabel});}d.store.setData(l);j=d;}return j;};return c;},createTextBoxColumn:function(b){var d=this;var c=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXTextField",{allowBlank:true,editable:true,maskRe:/[^ ]/});var b=b||{};b.sortable=true;b.editable=true;b.getEditor=function(e){return c;};return b;}});};})();
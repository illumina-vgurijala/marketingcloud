(function(){var a=SVMX.Package("com.servicemax.client.entitlement.ui.desktop.api");a.init=function(){var b=SVMX.getClient().getServiceRegistry().getServiceInstance("com.servicemax.client.translation").getDictionary("ENTITLEMENT");Ext.define("com.servicemax.client.entitlement.ui.desktop.api.RootContainer",{extend:"com.servicemax.client.ui.components.composites.impl.SVMXSection",cls:"entitlement-root-container",width:"100%",__workOrderHeaderRecord:null,constructor:function(c){c=Ext.apply({title:b.T("TAG060","Check Entitlement: Work Order"),header:false,},c||{});this.callParent(arguments);},entitlementSelectionPanel:null,initComponent:function(){this.callParent(arguments);var m=this;var h=m.__engine.getWorkOrderDetailInfo();m.__workOrderHeaderRecord=h.headerRecord;var e=[];var f=SVMX.create("com.servicemax.client.ui.components.composites.impl.SVMXToolbar",{width:"100%",cls:"svmx-ent-headerToolBar",dock:"top",autoHeight:true,});var p=SVMX.create("Ext.form.Panel",{border:false,flex:1,autoHeight:true,layout:{type:"vbox",align:"stretch",},items:[{xtype:"label",text:b.T("TAG060","Check Entitlement: Work Order"),cls:"svmx-ent-title"},{xtype:"label",text:m.__workOrderHeaderRecord.recordName,cls:"svmx-ent-WOName"},{xtype:"label",text:m.__workOrderHeaderRecord.accountName,cls:"svmx-ent-WOAccount",hidden:m.__workOrderHeaderRecord.accountName==null},{xtype:"label",text:b.T("TAG009","Contact")+": "+m.__workOrderHeaderRecord.contactName,cls:"svmx-ent-WOContact",hidden:m.__workOrderHeaderRecord.contactName==null}]});f.add(p);m.__showDetailView=h.entitlementSettings.entitlementSupportOnLines=="True"?true:false;if(m.__showDetailView){var k=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXText",{cls:"svmx-text-filter-icon svmx-ent-toolbarElement",emptyText:b.T("TAG061","Enter Installed Product or Product"),width:"30%",height:30,id:"searchtext",listeners:{change:function(q,r){m.entitlementPanel.workDetailstore.clearFilter();m.entitlementPanel.workDetailstore.filter(new Ext.util.Filter({filterFn:function(v){var t,w,s;var u=Ext.String.escapeRegex;t=new RegExp(Ext.escapeRe(Ext.String.htmlEnode(k.getValue())),"i");w=t.test(v.data.installedBaseName);s=t.test(v.data.productName);if(w||s){return true;}else{return false;}}}));}}});f.add(k);var g=SVMX.create("Ext.form.Checkbox",{boxLabel:b.T("TAG062","Show All"),checked:m.__engine.__manualEntitlementSettings.showAllLines=="True"?true:false,id:"showAll",cls:"svmx-ent-showAllCheckbox",handler:function(){if(g.getValue()){m.entitlementPanel.__showAll=true;m.entitlementPanel.loadData(m.__workOrderHeaderRecord.listDetailRecords);}else{m.entitlementPanel.__showAll=false;m.entitlementPanel.loadData(m.getUnentitledData(m.__workOrderHeaderRecord.listDetailRecords));}}});f.add(g);}var i=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXButton",{text:b.T("TAG007","Check Entitlement"),id:"checkentitlement",scale:"medium",height:30,cls:"svmx-ent-toolbarElement",handler:function(){m.checkEntitlementCallBack();}});f.add(i);var l=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXButton",{text:b.T("TAG043","Settings"),cls:"svmx-ent-toolbarElement",margin:"0 3",scale:"medium",height:30,handler:function(){m.showSettingPanel(m.__engine.getEntitlementSettings());}});f.add(l);var d=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXButton",{text:b.T("TAG026","Back to Work Order"),scale:"medium",height:30,handler:function(){window.location="/"+SVMX.getUrlParameter("id");}});f.add(d);f.add({iconCls:"svmx-ent-help-icon ",cursor:"pointer",scale:"large",cls:"svmx-ent-help",tooltip:b.T("TAG015","Entitlement Check Help"),href:b.T("TAG000","Entitlement Check Help")});m.add(f);m.settingPanel=SVMX.create("com.servicemax.client.entitlement.ui.desktop.api.SettingPanel",{__parent:m,__engine:m.__engine,border:false,collapsible:false,hidden:true,title:b.T("TAG005","Entitlement Settings")});m.entitlementSelectionPanel=SVMX.create("com.servicemax.client.entitlement.ui.desktop.api.EntitlementSelectionPanel",{__parent:m,__engine:m.__engine,border:false,collapsible:false,hidden:true,__selectedEntitlement:null,});m.add(m.settingPanel);var n=SVMX.create("com.servicemax.client.ui.components.composites.impl.SVMXToolbar",{width:"100%",dock:"bottom",style:"margin-top: 20px",border:false,});var c=SVMX.create("Ext.Toolbar.Fill",{});n.add(c);var o=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXButton",{text:b.T("TAG063","Cancel"),scale:"medium",height:30,handler:function(){window.location="/"+SVMX.getUrlParameter("id");}});n.add(o);var j=SVMX.create("com.servicemax.client.ui.components.controls.impl.SVMXButton",{text:b.T("TAG008","Save Entitlement"),disabled:true,scale:"medium",height:30,id:"saveEnttoDatabase",handler:function(r,u){var s={};r.setDisabled(true);s.entitlementSettings=m.__engine.getEntitlementSettings();s.headerId=m.__workOrderHeaderRecord.recordID;s.entitlementInfoMap=[];if(m.__showDetailView){var q=m.entitlementPanel.workDetailstore.data.items;
q.forEach(function(v,w){if(v.raw.selectedPSEntitlement!=undefined&&v.raw.selectedPSEntitlement!=null){s.entitlementInfoMap.push(v.raw.selectedPSEntitlement);}});}else{var t={};t.recordID=SVMX.getUrlParameter("id");t.entitlementInfo=m.entitlementSelectionPanel.__selectedEntitlement;s.entitlementInfoMap.push(t);}m.__engine.saveEntitlement(s,function(v){SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(Ext.String.htmlEncode(v.messageList[0]),7000);if(m.__showDetailView){if(v.success){var w=Ext.getCmp("workDetailPannel");var y=w.__parent.__workOrderHeaderRecord.listDetailRecords;if(v.headerRecord!=null){var z=v.headerRecord.listDetailRecords;z.forEach(function(B,A){y.forEach(function(D,C){if(D.recordID==B.recordID){if(B.entitlementPerformed){D.selectedEntitlementInfo=B.selectedEntitlementInfo;D.entitlementPerformed=B.entitlementPerformed;D.selectedPSEntitlement=null;if(B.selectedEntitlementInfo.warrantyOrScon!="notcovered"){D.selectEntitlementName=B.selectedEntitlementInfo.recordName;}else{D.selectEntitlementName="Not Covered";}}}});});var x=Ext.getCmp("searchtext");x.setValue("");w.__parent.__workOrderHeaderRecord.listDetailRecords=y;if(w.__showAll){w.loadData(w.__parent.__workOrderHeaderRecord.listDetailRecords);}else{w.loadData(w.__parent.getUnentitledData(w.__parent.__workOrderHeaderRecord.listDetailRecords));}}}}else{if((!(typeof sforce==="undefined"||typeof sforce.one==="undefined")&&SVMX.getClient().getApplicationParameter("prefix"))||(SVMX.getClient().getApplicationParameter("uiTheme")&&SVMX.getClient().getApplicationParameter("uiTheme")=="Theme4d")){sforce.one.navigateToSObject(SVMX.getUrlParameter("id"));}else{window.location="/"+SVMX.getUrlParameter("id");}}});}});n.add(j);if(m.__showDetailView){m.entitlementPanel=SVMX.create("com.servicemax.client.entitlement.ui.desktop.api.EntitlementPanel",{__parent:m,__engine:m.__engine,border:false,collapsible:false,hidden:true,__showAll:g.getValue(),});m.add(m.entitlementPanel);if(m.entitlementPanel.__showAll){m.entitlementPanel.loadData(m.__workOrderHeaderRecord.listDetailRecords);}else{m.entitlementPanel.loadData(m.getUnentitledData(m.__workOrderHeaderRecord.listDetailRecords));}m.entitlementPanel.show();}else{m.entitlementSelectionPanel.__selectedEntitlement=m.__workOrderHeaderRecord.selectedEntitlementInfo;m.entitlementSelectionPanel.loadData(m.__workOrderHeaderRecord.listEntitlementInfo,m.__workOrderHeaderRecord);m.entitlementSelectionPanel.loadParentData();m.entitlementSelectionPanel.show();m.checkEntitlementCallBack();m.add(m.entitlementSelectionPanel);}m.add(n);},showSettingPanel:function(c){this.settingPanel.show();this.disable();},showEntitlementSelectionPanel:function(c,d){c.add(this.entitlementSelectionPanel);c.__workdetailSelected=d;this.entitlementSelectionPanel.loadData(d.raw.listEntitlementInfo,d.raw);this.entitlementSelectionPanel.loadParentData();this.entitlementSelectionPanel.show();},getUnentitledData:function(d){var c=[];if(d!=null){d.forEach(function(e){if(e.selectedEntitlementInfo==null){c.push(e);}});}return c;},checkEntitlementCallBack:function(){parentWin=this;var d={};d.headerId=parentWin.__workOrderHeaderRecord.recordID;d.entitlementSettings=parentWin.__engine.getEntitlementSettings();if(parentWin.__showDetailView){var e=[];var c=parentWin.entitlementPanel.workDetailstore.data.items;Ext.each(c,function(f){e.push(f.data.recordID);});d.detailLineIDs=e;}parentWin.__engine.CheckEntitlement(d,function(f){if(f.success){if(parentWin.__showDetailView){f.headerRecord.listDetailRecords.forEach(function(i,h){parentWin.entitlementPanel.workDetailstore.findRecord("recordID",i.recordID).raw=i;var j=parentWin.entitlementPanel.workDetailstore.allData.forEach(function(m,l){if(m.recordID==i.recordID){if(parentWin.entitlementPanel.workDetailstore.allData[l].selectedPSEntitlement!=null&&parentWin.entitlementPanel.workDetailstore.allData[l].selectedPSEntitlement!=undefined){i.selectedPSEntitlement=parentWin.entitlementPanel.workDetailstore.allData[l].selectedPSEntitlement;}parentWin.entitlementPanel.workDetailstore.allData[l]=i;}});var k=parentWin.__workOrderHeaderRecord.listDetailRecords.forEach(function(m,l){if(m.recordID==i.recordID){if(parentWin.__workOrderHeaderRecord.listDetailRecords[l].selectedPSEntitlement!=null&&parentWin.__workOrderHeaderRecord.listDetailRecords[l].selectedPSEntitlement!=undefined){i.selectedPSEntitlement=parentWin.__workOrderHeaderRecord.listDetailRecords[l].selectedPSEntitlement;}parentWin.__workOrderHeaderRecord.listDetailRecords[l]=i;}});});}else{var g=f.headerRecord.listEntitlementInfo;parentWin.entitlementSelectionPanel.loadData(g,f.headerRecord);parentWin.entitlementSelectionPanel.loadParentData();}}else{SVMX.getCurrentApplication().getApplicationQuickMessageHandler().showQuickMessage(Ext.String.htmlEncode(f.messageList[0]),7000,"success");}});},entHistoryCall:function(){this.entHisPanel.callEntHisWebservice();}});};})();
(function(){var a=SVMX.Package("com.servicemax.client.installigence.admin.filters");a.init=function(){Ext.define("com.servicemax.client.installigence.admin.ExpressionBuilder",{extend:"com.servicemax.client.installigence.ui.components.Tree",constructor:function(c){var d=this;c.viewConfig={listeners:{itemcontextmenu:{fn:d.onViewItemContextMenu,scope:d},itemclick:{fn:d.onNodeClick,scope:d},cellclick:function(h,f,j,g,l,m,k){var i=this.getSelectionModel();}},markDirty:false};d.addCondition=SVMX.create("Ext.Action",{text:$TR.ADD_CONDITION,iconCls:"svmx-add-condition",handler:function(f,e){var g=d.getSelectionModel().getSelection()[0];g.appendChild({exprType:"expression",expandable:false,iconCls:"svmx-no-icon",expanded:true});}});d.addGroup=SVMX.create("Ext.Action",{text:$TR.ADD_GROUP,iconCls:"svmx-add-group",menu:{xtype:"menu",items:[d.createGroup("And",$TR.AND,"svmx-and-operator"),d.createGroup("Or",$TR.OR,"svmx-or-operator"),d.createGroup("Not And",$TR.NOT_AND,"svmx-not-and-operator"),d.createGroup("Not Or",$TR.NOT_OR,"svmx-not-or-operator")]}});d.changeGroup=SVMX.create("Ext.Action",{text:$TR.CHANGE_GROUP,iconCls:"svmx-change-group",menu:{xtype:"menu",items:[d.modifyGroup("And",$TR.AND,"svmx-and-operator"),d.modifyGroup("Or",$TR.OR,"svmx-or-operator"),d.modifyGroup("Not And",$TR.NOT_AND,"svmx-not-and-operator"),d.modifyGroup("Not Or",$TR.NOT_OR,"svmx-not-or-operator")]}});d.deleteGroup=SVMX.create("Ext.Action",{text:$TR.DELETE_GROUP,iconCls:"svmx-delete-group",handler:function(f,e){var g=d.getSelectionModel().getSelection()[0];while(g.firstChild){g.removeChild(g.firstChild);}g.remove(true);d.getStore().sync();}});c.columns=[{xtype:"treecolumn",text:"Task",sortable:true,width:300,dataIndex:"operator",renderer:function(g,h,f){var i=f.get("exprType");if(i==="expression"){var e=f.parentNode.data.depth;var j=35*e;h.tdStyle="width:"+j+"px;";}return g;}}];var b=this.createComboBoxColumn({text:"Fields",dataIndex:"field",width:250,store:c.ibFieldStore,displayField:"fieldLabel",valueField:"fieldAPIName",defaultValue:"Account"});c.columns.push(b);c.columns.push(this.createComboBoxColumn({text:"Condition",dataIndex:"condition",width:200,store:c.operatorsStore,displayField:"opLabel",valueField:"opValue",defaultValue:"Equals"}));c.columns.push(this.createTextBoxColumn({text:"Value",dataIndex:"value",width:150}));c.columns.push({menuDisabled:true,sortable:false,xtype:"actioncolumn",width:50,items:[{iconCls:"delet-icon",tooltip:$TR.DELETE}],handler:function(f,i,e){var g=f.getStore();var h=g.getAt(i);h.remove(true);g.sync();},renderer:function(g,f,e){if(e.get("exprType")==="expression"){c.columns[4].items[0].iconCls="delet-icon";}else{c.columns[4].items[0].iconCls="";}}});c=c||{};c.items=[];this.callParent([c]);},onViewItemContextMenu:function(c,b,g,d,h){h.stopEvent();var f;if(b.get("exprType")==="operatorroot"||b.get("exprType")==="operator"){f=new Ext.menu.Menu({items:[this.addCondition,this.addGroup,"-",this.changeGroup]});if(b.get("exprType")==="operator"){f.add(this.deleteGroup);}f.showAt(h.getXY());}},createGroup:function(b,e,d){var c={};c.text=e;c.iconCls=d;c.context=this;c.handler=function(g,f){var h=this.context.getSelectionModel().getSelection()[0];h.appendChild({operator:e,exprType:"operator",iconCls:d,expanded:true,operator_key:b});};return c;},modifyGroup:function(b,e,d){var c={};c.text=e;c.iconCls=d;c.context=this;c.handler=function(g,f){var h=this.context.getSelectionModel().getSelection()[0];h.data.operator=e;h.data.operator_key=b;h.set("iconCls",d);h.set("title",e);};return c;},createTextBoxColumn:function(b){var c=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXTextField",{allowBlank:true,editable:true,emptyText:$TR.ENTER_VALUE});var b=b||{};b.editor={xtype:"textfield",emptyText:$TR.ENTER_VALUE};b.renderer=function(e,f,d){var g=d.get("exprType");if(g==="expression"){if(e===undefined||e===""){f.tdStyle="color:#ccc";return"enter a value";}}return Ext.String.htmlEncode(e);};return b;},createComboBoxColumn:function(c){var d=this;var b=SVMX.create("com.servicemax.client.installigence.admin.celleditors.SVMXComboBoxCellEditor",{store:c.store,displayField:c.displayField,value:c.defaultValue,valueField:c.valueField,fieldName:c.dataIndex,queryMode:"local",width:"80px",editable:false});var c=c||{};c.renderer=function(f,g,e){var h=e.get("exprType");b.setRecord(e);if(h==="expression"){g.tdCls="svmx-default-content";if(f===undefined||f.length===0){b.setValue(c.store.getAt("0").get(c.valueField));f=b.getValue();}}return Ext.String.htmlEncode(f);};c.menuDisabled=true;c.sortable=false;c.getEditor=function(e){var f=e.get("exprType");if(f!=="expression"){return"";}b.setRecord(e);return b;};return c;}});Ext.define("com.servicemax.client.installigence.admin.Filters",{extend:"com.servicemax.client.installigence.ui.components.SVMXPanel",cls:"grid-panel-borderless panel-radiusless",constructor:function(c){var d=this;d.filtersPanel=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXPanel",{cls:"grid-panel-borderless panel-radiusless",plain:"true",height:200,width:"100%"});
d.searchFiltersToolbar=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXToolbar",{style:"border-width: 0"});d.addFilterRecButton=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXButton",{cls:"piq-setup-add-button",text:$TR.ADD,disabled:true,handler:function(){d.onAddRecords();}});d.filtersTextSearch=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXTextSearch",{width:"40%",cls:"search-textfield",emptyText:$TR.SEARCH_EMPTY_TEXT,listeners:{change:{fn:d.onTextFieldChange,scope:this,buffer:500}}});d.searchFiltersToolbar.add(d.filtersTextSearch);d.searchFiltersToolbar.add("->");d.searchFiltersToolbar.add(d.addFilterRecButton);d.filterStore=SVMX.create("com.servicemax.client.ui.components.composites.impl.SVMXStore",{fields:[{name:"name",type:"string"},{name:"isGlobal",type:"boolean"},{name:"expression",type:"auto"}],data:[]});d.filtersSearchGrid=SVMX.create("com.servicemax.client.installigence.admin.userActionsGrid",{cls:"grid-panel-borderless panel-radiusless piq-setup-ta-grid",store:d.filterStore,height:150,selType:"cellmodel",plugins:[SVMX.create("com.servicemax.client.installigence.ui.components.SVMXCellEditorPlugin",{clicksToEdit:2})],isFiltersGrid:true,selectedExpression:undefined,listeners:{itemclick:function(g,f,i,h,j){d.expressiontree.setDisabled(false);d.__persistNLoadExpression(f);}},nameFieldListner:{change:function(g,f){if(d.expressiontree.getStore().getData().items[0]!==undefined){d.expressiontree.getStore().getData().items[0].data.operator=f;d.expressiontree.getStore().getData().items[0].set("title",f);}}}});Ext.define("expressionModel",{extend:"Ext.data.Model",fields:[{name:"operator",type:"string"},{name:"field",type:"string"},{name:"condition",type:"string"},{name:"value",type:"string"}]});var e=Ext.create("Ext.data.TreeStore",{model:"expressionModel",root:{nodeType:"async",attributes:[],expanded:true,children:[{operator:$TR.SELECTED_EXPR,exprType:"root",iconCls:"svmx-expression-icon",expanded:true,children:[{operator:"And",exprType:"operatorroot",iconCls:"svmx-and-operator",expanded:true}]}]}});var b=this.__getIBFieldsStore(c.metadata);d.expressiontree=SVMX.create("com.servicemax.client.installigence.admin.ExpressionBuilder",{cls:"grid-panel-borderless svmx-tree-panel svmx-expression-tree",margin:"5 7 7 7",height:238,store:e,header:false,disabled:true,selType:"cellmodel",plugins:[SVMX.create("com.servicemax.client.installigence.ui.components.SVMXCellEditorPlugin",{clicksToEdit:1})],rootVisible:false,ibFieldStore:b,operatorsStore:this.__getOperatorsStore()});c=c||{};c.items=[];c.items.push(d.searchFiltersToolbar);c.items.push(d.filtersSearchGrid);c.items.push(d.expressiontree);this.callParent([c]);},__getIBFieldsStore:function(c){var d=c[SVMX.OrgNamespace+"__Installed_Product__c"]?c[SVMX.OrgNamespace+"__Installed_Product__c"]["fields"]:[];var b=SVMX.create("com.servicemax.client.ui.components.composites.impl.SVMXStore",{fields:["fieldAPIName","fieldLabel"],data:d,sorters:[{property:"fieldLabel",direction:"ASC"}],sortRoot:"fieldLabel",sortOnLoad:true,remoteSort:false,});return b;},__getOperatorsStore:function(c){var d=[{opLabel:$TR.EQUALS,opValue:"equals"},{opLabel:$TR.NOT_EQUAL,opValue:"notequal"},{opLabel:$TR.GREATER_THAN,opValue:"greaterthan"},{opLabel:$TR.GREATER_OR_EQUAL,opValue:"greaterorequalto"},{opLabel:$TR.LESS_THAN,opValue:"lessthan"},{opLabel:$TR.LESS_OR_EQUAL,opValue:"lessorequalto"},{opLabel:$TR.STARTS_WITH,opValue:"startswith"},{opLabel:$TR.CONTAINS,opValue:"contains"},{opLabel:$TR.DOES_NOT_CONTAIN,opValue:"doesnotcontain"},{opLabel:$TR.INCLUDES,opValue:"includes"},{opLabel:$TR.EXCLUDES,opValue:"excludes"},{opLabel:$TR.ISNULL,opValue:"isnull"},{opLabel:$TR.ISNOTNULL,opValue:"isnotnull"}];var b=SVMX.create("com.servicemax.client.ui.components.composites.impl.SVMXStore",{fields:["opValue","opLabel"],data:d});return b;},onTextFieldChange:function(){var b=this.filtersTextSearch.getValue();this.filtersSearchGrid.search(b);},onAddRecords:function(){this.filtersSearchGrid.addItems({parentProfileId:this.filtersSearchGrid.selectedProfileId});},persistNLoadExpression:function(b){this.__persistNLoadExpression(b);},__persistNLoadExpression:function(b){var c=this.filtersSearchGrid.selectedExpression;if(this.filtersSearchGrid.selectedExpression){this.__persistExpression(c);}this.filtersSearchGrid.selectedExpression=b.getData?b:undefined;this.__loadExpression(b.getData?b.getData():{});},__persistExpression:function(c){var d={};d.children=this.__getRecords(this.expressiontree.getStore().getRootNode().childNodes[0]);var b=c;if(b){b.set("expression",d);}},__getRecords:function(b){return this.__getChildNodes(b);},__getChildNodes:function(e){var f={};if(e!==undefined&&e.getData()!==undefined){f.operator=e.getData().operator_key;f.exprType=e.getData().exprType;f.field=e.getData().field_key;f.condition=e.getData().condition_key;f.value=e.getData().value;f.expanded=true;f.iconCls=e.getData().iconCls;if(e.isLeaf()){return;}if(e.childNodes&&e.childNodes.length>0){f.children=[];
var d=e.childNodes||[],c,b=d.length;for(c=0;c<b;c++){f.children.push(this.__getChildNodes(d[c]));}}}return f;},__loadExpression:function(b){if(b.expression===undefined||b.expression.length===0){b.expression={nodeType:"sync",attributes:[],expanded:true,children:[{operator:$TR.SELECTED_EXPR,exprType:"root",expanded:true,children:[{operator:$TR.AND,exprType:"operatorroot",expanded:true,children:[],operator_key:"And"}]}]};}this.__loadIconClsForNodes(b.expression.children[0]||b.expression.children);this.expressiontree.getStore().setRootNode({nodeType:"sync",attributes:[],expanded:true,children:b.expression.children});this.expressiontree.getStore().getRootNode().expand(true);if(this.expressiontree.getStore().getData().items[0]!==undefined){this.expressiontree.getStore().getData().items[0].data.operator=b.name;this.expressiontree.getStore().getData().items[0].set("title",b.name);}},__loadIconClsForNodes:function(b){if(b.exprType==="root"){b.iconCls="svmx-expression-icon";}else{if(b.exprType==="operator"||b.exprType==="operatorroot"){b.operator_key=b.operator;if(b.operator==="And"){b.operator=$TR.AND;b.iconCls="svmx-and-operator";}else{if(b.operator==="Or"){b.operator=$TR.OR;b.iconCls="svmx-or-operator";}else{if(b.operator==="Not And"){b.operator=$TR.NOT_AND;b.iconCls="svmx-not-and-operator";}else{if(b.operator==="Not Or"){b.operator=$TR.NOT_OR;b.iconCls="svmx-not-or-operator";}}}}}else{if(b.exprType==="expression"){b.iconCls="svmx-no-icon";b.expandable=false;b.field_key=b.field;b.condition_key=b.condition;b.condition=this.__getOperatorsStore().findRecord("opValue",b.condition)!==null?this.__getOperatorsStore().findRecord("opValue",b.condition).get("opLabel"):b.condition;b.field=this.__getIBFieldsStore(this.metadata).findRecord("fieldAPIName",b.field)?this.__getIBFieldsStore(this.metadata).findRecord("fieldAPIName",b.field).get("fieldLabel"):b.field;}}}if(b.children){var d=0,c=b.children.length||0;for(d=0;d<c;d++){this.__loadIconClsForNodes(b.children[d]);}}return b;}});};})();
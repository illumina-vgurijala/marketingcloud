(function(){var a=SVMX.Package("com.servicemax.client.installigence.admin.producttemplates");a.init=function(){Ext.define("com.servicemax.client.installigence.admin.producttemplates.configSpecGrid",{extend:"com.servicemax.client.installigence.ui.components.SVMXGrid",constructor:function(b){var b=b||{};b.columns=[{menuDisabled:true,sortable:false,xtype:"actioncolumn",width:50,items:[{iconCls:"delet-icon",tooltip:$TR.DELETE}],handler:function(e,h,d){var f=e.getStore();var g=f.getAt(h);f.remove(g);}}];var c=this;b.columns.push(this.createTextBoxColumn({text:"Name",dataIndex:"name",width:200}));b.columns.push(this.createComboBoxColumn({text:"Type",dataIndex:"type",width:200,flex:1}));this.callParent([b]);},createTextBoxColumn:function(b){var c=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXTextField",{allowBlank:true,editable:true});var b=b||{};b.sortable=false;b.editable=true;b.getEditor=function(){return c;};return b;},createComboBoxColumn:function(b){var c=this;this.options=SVMX.create("com.servicemax.client.ui.components.composites.impl.SVMXStore",{fields:["Name","Type"],data:[{Id:"text",Option:"Text"},{Id:"number",Option:"Number"}]});var d=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXComboBox",{store:c.options,displayField:"Option",queryMode:"local",editable:false});var b=b||{};b.menuDisabled=true;b.sortable=false;b.getEditor=function(){return d;};return b;}});Ext.define("com.servicemax.client.installigence.admin.ProductTemplates",{extend:"com.servicemax.client.installigence.ui.components.SVMXPanel",constructor:function(g){var k=this;var e=g.metadata.ibValueMaps;var c=[{templateId:"--None--",templateName:$TR.NONE}];var p=k.__getInstalligenceLogosStore(g.metadata.installigenceLogos);c=c.concat(g.metadata.ibTemplates);ibDescribe=g.metadata[SVMX.OrgNamespace+"__Installed_Product__c"];var f=SVMX.create("com.servicemax.client.ui.components.composites.impl.SVMXStore",{fields:["valueMapName","valueMapProcessName"],data:e});k.templatesStore=SVMX.create("com.servicemax.client.ui.components.composites.impl.SVMXStore",{fields:["templateId","templateName"],data:c});k.deletedTemplateIds=[];k.showTemplates=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXComboBox",{fieldLabel:$TR.SELECT_TEMPLATE,store:k.templatesStore,labelWidth:150,displayField:"templateName",queryMode:"local",valueField:"templateId",value:"--None--",selectedTemplate:undefined,editable:false,width:400,listeners:{select:{fn:k.__persistNLoadTemplate,scope:k},beforeselect:{fn:k.__validateForm,scope:k}}});k.templateActionsToolbar=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXToolbar",{});Ext.override(Ext.tree.View,{collapse:function(r,q,t,s){this.callParent(arguments);this.refresh();},expand:function(r,q,t,s){this.callParent(arguments);this.refresh();}});k.templatePropertyPanel=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXPanel",{margin:"5 0 5 0",layout:"anchor",cls:"grid-panel-border",height:480,flex:1});k.templateNameText=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXTextField",{allowBlank:true,editable:true,margin:"5, 5",labelAlign:"right",fieldLabel:$TR.TEMPLATE_NAME,labelWidth:200,allowBlank:false,width:550,listeners:{change:function(r,q){k.templateTree.changeProductText(q);}}});k.templateNameId=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXTextField",{allowBlank:true,editable:true,margin:"5, 5",labelAlign:"right",fieldLabel:$TR.TEMPLATE_ID,labelWidth:200,allowBlank:false,width:550});k.ibNameText=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXTextField",{allowBlank:true,editable:true,margin:"5, 5",labelAlign:"right",fieldLabel:$TR.IB_DISPLAY_TEXT,labelWidth:200,width:550,hidden:true});k.locationNameText=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXTextField",{allowBlank:true,editable:true,margin:"5, 5",labelAlign:"right",fieldLabel:$TR.LOCATION_DISPLAY_TEXT,labelWidth:200,width:550,hidden:true});k.subLocationNameText=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXTextField",{allowBlank:true,editable:true,margin:"5, 5",labelAlign:"right",fieldLabel:$TR.SUB_LOCATION_DISPLAY_TEXT,labelWidth:200,width:550,hidden:true});k.templatePropertyPanel.add(k.templateNameText);k.templatePropertyPanel.add(k.templateNameId);k.templatePropertyPanel.add(k.ibNameText);k.templatePropertyPanel.add(k.locationNameText);k.templatePropertyPanel.add(k.subLocationNameText);k.productPropertyPanel=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXPanel",{margin:"5 0 5 0",layout:"anchor",cls:"grid-panel-border",height:480,flex:1});k.productNameText=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXLookup",{allowBlank:true,editable:true,cls:"svmx-lookup-field",margin:"5, 5",labelAlign:"right",fieldLabel:$TR.PRODUCT,labelWidth:200,width:550,textWidth:500,meta:g.metadata,onValueSelected:function(s,r,q){k.templateTree.changeProductText(r);}});k.productIcon=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXComboBox",{fieldLabel:$TR.ICON,store:p,labelWidth:200,labelAlign:"right",margin:"5, 5",displayField:"name",valueField:"uniqueName",queryMode:"local",editable:false,width:550,listConfig:{getInnerTpl:function(){var q="<div style='width:100%;height:20px;' align='center'><img src='/servlet/servlet.FileDownload?file={logoId}'></div><div style='width:100%;height:30px;background:#f2f2f2' align='center'>{name}</div>";
return q;}},listeners:{select:function(s,q,r){k.templateTree.changeProductIcon(q.get("logoId"));}}});k.productDefaultValues=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXComboBox",{fieldLabel:$TR.DEFAULT_VALUES,store:f,labelWidth:200,labelAlign:"right",margin:"5, 5",displayField:"valueMapProcessName",valueField:"valueMapName",queryMode:"local",editable:false,width:550});Ext.define("templatemodel",{extend:"Ext.data.Model",fields:["text","type","product"]});var n=Ext.create("Ext.data.TreeStore",{model:templatemodel,root:{expanded:true,children:[{text:$TR.TEMPLATE_NAME,type:"root",expanded:true,iconCls:"template-icon",templateDetails:{}}]}});k.oldProductValueMap=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXComboBox",{fieldLabel:$TR.VALUE_MAP_OLD_IB,store:f,labelWidth:200,labelAlign:"right",margin:"5, 5",displayField:"valueMapName",valueField:"valueMapName",queryMode:"local",editable:false,width:545,bind:{store:"{store}",selection:"{product.oldValueMap}"}});k.newProductValueMap=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXComboBox",{fieldLabel:$TR.VALUE_MAP_NEW_IB,store:f,labelWidth:200,labelAlign:"right",margin:"5, 5",displayField:"valueMapName",valueField:"valueMapName",queryMode:"local",editable:false,width:545});var j=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXFormPanel",{title:$TR.PRODUCT_SWAP,margin:"10 5 10 5",cls:"grid-panel-borderless",ui:"svmx-gray-panel",hidden:true});j.add(k.oldProductValueMap);j.add(k.newProductValueMap);k.productConfigStore=SVMX.create("com.servicemax.client.ui.components.composites.impl.SVMXStore",{fields:["name","type"],data:[]});k.productConfigGrid=SVMX.create("com.servicemax.client.installigence.admin.producttemplates.configSpecGrid",{cls:"grid-panel-border panel-radiusless",store:k.productConfigStore,height:165,margin:"0 5 10 5",selType:"cellmodel",hidden:true,plugins:[SVMX.create("com.servicemax.client.installigence.ui.components.SVMXCellEditorPlugin",{clicksToEdit:2})]});var h=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXToolbar",{margin:"10 5 0 5",hidden:true});var i=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXButton",{ui:"svmx-toolbar-icon-btn",scale:"large",iconCls:"plus-icon",handler:function(){k.productConfigGrid.addItems({});}});var m=SVMX.create("com.servicemax.client.installigence.ui.components.Label",{text:$TR.PRODUCT_CONFIGURATION});h.add(m);h.add("->");h.add(i);k.productPropertyPanel.add(k.productNameText);k.productPropertyPanel.add(k.productIcon);k.productPropertyPanel.add(k.productDefaultValues);k.productPropertyPanel.add(j);k.productPropertyPanel.add(h);k.productPropertyPanel.add(k.productConfigGrid);k.templateTreePanel=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXPanel",{margin:"5 7 5 0",layout:"anchor",cls:"grid-panel-border",width:"30%",height:480});k.templateTree=SVMX.create("com.servicemax.client.installigence.ui.components.Tree",{cls:"grid-panel-borderless svmx-tree-panel",margin:"5 0 0 0",width:"100%",rootVisible:false,height:480,store:n,rootVisible:false,selectedRec:undefined,viewConfig:{listeners:{itemcontextmenu:{fn:k.onViewItemContextMenu,scope:k},itemclick:{fn:k.onNodeClick,scope:k}}},changeProductIcon:function(q){var r=this.getSelectionModel().getSelection()[0];r.set("iconCls","");r.set("icon","/servlet/servlet.FileDownload?file="+q);},changeProductText:function(s,q){var r=this.getSelectionModel().getSelection()[0];r.data.text=s;r.set("title",s);}});k.templateTreeSearch=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXTextSearch",{width:"97%",margin:"5 5 5 5",cls:"search-textfield",emptyText:$TR.SEARCH_EMPTY_TEXT,listeners:{change:{fn:k.onTextFieldChange,scope:this,buffer:500}}});k.addProduct=Ext.create("Ext.Action",{text:$TR.ADD_PRODUCT,iconCls:"product-icon",handler:function(r,q){var s=k.templateTree.getSelectionModel().getSelection()[0];s.appendChild({text:$TR.PRODUCT,type:"product",expanded:true,iconCls:"product-icon",product:{}});}});k.deleteProduct=Ext.create("Ext.Action",{text:$TR.DEL_PRODUCT,iconCls:"product-icon",handler:function(r,q){var s=k.templateTree.getSelectionModel().getSelection()[0];while(s.firstChild){s.removeChild(s.firstChild);}s.remove(true);k.templateTree.getStore().sync();}});k.templateTreePanel.add(k.templateTreeSearch);k.templateTreePanel.add(k.templateTree);k.templateTreePropertiesPanel=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXPanel",{width:"100%",style:"margin: 3px 0",layout:{type:"hbox",align:"strech"},cls:"grid-panel-borderless"});k.templateTreePropertiesPanel.add(k.templateTreePanel);k.templateTreePropertiesPanel.add(k.templatePropertyPanel);var l=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXButton",{ui:"svmx-toolbar-icon-btn",scale:"large",iconCls:"plus-icon",handler:function(){if(k.__validateForm()==false){return false;}k.__addNewTemplate();}});var o=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXButton",{ui:"svmx-toolbar-icon-btn",scale:"large",iconCls:"delete-icon",handler:function(){k.__deleteTemplate();
}});var d=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXButton",{ui:"svmx-toolbar-icon-btn",scale:"large",iconCls:"save-as-icon"});var b=SVMX.create("com.servicemax.client.installigence.ui.components.SVMXButton",{ui:"svmx-toolbar-icon-btn",scale:"large",iconCls:"create-from-ib-icon",handler:function(){if(k.__validateForm()==false){return false;}k.__createFromIB(this,k,ibDescribe);}});k.templateActionsToolbar.add(k.showTemplates);k.templateActionsToolbar.add("->");k.templateActionsToolbar.add(l);k.templateActionsToolbar.add(o);k.templateActionsToolbar.add(b);g=g||{};g.items=[];g.items.push(k.templateActionsToolbar);g.items.push(k.templateTreePropertiesPanel);g.title=$TR.TEMPLATES;this.callParent([g]);},onViewItemContextMenu:function(c,b,g,d,h){h.stopEvent();var f=this;if(b.get("type")==="root"&&b.childNodes&&b.childNodes.length>0){return true;}contextMenu=new Ext.menu.Menu({items:[f.addProduct]});if(b.get("type")==="product"){contextMenu=new Ext.menu.Menu({items:[f.addProduct,f.deleteProduct]});}contextMenu.showAt(h.getXY());return true;},onNodeClick:function(d,g,c,b,f){if(g.get("type")==="product"){this.templateTreePropertiesPanel.remove(this.templatePropertyPanel,false);this.templateTreePropertiesPanel.add(this.productPropertyPanel);}else{if(g.get("type")==="root"){this.templateTreePropertiesPanel.add(this.templatePropertyPanel);this.templateTreePropertiesPanel.remove(this.productPropertyPanel,false);}}this.__persistNLoadProductData(g);return true;},onTextFieldChange:function(){var b=this.templateTreeSearch.getValue();this.templateTree.search(b);},__getInstalligenceLogosStore:function(d){var c=d;var b=SVMX.create("com.servicemax.client.ui.components.composites.impl.SVMXStore",{fields:["name","uniqueName"],data:c});return b;},__persistNLoadProductData:function(b){var c=this.templateTree.selectedRec;if(c){if(c.get("type")==="root"){this.__persistTemplateDetails(c);}else{this.__persistProductData(c);}}this.templateTree.selectedRec=b;if(b.get("type")==="root"){this.__loadTemplateDetails(b);}else{this.__loadProductData(b);}},__persistTemplateDetails:function(b){templInfo={};templInfo.templateName=this.templateNameText.getValue();templInfo.templateId=this.templateNameId.getValue();templInfo.ibText=this.ibNameText.getValue();templInfo.locationText=this.locationNameText.getValue();templInfo.subLocationText=this.subLocationNameText.getValue();b.set("templateDetails",templInfo);},__loadTemplateDetails:function(b){var c=b.getData().templateDetails;if(!c){c={};}this.__loadTemplateDet(c);},__loadTemplateDet:function(b){this.templateNameId.setReadOnly(true);if(!b.templateId){this.templateNameId.setReadOnly(false);}this.templateNameText.setValue(b.templateName);this.templateNameId.setValue(b.templateId);this.ibNameText.setValue(b.ibText);this.locationNameText.setValue(b.locationText);this.subLocationNameText.setValue(b.subLocationText);},__persistProductData:function(b){var c=b&&b.getData()?b.getData().product:undefined;if(c){c.product=this.productNameText.getValue();c.productId=this.productNameText.getIdValue();c.productIcon=this.productIcon.getValue();c.productDefaultValues=this.productDefaultValues.getValue();c.oldProductValueMap=this.oldProductValueMap.getValue();c.newProductValueMap=this.newProductValueMap.getValue();c.productConfiguration=this.productConfigGrid.getRecords();}},__loadProductData:function(b){var c=b.getData().product;if(c){this.productNameText.setValue(c.product);this.productNameText.setIdValue(c.productId);this.productIcon.setValue(c.productIcon);this.productDefaultValues.setValue(c.productDefaultValues);this.oldProductValueMap.setValue(c.oldProductValueMap);this.newProductValueMap.setValue(c.newProductValueMap);this.productConfigGrid.getStore().removeAll();if(c.productConfiguration&&c.productConfiguration.length>0){this.productConfigGrid.getStore().loadData(c.productConfiguration);}}},__persistNLoadTemplate:function(c,b){var d=this.showTemplates.selectedTemplate;if(this.showTemplates.selectedTemplate&&d.getData().templateId!=="--None--"){this.__persistTemplate(d);}this.showTemplates.selectedTemplate=b;this.__loadTemplate(b.getData().template);},__persistTemplate:function(d){var e=this.__getRecords(this.templateTree.getStore().getRootNode());var c=this.showTemplates.selectedTemplate.getData().templateName;var b=this.showTemplates.getStore().findRecord("templateName",c);if(b){b.set("template",e);}},__getRecords:function(b){return this.__getChildNodes(b);},__getChildNodes:function(e){var f={};f.text=e.getData().text;f.type=e.getData().type;f.product=e.getData().product;f.templateDetails=e.getData().templateDetails;f.expanded=true;f.iconCls=e.getData().iconCls;if(e.isLeaf()){return;}f.children=[];var d=e.childNodes||[],c,b=d.length;for(c=0;c<b;c++){f.children.push(this.__getChildNodes(d[c]));}return f;},__loadTemplate:function(b){if(b===undefined){b={expanded:true,leaf:false,children:[{text:$TR.TEMPLATE_NAME,type:"root",expanded:true,iconCls:"template-icon",templateDetails:{}}]};}this.__loadIconClsForNodes(b.children[0]);
this.templateTree.getStore().setRootNode({expanded:true,leaf:false,children:b.children});this.templateTreePropertiesPanel.add(this.templatePropertyPanel);this.templateTreePropertiesPanel.remove(this.productPropertyPanel,false);this.templateTree.getStore().getRootNode().expand(true);this.templateTree.getSelectionModel().select(0);this.__loadTemplateDet(this.templateTree.getStore().getRootNode().getData().children[0].templateDetails||{});this.templateTree.selectedRec=this.templateTree.getSelectionModel().getSelection()[0];},__loadIconClsForNodes:function(b){var f=b.product;productIcon=f&&f.productIcon&&f.productIcon!==null?f.productIcon:undefined;var c=this.productIcon.getStore().findRecord("uniqueName",productIcon);b.iconCls="product-icon";if(b.type==="root"){b.iconCls="template-icon";}else{if(c){b.iconCls="";b.icon="/servlet/servlet.FileDownload?file="+c.get("logoId");}}if(b.children){var e=0,d=b.children.length||0;for(e=0;e<d;e++){this.__loadIconClsForNodes(b.children[e]);}}return b;},__addNewTemplate:function(){this.showTemplates.setValue("--None--");this.templateNameId.setReadOnly(false);this.showTemplates.getSelectedRecord().set("isNew",true);this.__persistNLoadTemplate("",this.showTemplates.getSelectedRecord());this.templateNameText.setValue("ProductIQ Template "+new Date);this.templateNameId.setValue("ProductIQ_Template_"+Math.round(+new Date()/1000));this.templateTree.selectedRec=this.templateTree.getSelectionModel().getSelection()[0];},__deleteTemplate:function(){var b=this.showTemplates.getSelectedRecord();var c=b.get("templateId");if(c==="--None--"){return;}this.deletedTemplateIds.push(b.get("templateId"));this.showTemplates.getStore().remove(b);this.showTemplates.setValue("--None--");this.__loadTemplate(this.showTemplates.getSelectedRecord().template);},__createFromIB:function(d,c,b){var e=SVMX.create("com.servicemax.client.installigence.admin.objectsearch.ObjectSearch",{objectName:SVMX.OrgNamespace+"__Installed_Product__c",columns:[{name:"Name"}],multiSelect:false,sourceComponent:d,objectDescribe:ibDescribe,mvcEvent:"FIND_TOPLEVEL_IBS"});e.find().done(function(g){var f=g[0].Id;c.__getTemplateForIB(f);});},__getTemplateForIB:function(c){var d=this;var b=SVMX.create("com.servicemax.client.lib.api.Event","INSTALLIGENCEADMIN.GET_TEMPLATE_FROM_IB",d,{request:{context:d,topLevelIB:c}});SVMX.getCurrentApplication().getEventBus().triggerEvent(b);},GetTemplateFromIBComplete:function(e){var e=e;var c={};c.children=[];var b="ProductIQ Template "+new Date,d="ProductIQ_Template_"+Math.round(+new Date()/1000);c.children.push({text:b,type:"root",expanded:true,iconCls:"template-icon",templateDetails:{templateName:b,templateId:d},children:[e]});this.showTemplates.findRecord("templateId","--None--").set("template",c);this.__addNewTemplate(c);},__validateForm:function(){var c=true;if(!this.templateNameText.getValue()||this.templateNameText.getValue().length==0){c=false;}if(!this.templateNameId.getValue()||this.templateNameId.getValue().length==0){c=false;}var b=this.showTemplates.selectedTemplate;if(!b||(b.getData().templateId=="--None--"&&!b.getData().isNew)){c=true;}if(c==false){SVMX.getCurrentApplication().showQuickMessage("error",$TR.MANDATORY_FIELDS);}return c;},validateForm:function(){return this.__validateForm();}});};})();
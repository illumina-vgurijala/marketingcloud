(function(){var a=SVMX.Package("com.servicemax.client.runtime.impl");a.Class("Module",com.servicemax.client.lib.api.ModuleActivator,{__runtime:null,__displayRoot:null,__constructor:function(){this.__base();this._logger=SVMX.getLoggingService().getLogger("CLIENT-RUNTIME");this.__runtime=new a.Runtime(this);SVMX.getClient().bind("READY",this.__onClientReady,this);},beforeInitialize:function(){},initialize:function(){},afterInitialize:function(){var b=SVMX.getClient().getServiceRegistry().getService("com.servicemax.client.preferences").getInstance();b.addPreferenceKey(com.servicemax.client.runtime.constants.Constants.PREF_KEY_THEME);},__onClientReady:function(b){this._logger.info("Client ready to run!");this.__runtime.start();}},{});a.Class("Runtime",com.servicemax.client.lib.api.Object,{__parent:null,__logger:null,__app:null,__constructor:function(b){this.__parent=b;this.__logger=b.getLogger();},start:function(){var f=SVMX.getClient(),c=null,l=null;var g="CLASSIC";var n=SVMX.getUrlParameter("theme");var i=f.getApplicationParameter("theme");if(n!=undefined&&n!=""){g=n;}else{if(i){g=i;}else{try{var b=SVMX.getClient().getServiceRegistry().getService("com.servicemax.client.preferences").getInstance(),k=com.servicemax.client.runtime.constants.Constants.PREF_KEY_THEME;var m=b.getPreference(k);if(m){g=m;}}catch(h){this.__logger.warn("Could not load preferences. => "+h);}}}function j(){this.__logger.info("Theme <"+g+">loaded successfully");c=f.getDeclaration("com.servicemax.client.runtime.application");l=f.getDefinitionsFor(c);if(l.length==0){this.__logger.error("Cannot find an application extension!");return;}var p=l[0],o=p.config.application;var s="";s=SVMX.getUrlParameter("application-id");if(s==null||s==""){s=f.getApplicationParameter("application-id");}if(!s){this.__logger.error("Your application configuration does not specify an application id. Please rectify");return;}if(o instanceof Array){for(var t=0;t<o.length;t++){var q=o[t];if(q.id==s){o=q;break;}}if(t==o.length){o={id:"__INVALID_APP_ID__"};}}if(o.id!=s){this.__logger.error("Cannot find the application "+s+" in any of the definitions. Please rectify");return;}var e=o["class-name"];this.__app=SVMX.create(e);this.__logger.info("Running application <"+s+"> with class <"+e+">");com.servicemax.client.lib.api.AbstractApplication.currentApp=this.__app;if(SVMX.TEST){SVMX.startTests();return;}this.__app.beforeRun({handler:this.__beforeRunCompleted,context:this});var r=SVMX.create("com.servicemax.client.lib.core.ClientEvent","APPLICATION_CREATED",this);SVMX.getClient().triggerEvent(r);}var d=SVMX.getClient().getServiceRegistry().getService("com.servicemax.client.themeservice").getInstance();d.loadTheme(g,j,this);},__beforeRunCompleted:function(){SVMX.getClient().getProgressMonitor().finish();this.__app.run();}},{});a.Class("ThemeService",com.servicemax.client.lib.api.Object,{__logger:null,__themeProperties:null,__currentTheme:null,__constructor:function(){if(a.ThemeService.__instance!=null){return a.ThemeService.__instance;}a.ThemeService.__instance=this;this.__themeProperties={};this.__logger=SVMX.getLoggingService().getLogger("THEME-SERVICE");},getThemeProperties:function(){return this.__themeProperties;},getThemeProperty:function(d){var e=this.getThemeProperties(),c=null;for(var b in e){if(b==d){c=e[b];break;}}return c;},__extractThemeProperties:function(c){var d=this.getThemeProperties();for(var b in c){d[b]=c[b];}},getAvailableThemes:function(){var e=SVMX.getClient(),d=null,n=null,k={};d=e.getDeclaration("com.servicemax.client.runtime.uitheme");n=e.getDefinitionsFor(d);if(n.length>0){var g,h=n.length;for(g=0;g<h;g++){var c=n[g],m=c.config["theme-defs"];if(m){var f,l=m.length;for(f=0;f<l;f++){var o=m[f];k[o.type]=k[o.type]?k[o.type]:{properties:{}};if(o.properties){for(var b in o.properties){k[o.type].properties[b]=o.properties[b];}}}}}}return k;},getCurrentTheme:function(){return this.__currentTheme;},loadTheme:function(n,t,c,f){this.__currentTheme=n;if(f){this.__logger.info("Will load the theme later => "+n);t.call(c);return;}this.__logger.info("Loading theme => "+n);var g=SVMX.getClient(),e=null,r=null,k=[];e=g.getDeclaration("com.servicemax.client.runtime.uitheme");r=g.getDefinitionsFor(e);if(r.length>0){var l,m=r.length;for(l=0;l<m;l++){var d=r[l],q=d.config["theme-defs"];if(q){var h,p=q.length;for(h=0;h<p;h++){var s=q[h];if(s.type==n){if(s["valid-platforms"]){var o=s["valid-platforms"];if(!SVMX.isPlatform(o)){continue;}}if(s.properties){this.__extractThemeProperties(s.properties);}if(s.path){var b=d.getResourceUrl(s.path);k[k.length]=b;}}}}}}if(SVMX.TEST){console.log("Skipping requireStyleSheet in test mode for now");t.call(c);return;}if(k.length>0){SVMX.requireStyleSheet(k,t,c,{});}else{t.call(c);}}},{__instance:null});a.Class("NamedInstanceService",com.servicemax.client.lib.api.Object,{__logger:null,__allInstanceDefinitions:null,__constructor:function(){if(a.NamedInstanceService.__instance!=null){return a.NamedInstanceService.__instance;}a.NamedInstanceService.__instance=this;
this.__logger=SVMX.getLoggingService().getLogger("NAMEDINSTANCE-SERVICE");this.__allInstanceDefinitions={};var b=SVMX.getClient(),h=null,e=null;h=b.getDeclaration("com.servicemax.client.runtime.namedinstance");e=b.getDefinitionsFor(h);if(e!=null){var d,f=e.length;for(d=0;d<f;d++){var g=e[d],c=g.config;if(c.define){this.__allInstanceDefinitions[c.define.name]={definition:g,data:[]};}}for(d=0;d<f;d++){var g=e[d],c=g.config;if(c.configure){var g=this.__allInstanceDefinitions[c.configure.name];g.data[g.data.length]={definition:g,data:c.configure.data};}}}},createNamedInstanceAsync:function(c,b){this.__createdNamedInstanceAsyncInternal(c,b);},__createdNamedInstanceAsyncInternal:function(e,d){var c=this.__allInstanceDefinitions[e];var f=c.definition.config.define.type;var b=SVMX.getClass(f);var g=new b();g.initialize(e,c.data,d.additionalParams);d.handler.call(d.context,g);}},{__instance:null});a.Class("Preferences",com.servicemax.client.lib.api.Object,{__preferenceKeys:null,__constructor:function(){this.__preferenceKeys={};},addPreferenceKey:function(b){b=this.__getKey(b);this.__preferenceKeys[b]=b;},getPreferenceKeys:function(){return SVMX.cloneObject(this.__preferenceKeys);},getPreference:function(b){var c;var d=SVMX.getClient().getServiceRegistry().getService("com.servicemax.client.cache");if(d){var e=d.getInstance();b=this.__getKey(b);c=e.getItem(b);}else{SVMX.getLoggingService().getLogger("CLIENT-RUNTIME").warning("No com.servicemax.client.cache has been registered");}return c;},setPreference:function(b,c){var d=SVMX.getClient().getServiceRegistry().getService("com.servicemax.client.cache");if(d){var e=d.getInstance();b=this.__getKey(b);e.setItem(b,c);}else{SVMX.getLoggingService().getLogger("CLIENT-RUNTIME").warning("No com.servicemax.client.cache has been registered");}},__getKey:function(b){return"SVMX-CLIENT-UPREF-"+b;}},{});})();
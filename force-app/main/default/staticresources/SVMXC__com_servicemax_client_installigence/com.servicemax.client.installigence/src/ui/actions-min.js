(function(){var a=SVMX.Package("com.servicemax.client.installigence.actions");a.init=function(){Ext.define("com.servicemax.client.installigence.actions.Actions",{extend:"com.servicemax.client.installigence.ui.components.SVMXPanel",alias:"widget.installigence.actions",__allActions:null,__allActionProviders:null,__showingDisabledActions:true,__contentarea:null,__nodesSelected:null,__meta:null,__menu:null,__Apikey:null,__objectInfo:null,__SelectedNode:null,constructor:function(b){var c=this;this.__allActions=[];this.__allActionProviders=[];this.__showingDisabledActions=true;this.__meta=b.meta;this.__Apikey=this.__getApiKey();this.__objectInfo=SVMX.getCurrentApplication().getObjectInfo();this.__menu=SVMX.create("com.servicemax.client.installigence.ui.components.Menu",{showSeparator:false,plain:true,width:310,scrollable:true,maxHeight:500,layout:"vbox"});b=Ext.apply({items:[{xtype:"button",text:$TR.__getValueFromTag($TR.PRODIQ001_TAG047,"Actions"),cls:"ibtoolbar-actions-btn",textAlign:"right",menuAlign:"tr-br",margin:"10 ",width:"100px",menu:this.__menu,handler:function(){}}]},b||{});b.contentarea.on("node_selected",function(d){this.__SelectedNode=d;if(!(d instanceof Array)){d=[d];}this.handleNodeSelect(d);this.disableCustomActionForLocation(d,c);},this);this.__contentarea=b.contentarea;this.callParent([b]);this.setup();},checkingForOnline:function(){var b=this.__SelectedNode;if(b){if(b.nodeType=="LOCATION"||b.nodeType=="SUBLOCATION"){this.__isCustomActionUrlButtonEnabled(true,this);}else{this.disableURLIfOffline();}}else{this.disableURLIfOffline();}},disableURLIfOffline:function(){var b=window.navigator.onLine;if(b){this.__isCustomActionUrlButtonEnabled(!b,this);}else{this.__isCustomActionUrlButtonEnabled(!b,this);}},disableCustomActionForLocation:function(b,d){if(b){for(var c=0;c<b.length;c++){if(b[c].nodeType=="LOCATION"||b[c].nodeType=="SUBLOCATION"){d.__isCustomActionUrlButtonEnabled(true,d);}else{d.__isCustomActionUrlButtonEnabled(false,d);}}}},handleNodeSelect:function(c){this.__nodesSelected=c;var e,h=this.__allActions,b=h.length,f,d,g=this.__menu;for(e=0;e<b;e++){f=h[e];d=f.provider;d.setContext(c);if(d.isValid()){if(g.items.items[e]){g.items.items[e].setDisabled(false);g.items.items[e].setVisible(true);}}else{if(g.items.items[e]){g.items.items[e].setDisabled(true);}if(!this.__showingDisabledActions){g.items.items[e].setVisible(false);}}}},getNodesSelected:function(){return this.__nodesSelected;},setup:function(){this.__setupDefaults();this.meta.bind("MODEL.UPDATE",function(b){this.refresh();},this);},__setupDefaults:function(){var h=this;this.addActionProvider({className:"com.servicemax.client.installigence.actions.AddNew"});this.addActionProvider({className:"com.servicemax.client.installigence.actions.CloneInstalledProduct"});this.addActionProvider({className:"com.servicemax.client.installigence.actions.AddNewLocation"});this.addActionProvider({className:"com.servicemax.client.installigence.actions.DeleteNew"});var f,d=this.__allActionProviders.length,c,e,g;for(f=0;f<d;f++){e=SVMX.create(this.__allActionProviders[f].className,{});g={text:e.getName(),provider:e,disabled:true,margin:"6 0 12 10",handler:function(){this.provider.act(this,h);}};this.__menu.add(g);this.__allActions.push(g);}var j=SVMX.create("com.servicemax.client.installigence.ui.components.Label",{html:"<div></div>",width:"100%",padding:0,height:25,style:{"background-color":"#D0CDCD"}});},refresh:function(){var h=this;this.removeCustomActions();if(!this.meta.actions||!this.meta.actions.length){return;}var d=this.meta.actions,e=d.length,g,c,f;for(g=0;g<e;g++){if(d[g].isHidden){if(d[g].isHidden===true){continue;}}d[g].mapping=this.__getMappingByName(d[g].action);d[g].customUrls=this.__getCustomURLs(d[g].action);f=SVMX.create("com.servicemax.client.installigence.actions.CustomActionProvider",d[g]);menuItem={text:f.getName(),provider:f,disabled:true,margin:"6 0 12 10",actionType:d[g].actionType,custom:true,ApiKey:this.__Apikey,handler:function(){this.provider.act(this,h);}};this.__menu.add(menuItem);this.__allActions.push(menuItem);}this.__registorForNetworkStatusNotification();},__registorForNetworkStatusNotification:function(){var c=this,d=function(){},b=function(){};if(window.addEventListener){window.addEventListener("online",d,false);window.addEventListener("offline",b,false);}else{document.body.ononline=d;document.body.onoffline=b;}},__isCustomActionUrlButtonEnabled:function(d,e){var b=e.__allActions.length,f=e.__menu,c;while(b>0){b--;c=f.items.items[b];if(c){if(c.custom&&c.actionType==="customurl"){f.items.items[b].setDisabled(d);}}}},removeCustomActions:function(){var b=this.__menu.items.items.length,d=this.__menu,c;while(b>0){b--;c=d.items.items[b];if(c.custom){this.__menu.remove(c);}}},__getMappingByName:function(d){if(!this.meta.mappings){return null;}var c,b=this.meta.mappings.length;for(c=0;c<b;c++){if(this.meta.mappings[c].name===d){return this.meta.mappings[c];}}},__getCustomURLs:function(b){if(!this.meta.customUrls){return null;
}var d,c=this.meta.customUrls.length;for(d=0;d<c;d++){if(this.meta.customUrls[d].name===b){return this.meta.customUrls[d];}}},showDisabledActions:function(){var c,b=this.__allActions.length;for(c=0;c<b;c++){this.__allActions[c].setVisible(true);}this.__showingDisabledActions=true;},hideDisabledActions:function(){var c,b=this.__allActions.length;for(c=0;c<b;c++){if(this.__allActions[c].isDisabled()){this.__allActions[c].setVisible(false);}}this.__showingDisabledActions=false;},toggleOptions:function(){this.__optionsPanel.toggleCollapse();this.doLayout();},addActionProvider:function(b){this.__allActionProviders.push(b);},getContentArea:function(){return this.__contentarea;},__getApiKey:function(){var d=this;var c=SVMX.getCurrentApplication().getNativeServiceRequest();var b=c.createGenerateApiKeyRequest();b.bind("REQUEST_COMPLETED",function(e){d.__Apikey=e.data.data;},this);b.bind("REQUEST_ERROR",function(e){d.__ApiKey="";},this);b.execute();}});a.Class("ActionProvider",com.servicemax.client.lib.api.Object,{_meta:null,_context:null,__constructor:function(b){this.__base();this._meta=b;},getName:function(){return this._meta.name;},setContext:function(b){this._context=b;},isValid:function(){throw new Error("Please override this method <ActionProvider.isValid()>");},act:function(c,b){throw new Error("Please override this method <ActionProvider.act()>");},_getTargetRecordIds:function(f){var c=[];var d=f.getNodesSelected();var e,b=d.length;for(e=0;e<b;e++){c.push(d[e].id);}return c;}},{});a.Class("AddNew",a.ActionProvider,{__constructor:function(){this.__base({name:$TR.__getValueFromTag($TR.PRODIQ001_TAG032,"Add New Installed Product")});},isValid:function(){if(this._context.length==1&&(this._context[0].nodeType=="IB"||this._context[0].nodeType=="LOCATION"||this._context[0].nodeType=="SUBLOCATION")){return true;}else{return false;}},act:function(g,d){var f=this;var b=this._context[0];var c=d.__meta.productDisplayFields||[];var h=d.__meta.productSearchFields||[];var e=SVMX.create("com.servicemax.client.installigence.objectsearch.ObjectSearch",{objectName:"Product2",columns:c.length?c:[{name:"Name"}],searchColumns:h.length?h:[{name:"Name"}],multiSelect:true,sourceComponent:g,mvcEvent:"FIND_PRODUCTS",createHandler:function(){var i=[{Name:"New Installed Product"}];d.getContentArea().addToTree(i,b,"IB");}});e.find().done(function(i){d.getContentArea().addToTree(i,f._context[0],"IB");});}},{});a.Class("CloneInstalledProduct",a.ActionProvider,{__constructor:function(){this.__base({name:$TR.__getValueFromTag($TR.PRODIQ001_TAG100,"Clone Install Product")});},isValid:function(){if(this._context.length==1&&this._context[0].nodeType=="IB"){return true;}else{return false;}},act:function(d,b){var c=this;window.action_cascade=false;SVMX.getCurrentApplication().showQuickMessage("confirm",$TR.__getValueFromTag($TR.PRODIQ001_TAG125,"Are you sure?")+'<br/><br/><label><input type="checkbox" onclick="window.action_cascade=this.checked" />'+$TR.__getValueFromTag($TR.PRODIQ001_TAG138,"Clone all child records")+"</label>",function(e){if(e==="yes"){c.__cascade=window.action_cascade;c.__doCloneRecord(d,b);}});},__doCloneRecord:function(f,e){SVMX.getCurrentApplication().blockUI();this.__parent=e;var d=this._getTargetRecordIds(e)[0];var c=SVMX.getCustomObjectName("Installed_Product");var b=SVMX.create("com.servicemax.client.lib.api.Event","INSTALLIGENCE.CLONE_RECORD",this,{request:{context:this,targetId:d,objectName:c,cascade:this.__cascade}});com.servicemax.client.installigence.impl.EventBus.getInstance().triggerEvent(b);},onCloneComplete:function(b){SVMX.getCurrentApplication().unblockUI();this.__parent.getContentArea().addClonedToTree(b,this._context[0],"IB",this.__cascade);}},{});a.Class("AddNewLocation",a.ActionProvider,{__constructor:function(){this.__base({name:$TR.__getValueFromTag($TR.PRODIQ001_TAG033,"Add New Location")});},isValid:function(){if(this._context.length==1&&(this._context[0].nodeType=="ACCOUNT"||this._context[0].nodeType=="LOCATION")){return true;}else{return false;}},act:function(d,c){var b=this._context[0];var e="LOCATION";c.getContentArea().addToTree({},b,e);}},{});a.Class("DeleteNew",a.ActionProvider,{__constructor:function(){this.__base({name:$TR.__getValueFromTag($TR.PRODIQ001_TAG101,"Delete")});},isValid:function(){var c=this._context.length===1&&this._context[0];if(c){if(!this.__areAllNodesTransient(c)){return false;}var b=c.nodeType;if(b=="IB"||b=="LOCATION"||b=="SUBLOCATION"){return true;}}return false;},act:function(c,b){var d=this._context[0];SVMX.getCurrentApplication().showQuickMessage("confirm",$TR.__getValueFromTag($TR.DELETE_CONFIRM_MESSAGE,"Are you sure?"),function(e){if(e==="yes"){b.getContentArea().deleteFromTree(d);c.setDisabled(true);}});},__areAllNodesTransient:function(c){if(c.recordId.indexOf("local")!==4){return false;}else{return b(c.children);}function b(f){if(!f){return true;}var d=true;for(var e=0;e<f.length;e++){var g=f[e].recordId;if(g&&g.indexOf("local")!==4){d=false;}d=d&&b(f[e].children);
}return d;}}},{});a.Class("ComponentReplacement",a.ActionProvider,{__constructor:function(){this.__base({name:$TR.__getValueFromTag($TR.PRODIQ001_TAG102,"Component Replacement")});},isValid:function(){if(this._context.length==1&&this._context[0].nodeType=="IB"){return true;}else{return false;}},act:function(f,b){var d=this;var c=SVMX.create("com.servicemax.client.installigence.ibswap.IBSwap",{source:f,parent:b});var e=b.__contentarea.__ibtree.__selectedNodeId;c.getChildIBs(e);},},{});a.Class("CustomActionProvider",a.ActionProvider,{__parent:null,__constructor:function(b){this.__base(b);},act:function(d,b){var c=this;window.action_cascade=false;c.__cascade=window.action_cascade;c.__doCustomAction(d,b);},__doCustomAction:function(e,c){var d=this;this.__parent=c;var b=this._getTargetRecordIds(c);switch(this._meta.actionType){case"Field Map":case"fieldupdate":SVMX.getCurrentApplication().showQuickMessage("confirm",'Are you sure?<br/><br/><label><input type="checkbox" onclick="window.action_cascade=this.checked" /> Apply to child nodes</label>',function(g){if(g==="yes"){var f=d._meta.action;d.__cascade=window.action_cascade;d.__applyFieldUpdate(b,f);}});break;case"customurl":this.__openCustomURL();break;}},__openCustomURL:function(){var b=this;this.getCustomURL(b).done(function(c){var d=b._meta.name;if(c){b.__launchUrl(c);}});},__launchUrl:function(b){var f=SVMX.Deferred();var e=SVMX.getCurrentApplication().getNativeServiceRequest();var c=e.createBrowserRequest();c.bind("REQUEST_COMPLETED",function(g){var d=g.data.data;f.resolve(d);},this);c.bind("REQUEST_ERROR",function(d){f.reject({text:TS.T("TODO","The application does not exist. Please contact your system administrator to update the application path or install the necessary software."),type:"INFO"});},this);c.execute({link:b});return f.promise();},getCustomURL:function(b){var c=SVMX.Deferred();this.getRecord(b).done(function(f){var e=b._meta.customUrls.targetURL;var d=b._meta.customUrls.urlParameters;if(d&&d.length>0){e=(e.indexOf(":")==-1)?"http://"+e:e;e+="?";for(var g=0;g<d.length;g++){if(g===0){e+=b.__getEncriptValuevalue(d[g].name)+"=";}else{e+="&"+b.__getEncriptValuevalue(d[g].name)+"=";}if(d[g].parameterType==="Field Name"){if(f){e+=b.__getEncriptValuevalue(f[d[g].value]);}else{continue;}}else{if(d[g].parameterType==="Value"){var h=b.__checkingForLitralsAndPassValue(d[g].value);e+=b.__getEncriptValuevalue(h);}}}}c.resolve(e);});return c;},__getEncriptValuevalue:function(b){return encodeURIComponent(b);},__checkingForLitralsAndPassValue:function(d){var e=d.toUpperCase();var b="";switch(e){case"SVMX.PRODUCTIQWORKORDERID":if(this.__parent.__objectInfo.object==SVMX.getCustomObjectName("Service_Order")){b=this.__parent.__objectInfo.objectId;}else{b="";}break;case"SVMX.USERNAME":var c=window.parent.SVMX.getCurrentApplication().__userInfo.UserLogin;b=c;break;case"SVMX.DATAACCESSAPIKEY":b=this.__parent.__Apikey;break;default:b=d||"";}return b;},getRecord:function(b){var d=SVMX.Deferred();var c=b._meta.customUrls.sourceObjectName;var f=b.__parent.__nodesSelected[0].recordId;if(!f){d.resolve();}var e=SVMX.create("com.servicemax.client.installigence.offline.model.utils.Query",{});e.select("*").from(c).where("Id = '"+f+"'");e.execute().done(function(g){d.resolve(g[0]);});return d;},__applyFieldUpdate:function(c,d){SVMX.getCurrentApplication().blockUI();var b=SVMX.create("com.servicemax.client.lib.api.Event","INSTALLIGENCE.APPLY_FIELD_UPDATE",this,{request:{context:this,targetIds:c,mapName:d,cascade:this.__cascade}});com.servicemax.client.installigence.impl.EventBus.getInstance().triggerEvent(b);},onApplyFieldUpdateComplete:function(b){SVMX.getCurrentApplication().unblockUI();if(b){this.__parent.getContentArea().refreshRecord();}},isValid:function(){var b=null;if(this._context[0].nodeType==="LOCATION"){b=SVMX.getCustomObjectName("Site");}else{if(this._context[0].nodeType==="SUBLOCATION"){b=SVMX.getCustomObjectName("Sub_Location");}else{if(this._context[0].nodeType==="ACCOUNT"){b="Account";}else{if(this._context[0].nodeType==="IB"){b=SVMX.getCustomObjectName("Installed_Product");}}}}if(this._meta.actionType&&this._meta.actionType==="fieldupdate"){if(this._meta&&this._meta.mapping&&this._meta.mapping.targetObjectName===b){return true;}else{return false;}}else{if(this._meta.actionType&&this._meta.actionType==="customurl"){if(this._meta.customUrls&&this._meta.customUrls.sourceObjectName===b){return true;}else{return false;}}else{return false;}}}},{});};})();
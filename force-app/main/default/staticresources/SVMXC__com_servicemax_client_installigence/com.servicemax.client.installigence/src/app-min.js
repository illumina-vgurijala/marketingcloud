(function(){var a=SVMX.Package("com.servicemax.client.installigence.app");a.Class("Application",com.servicemax.client.lib.api.AbstractApplication,{__rootContainer:null,__rootModel:null,__spinner:null,__pendingMessage:null,__insertRecordSyncParams:null,__ObjectInfo:null,__constructor:function(){},__onAppLaunched:function(b){var d=this;var c=window.parent.Ext.ComponentQuery.query("#productIQSheetAsWindow")[0];if(c){if(c.message){var e=SVMX.toObject(c.message);SVMX.getCurrentApplication().setPendingMessage(e);SVMX.getCurrentApplication().setObjectInfo(e);var b=SVMX.create("com.servicemax.client.lib.api.Event","EXTERNAL_MESSAGE",this,e);SVMX.getClient().triggerEvent(b);}}},getNativeServiceRequest:function(){if(window.parent.SVMX.getClient().getApplicationParameter("client-type").toLowerCase()=="laptop"){return window.parent.com.servicemax.client.offline.sal.model.nativeservice.Facade;}else{return com.servicemax.client.installigence.offline.sal.model.nativeservice.Facade;}},setPendingMessage:function(b){this.__pendingMessage=b;},getPendingMessage:function(){return this.__pendingMessage;},setObjectInfo:function(b){this.__ObjectInfo={};this.__ObjectInfo.object=b.object;this.__ObjectInfo.objectId=b.recordID;},getObjectInfo:function(){return this.__ObjectInfo;},emptyPendingMessage:function(){this.__pendingMessage=null;},run:function(){var b=SVMX.getClient().getServiceRegistry().getService("com.servicemax.client.niservice").getInstance();var c=this;b.createNamedInstanceAsync("CONTROLLER",{handler:function(d){b.createNamedInstanceAsync("MODEL",{handler:function(e){d.setModel(e);this.runInternal();},context:this});},context:this,additionalParams:{eventBus:com.servicemax.client.installigence.impl.EventBus.getInstance()}});},runInternal:function(){this.__onAppLaunched();var b=SVMX.getClient().getServiceRegistry().getService("com.servicemax.client.installigence.sync").getInstance();b.bind("SYNC.STATUS",function(f){var e=f.data.type;var h=f.data.msg;var g=f.data.syncType;SVMX.getLoggingService().getLogger().info("SYNC.STATUS: "+e+" "+h);if(e==="start"&&(g==="initial"||g==="reset"||g==="ib")){this.__handleSyncSetupStarted(f.data);}else{if(e==="canceled"){this.__handleSyncCanceled(f.data);}else{if(e==="complete"){this.__insertRecordSyncParams=f.data;this.__handleSyncCompleted(f.data);if(g==="incremental"||g==="insert_local_records"){this.__checkSyncConflicts();}}}}},this);this.blockUI();var c=this;var d=SVMX.getClient().getServiceRegistry().getService("com.servicemax.client.installigence.translation").getInstance();d.refresh().done(function(){window.$TR=d;c.unblockUI();c.setup();});},__clearLocks:function(f){var e=f.state?f.state.updated:undefined;if(e){var b=[];for(var d in e){if(e[d]){b=b.concat(e[d]);}}var c=SVMX.create("com.servicemax.client.lib.api.Event","INSTALLIGENCE.EXECUTE_API",this,{request:{context:this,recordIds:b,method:"CLEARLOCKS"}});com.servicemax.client.installigence.impl.EventBus.getInstance().triggerEvent(c);}},__checkSyncConflicts:function(){var b=SVMX.create("com.servicemax.client.lib.api.Event","INSTALLIGENCE.GET_SYNC_CONFLICTS",this,{request:{context:this}});com.servicemax.client.installigence.impl.EventBus.getInstance().triggerEvent(b);},onGetSyncConflictsComplete:function(b){if(b&&b.length){this.__rootContainer.showSyncConflicts();}var c=SVMX.getClient().getServiceRegistry().getService("com.servicemax.client.installigence.sync").getInstance();if(c&&c.__currentSyncType&&c.__currentSyncType==="insert_local_records"){if(b&&b.length){var d={};d.syncType="INSERT_LOCAL_RECORDS";d.result=b;this.__handleInsertRecSyncCompleted(d);}else{this.__handleInsertRecSyncCompleted(this.__insertRecordSyncParams);}}},__handleInsertRecSyncCompleted:function(d){if(d&&d.state){var e={};this.hideDataLoading();if(d.state.insertRecordsMap&&d.state.insertRecordsMap.length){for(var c=0;c<d.state.insertRecordsMap.length;c++){e[d.state.insertRecordsMap[c].localId]=d.state.insertRecordsMap[c].remoteId;}}var b={action:"SYNC",operation:d.syncType.toUpperCase(),type:"RESPONSE",data:{insertRecordsMap:e}};this.getRootContainer().invokeLMWithResponse(b);this.__insertRecordSyncParams=null;}else{if(d&&d.result){var b={action:"SYNC",operation:d.syncType.toUpperCase(),type:"RESPONSE",data:{error:{type:"SYNC_FAILED",message:d.result[0].Message}}};this.getRootContainer().invokeLMWithResponse(b);}}},__handleSyncCompleted:function(b){if(b.syncType==="incremental"){this.hideDataLoading();this.__clearLocks(b);}else{this.unblockUI();this.__rootContainer.handleHome({type:"sync_complete",params:b});}},__handleSyncCanceled:function(b){this.__handleSyncCompleted(b);},__handleSyncSetupStarted:function(b){this.__rootContainer.handleProgress(b);},blockUI:function(){this.__blockCounter=this.__blockCounter||0;this.__blockCounter++;if(this.__spinner){return;}var c={lines:25,length:25,width:5,radius:30,corners:1,rotate:0,direction:1,color:"#ffa384",speed:3,trail:60,shadow:false,hwaccel:false,className:"spinner",zIndex:2000000000};var b=$("#spincenter")[0];if(!b){$("body").append('<div id="spincenter" style="position:fixed;top:50%;left:50%;z-index:999999"></div>');
b=$("#spincenter")[0];}this.__spinner=new Spinner(c).spin(b);},unblockUI:function(){this.__blockCounter--;if(this.__blockCounter>0){return;}else{this.__blockCounter=0;}if(!this.__spinner){return;}var b=$("#"+SVMX.getDisplayRootId())[0];b.style.height="auto";this.__spinner.stop();delete this.__spinner;},showDataLoading:function(){var b={lines:13,length:6,width:3,radius:7,corners:1,rotate:0,direction:1,color:"#ffffff",speed:3,trail:60,shadow:false,hwaccel:false,className:"spinner",zIndex:2000000000};$(".logo.img").hide();$(".logo.spinner").show();this.__dataSpinner=new Spinner(b).spin($(".logo.spinner")[0]);},hideDataLoading:function(){$(".logo.img").show();$(".logo.spinner").hide();if(this.__dataSpinner){this.__dataSpinner.stop();}},showQuickMessage:function(c,d,b,e){if(d!==undefined&&d.length>0){d+="<br><br>";}c=c.toLowerCase();if(typeof b==="function"){e=b;b={};}if(c==="confirm"){typeMessage=$TR.__getValueFromTag($TR.MESSAGE_CONFIRM,"Confirm");com.servicemax.client.installigence.ui.components.utils.Utils.confirm({title:"Confirm",message:d,handler:e});}else{switch(c){case"success":typeMessage=$TR.__getValueFromTag($TR.MESSAGE_SUCCESS,"Success");break;case"error":typeMessage=$TR.__getValueFromTag($TR.MESSAGE_ERROR,"Error");break;case"info":default:typeMessage=$TR.__getValueFromTag($TR.MESSAGE_INFO,"Info");break;}Ext.Msg.alert({title:typeMessage,message:d,buttonText:{ok:$TR.__getValueFromTag($TR.OK_BTN,"Ok")},closable:false,});}},showConnectionWarningDialog:function(c){var b=this;Ext.Msg.buttonText.ok=$TR.__getValueFromTag($TR.CONTINUE_BTN,"Continue");Ext.Msg.buttonText.cancel=$TR.__getValueFromTag($TR.CANCEL,"Cancel");$("#spincenter").hide();Ext.Msg.show({title:$TR.__getValueFromTag($TR.CONNECTION_WARNING_TITLE,"Connection Warning"),msg:$TR.__getValueFromTag($TR.CONNECTION_WARNING_MSG,"Poor connectivity detected. Please continue when internet connectivity has improved.")+"<br><br>",buttons:Ext.Msg.OKCANCEL,fn:SVMX.proxy(b,function(d){$("#spincenter").show();if(d==="ok"){c.onRetry&&c.onRetry();}else{c.onCancel&&c.onCancel();}})});Ext.Msg.buttonText.ok=$TR.__getValueFromTag($TR.OK_BTN,"Ok");},showConnectionErrorDialog:function(c){var b=this;Ext.Msg.buttonText.ok=$TR.__getValueFromTag($TR.SYNC_CONFLICT_RETRY_BTN,"Retry");Ext.Msg.buttonText.cancel=$TR.__getValueFromTag($TR.CANCEL,"Cancel");$("#spincenter").hide();this.__connectionMsg=Ext.Msg.show({title:$TR.__getValueFromTag($TR.CONNECTION_ERROR_TITLE,"Connection Error"),msg:$TR.__getValueFromTag($TR.CONNECTION_ERROR_MSG,"Internet connectivity lost. Please retry when connectivity is available")+"<br><br>",buttons:Ext.Msg.OKCANCEL,fn:SVMX.proxy(b,function(d){$("#spincenter").show();if(d==="ok"){c.onRetry&&c.onRetry();}else{c.onCancel&&c.onCancel();}})});Ext.Msg.buttonText.ok=$TR.__getValueFromTag($TR.OK_BTN,"Ok");},showRequestErrorDialog:function(d){var c=this;var b;if(d.errorMessage){b=d.errorMessage;}else{b=$TR.__getValueFromTag($TR.SERVER_ERROR_MSG,"The server is unable to complete your request")+"<br><br>";}Ext.Msg.buttonText.ok=SYNC_CONFLICT_RETRY_BTN;Ext.Msg.buttonText.cancel=$TR.__getValueFromTag($TR.CANCEL,"Cancel");$("#spincenter").hide();this.__connectionMsg=Ext.Msg.show({title:$TR.__getValueFromTag($TR.SERVER_ERROR_TITLE,"Server Error"),msg:b,buttons:Ext.Msg.OKCANCEL,fn:SVMX.proxy(c,function(e){$("#spincenter").show();if(e==="ok"){d.onRetry&&d.onRetry();}else{d.onCancel&&d.onCancel();}})});Ext.Msg.buttonText.ok=$TR.__getValueFromTag($TR.OK_BTN,"Ok");},getSearchResultsLimit:function(){return 250;},getAppFocus:function(){var b=SVMX.create("com.servicemax.client.lib.api.Event","INSTALLIGENCE.GET_APP_FOCUS",this,{request:{}});com.servicemax.client.installigence.impl.EventBus.getInstance().triggerEvent(b);},updateDependentRecords:function(e){var c=e.insertRecordsMap||{};var d=[];for(var b in c){d.push(b);}this.updateInRecordNameTable(c,d);var f=SVMX.create("com.servicemax.client.installigence.offline.model.utils.Query",{});f.select("parent_object_name, local_id, parent_record_id, parent_field_name").from("SyncDependentLog").where("local_id").within(d).execute().done(SVMX.proxy(this,function(j){if(j&&j.length>0){var h=j.length;for(var g=0;g<j.length;g++){this.updateParentRecord(j[g],c,function(){h--;if(!h){this.getRootContainer().handleIncrementalSync();}});}}}));},errorFromMFL:function(b){var d=b.type;var c;if(d==="SYNC_PAUSED"||d==="REQUEST_REJECTED"){c=$TR.__getValueFromTag($TR.MESSAGE_INFO,"Info");}else{if(d==="SYNC_FAILED"){c=$TR.__getValueFromTag($TR.MESSAGE_ERROR,"Error");}}Ext.Msg.alert(c,b.message);},getRootContainer:function(){return this.__rootContainer;},updateParentRecord:function(b,f,h){var e=b.parent_field_name+" = '"+f[b.local_id]+"'";var d=b.parent_object_name;var c="Id = '"+b.parent_record_id+"'";var g=SVMX.create("com.servicemax.client.installigence.offline.model.utils.Query",{});g.update(d).setValue(e);g.where(c).execute().done(SVMX.proxy(this,function(i){this.deleteDependentLogEntry(b,h);}));},deleteDependentLogEntry:function(b,d){var c=SVMX.create("com.servicemax.client.installigence.offline.model.utils.Query",{});
c.deleteFrom("SyncDependentLog").where("parent_field_name").equals(b.parent_field_name).where("parent_record_id").equals(b.parent_record_id).execute().done(function(){d.call(this);});},updateInRecordNameTable:function(b,c){var f=SVMX.Deferred();var e=SVMX.create("com.servicemax.client.installigence.offline.model.utils.Query",{});e.select("Id,Name").from("SFRecordName").where("Id").within(c).execute().done(SVMX.proxy(this,function(h){if(h&&h.length>0){var g=h.length;for(var d=0;d<h.length;d++){this.updateRecordNameEntry(h[d],b,function(){g--;if(!g){f.resolve();}});}}}));return f;},updateRecordNameEntry:function(b,e,g){var d="Id = '"+e[b.Id]+"'";var c="Id = '"+b.Id+"'";var f=SVMX.create("com.servicemax.client.installigence.offline.model.utils.Query",{});f.update("SFRecordName").setValue(d).where(c).execute().done(SVMX.proxy(this,function(h){g.call(this);}));},externalMessage:function(c){var b=SVMX.toObject(c);if(b.type==="RESPONSE"){if(b.operation==="INSERT_LOCAL_RECORDS"&&b.data.error){this.errorFromMFL(b.error);}if(b.data&&b.data.insertRecordsMap){this.updateDependentRecords(b.data);}else{if(b.action==="SYNC"&&b.operation==="INCREMENTAL"&&!(b.data&&b.data.error)){this.getRootContainer().handleIncrementalSync();}}}if(b.action==="SYNC"&&b.operation==="INSERT_LOCAL_RECORDS"&&b.type==="REQUEST"){this.getRootContainer().handleInsertRecordsSync(b.data.recordIds);}},isAppEmbedded:function(){var b=false;if(SVMX.appType==="embedded"){b=true;}return b;},setup:function(){this.__rootModel=SVMX.create("com.servicemax.client.installigence.metamodel.Root");this.__rootContainer=SVMX.create("com.servicemax.client.installigence.root.Root",{meta:this.__rootModel});SVMX.getClient().bind("EXTERNAL_MESSAGE",function(c){this.externalMessage(c.data);},this);SVMX.onWindowResize(function(c){this.__rootContainer.setHeight(c.height-2);this.__rootContainer.doLayout();},this);var b=this;SVMX.doLater(function(){b.__rootContainer.doLayout();if(b.isAppEmbedded()){b.__rootContainer.handleHome({type:"initialize"});b.__rootModel.initialize();return;}var c=SVMX.getCurrentApplication().getPendingMessage();if(c!==null){c=SVMX.toObject(c);}var d=SVMX.getClient().getServiceRegistry().getService("com.servicemax.client.installigence.sync").getInstance();d.getLastConfigSyncDetails(b).done(function(){d.hasUserChanged().done(function(e){if(e){b.__rootContainer.handleFindAndGet({syncType:"initial"});}else{if(c!==null&&c.action==="SYNC"&&c.operation==="INCREMENTAL"){b.__rootContainer.handleIncrementalSync();SVMX.getCurrentApplication().emptyPendingMessage();}else{if(c!==null&&c.action==="SYNC"&&c.operation==="INSERT_LOCAL_RECORDS"&&c.type==="REQUEST"){b.__rootContainer.handleInsertRecordsSync(data.data.recordIds);SVMX.getCurrentApplication().emptyPendingMessage();}else{b.__rootContainer.handleHome({type:"initialize"});b.__rootModel.initialize();}}}});}).fail(function(){b.__rootContainer.handleFindAndGet({syncType:"initial"});});});}},{});})();
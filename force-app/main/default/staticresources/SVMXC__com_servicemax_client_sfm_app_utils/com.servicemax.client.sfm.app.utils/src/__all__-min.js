(function(){var a=SVMX.Package("com.servicemax.client.sfm.app.utils.impl");a.Class("Module",com.servicemax.client.lib.api.ModuleActivator,{__constructor:function(){this.__base();},beforeInitialize:function(){com.servicemax.client.sfm.app.utils.pricingdefinition.init();},initialize:function(){},afterInitialize:function(){}},{});})();(function(){var b=SVMX.Package("com.servicemax.client.sfm.app.utils.pricingdefinition");var a=true;b.init=function(){var i=SVMX.OrgNamespace;$EXPR.getPricingDefinition=function(o,s){var E,D=o.detailRecords,z=D.length,w=new f("PARTS"),x=new f("LABOR"),I=new f("LABORPARTS");for(var E=0;E<z;E++){var F=D[E].records,C,y=F.length;for(C=0;C<y;C++){var p=F[C].targetRecordAsKeyValue,r=p.length,A;var H=c("Line_Type__c",p);if(H!=null&&H.value!=null){if(H.value=="Parts"){var n=c("Product__c",p);w.addToValues(n.value);}else{if(H.value=="Labor"){var v=c("Activity_Type__c",p);x.addToValues(v.value);var G=c("Product__c",p);if(G){I.addToValues(G.value);}}}}}}var J=o.headerRecord.records[0].targetRecordId;var m=new j("WORKORDER",J);var t=m.getStringAsXML()+w.getStringAsXML()+x.getStringAsXML()+I.getStringAsXML();var B=c("CurrencyIsoCode",o.headerRecord.records[0].targetRecordAsKeyValue);if(B!=""){var u=new j("WORKORDERCURRENCYISO",B.value);t+=u.getStringAsXML();}var q=SVMX.getClient().getServiceRegistry().getService("com.servicemax.client.sal.service.factory");q.getInstanceAsync({handler:function(k){var K={type:"SOAP",endPoint:"INTF_WebServicesDef",nameSpace:$EXPR.getOrgNamespace()};var L=k.createServiceManager(K);var l=L.createService();l.bind("REQUEST_COMPLETED",function(M){var N=$.parseXml(M.data,true);var O=N.getFirstElementByTagName("message","http://soap.sforce.com/schemas/class/"+g(i)+"INTF_WebServicesDef");var P=d(O);var Q=$EXPR.toObject(P);s(Q);},this);l.callMethodAsync({methodName:"PCAL_getPricingDefinition_WS",data:t});},context:{}});};$EXPR.getCasePricingDefinition=function(n,r){var A,z=n.detailRecords,v=z.length,E=new f("ACTIVITY");for(var A=0;A<v;A++){var B=z[A].records,y,u=B.length;for(y=0;y<u;y++){var o=B[y].targetRecordAsKeyValue,q=o.length,w;var C=c("Type__c",o);if(C!=null&&C.value!=null){if(C.value=="Activity"){var D=c("Activity_Type__c",o);E.addToValues(D.value);}}}}var F=n.headerRecord.records[0].targetRecordId;var m=new j("CASE",F);var s=m.getStringAsXML()+E.getStringAsXML();var x=c("CurrencyIsoCode",n.headerRecord.records[0].targetRecordAsKeyValue);if(x!=""){var t=new j("CASECURRENCYISO",x.value);s+=t.getStringAsXML();}var p=SVMX.getClient().getServiceRegistry().getService("com.servicemax.client.sal.service.factory");p.getInstanceAsync({handler:function(k){var G={type:"SOAP",endPoint:"INTF_WebServicesDef",nameSpace:$EXPR.getOrgNamespace()};var H=k.createServiceManager(G);var l=H.createService();l.bind("REQUEST_COMPLETED",function(I){var J=$.parseXml(I.data,true);var K=J.getFirstElementByTagName("message","http://soap.sforce.com/schemas/class/"+g(i)+"INTF_WebServicesDef");var L=d(K);var M=$EXPR.toObject(L);r(M);},this);l.callMethodAsync({methodName:"PCAL_getCasePricingDefinition_WS",data:s});},context:{}});};function f(k){this.key=k;this.allValues={};this.addToValues=function(l){if(!l){return;}this.allValues[l]=l;};this.getStringAsXML=function(){var o="<valueMap><key>{0}</key>{1}</valueMap>";var p="<values>{0}</values>";var n,l="",m="";for(n in this.allValues){l+=h(p,this.allValues[n]);}a=false;m=h(o,this.key,l);a=true;return m;};}function c(p,l){if(p.indexOf("__c",p.length-"__c".length)!==-1){p=i+"__"+p;}var q=l.length,m,n="";for(m=0;m<q;m++){var o=l[m];if(o.key==p){n=o;break;}}return n;}function j(k,l){this.key=k;this.value=l;this.getStringAsXML=function(){var n="<valueMap><key>{0}</key><value>{1}</value></valueMap>";var m=h(n,this.key,this.value);return m;};}function h(){if(arguments.length==0){return"";}var m=arguments[0];var n;for(var k=1;k<arguments.length;k++){var l=new RegExp("\\{"+(k-1)+"\\}","gi");n=arguments[k];if(a){n=e(arguments[k]);}m=m.replace(l,n);}return m;}function e(k){if(k!=undefined&&k!=null){k=k.split("&").join("&amp;");k=k.split("<").join("&lt;");}return k;}$EXPR.getOrgNamespace=function(){var k=g(i);if(k!=""){k=k.substring(0,k.length-1);}return k;};function g(k){if(k!=null&&k!=""){return k+"/";}else{return"";}}function d(l){var k="";if(l&&l.firstChild){if(l.firstChild.nodeValue){k=l.firstChild.nodeValue;}else{if(l.firstChild.textContent&&l.normalize){l.normalize(l.firstChild);k=l.firstChild.textContent;}}}return k;}};})();
(function(){var a=SVMX.Package("com.servicemax.client.sfmconsole.impl");var c,b;a.Class("Module",com.servicemax.client.lib.api.ModuleActivator,{__constructor:function(){this.__base();this._logger=SVMX.getLoggingService().getLogger("CONSOLE-IMPL");a.Module.instance=this;var d=SVMX.getClient().getApplicationParameter("org-name-space");if(!d||d===""){d="SVMXC";}SVMX.OrgNamespace=d;SVMX.navigateToCheckExternal=function(e,f){if(navigateTo){navigateTo(e,f);}else{SVMX.navigateTo(e);}};SVMX.getCustomFieldName=function(e){return SVMX.OrgNamespace+"__"+e+"__c";};SVMX.getCustomObjectName=function(e){return SVMX.OrgNamespace+"__"+e+"__c";};SVMX.getCustomRelationName=function(e){return SVMX.OrgNamespace+"__"+e+"__r";};SVMX.getTempTableName=function(e){return"TEMP__"+e;};},beforeInitialize:function(){com.servicemax.client.sfmconsole.utils.init();com.servicemax.client.sfmconsole.commands.init();com.servicemax.client.sfmconsole.expressionbridge.init();com.servicemax.client.sfmconsole.constants.init();com.servicemax.client.sfmconsole.engine.init();},initialize:function(){c=SVMX.getClient().getServiceRegistry().getServiceInstance("com.servicemax.client.translation").getDictionary("FSA");},afterInitialize:function(){var d=SVMX.getClient().getServiceRegistry().getService("com.servicemax.client.preferences").getInstance();d.addPreferenceKey(com.servicemax.client.sfmconsole.constants.Constants.PREF_LOGGING);}},{instance:null});a.Class("Application",com.servicemax.client.lib.api.AbstractApplication,{__parent:null,__logger:null,__namedInstanceService:null,__stateHandlers:{applicationStateHandler:null,applicationErrorHandler:null,applicationMessageUIHandler:null,applicationQuickMessageHandler:null,},__consoleAppConfigs:null,__runningConsoleAppsByAppId:null,__runningConsoleAppsByWindowId:null,__launchingConsoleAppsById:null,__userInfo:null,__notificationService:null,__view:null,__constructor:function(){this.__parent=a.Module.instance;this.__logger=this.__parent.getLogger();this.__notificationService=SVMX.getClient().getServiceRegistry().getServiceInstance("com.servicemax.client.notifications");this.__consoleAppConfigs={};this.__runningConsoleAppsByAppId={};this.__runningConsoleAppsByWindowId={};this.__launchingConsoleAppsById={};},triggerEvent:function(d){SVMX.getLoggingService().getLogger("SFMConsoleApplication").warn("SFMConsole event triggered: "+d.type);return this.__base(d);},beforeRun:function(d){var e=SVMX.getClient().getServiceRegistry().getService("com.servicemax.client.niservice").getInstance();e.createNamedInstanceAsync("CONTROLLER",{handler:function(f){e.createNamedInstanceAsync("MODEL",{handler:function(g){f.setModel(g);e.createNamedInstanceAsync("SFMCONSOLE.VIEW",{handler:function(h){this.__view=h;d.handler.call(d.context);},context:this,additionalParams:{}});},context:this});},context:this,additionalParams:{eventBus:this}});},run:function(){this.__logger.info("Caching is => "+SVMX.isCachingEnabled());this.__loadTags(SVMX.proxy(this,function(){this.__runConsole();}));},__runConsole:function(){var d=this;d.getAppInfo().then(function(e){d.__addDeviceInfo().then(SVMX.proxy(d,function(f){d.__runSync();}));});},getAppInfo:function(){var d=SVMX.Deferred();var e=SVMX.create("com.servicemax.client.sfmconsole.utils.EventCollection",this,[SVMX.create("com.servicemax.client.lib.api.Event","SFMCONSOLE.GET_APP_INFO",this,{request:{}})]);e.triggerAll(function(g){var h=g.items()[0].response;var f=(h.version||"");SVMX.getClient().addApplicationParameter("app-version",f);SVMX.getClient()["ClientVersion"]=f;d.resolve(h);});return d.promise();},__addDeviceInfo:function(){var g=SVMX.Deferred();var f=com.servicemax.client.offline.sal.model.nativeservice.Facade;var e=f.createDeviceInfoRequest();e.bind("REQUEST_COMPLETED",function(d){SVMX.getClient().addApplicationParameter("device-info",d.data.data||{});if(SVMX.getClient().getApplicationParameter("device-info")&&SVMX.getClient().getApplicationParameter("device-info")["client-type"]){var m=SVMX.getClient().getApplicationParameter("device-info")["client-type"];SVMX.getClient().addApplicationParameter("client-type",m);SVMX.getClient().isLaptop=function(){return SVMX.getClient().getApplicationParameter("client-type").toLowerCase()=="laptop";};var j=SVMX.getClient().getApplicationParameter("device-info")["details"];var l;if(!SVMX.getClient().isLaptop()){if(typeof j!=="string"){l=j.uuid;}}else{var k=JSON.parse(j);for(var h=0;h<k.length;h++){if(k[h].Key==="BiosSerialNumber"){l=k[h].Value;break;}}}SVMX.getClient().addApplicationParameter("client-uuid",l);if(!SVMX.getClient().isLaptop()){$(document).on("click",'a[href^="http"]',function(n){var i=$(this).attr("href");window.open(i,"_system");n.preventDefault();});}SVMX.getClient().isBarCodeEnabled=function(){var i=false;var n=SVMX.getClient().getApplicationParameter("device-info");if(n&&n["barcode-enabled"]){i=true;}return i;};}g.resolve({});},this);e.bind("REQUEST_ERROR",function(d){g.resolve({});},this);e.execute({method:"DEVICEINFO",type:"MISC"});return g;
},__runSync:function(){var d=this.__getSyncImpl();this.__buildRootContainer();this.showSpinner(this.getRoot());this.__discoverConsoleApps();d.bind("SYNC_FINISHED_INITIALIZING",function(e){if(e.data.lastSync.user){this.setUserInfo(e.data.lastSync.user);}this.hideSpinner(this.getRoot());setTimeout(SVMX.proxy(this,function(){this.__syncCompleted(e.data.lastSync);}),200);},this);d.bind("SYNC_COMPLETED",function(e){d.getSyncUserInfo({context:this,callback:function(f){this.setUserInfo(f);}});},this);d.run();},__syncCompleted:function(d){if(c.isEmpty()){this.__loadTags(SVMX.proxy(this,function(){this.__buildConsole(d);}));}else{this.__buildConsole(d);}},__buildConsole:function(i){this.__userInfo=i.user;if(!SVMX.TEST){this.__root.setUserInfo(this.getUserInfo());}this.__openFirstConsoleApp();this.__startIncrementalReSync();var d=SVMX.create("com.servicemax.client.lib.api.Event","CONSOLE_APP_LAUNCHED",this);SVMX.getClient().triggerEvent(d);var e=SVMX.getClient().getApplicationParameter("InstallBase");if(e){var h={action:"OPEN",operation:"OPEN"};var g=com.servicemax.client.offline.sal.model.nativeservice.Facade;var f=g.createSendExternalRequest();f.bind("REQUEST_COMPLETED",function(j){});f.bind("REQUEST_ERROR",function(j){});f.execute({appName:"Installigence",externalRequest:SVMX.toJSON(h)});}},__loadTags:function(i){var e=SVMX.getClient();var h=e.getDeclaration("com.servicemax.client.sfmconsole.translation-tags");var f=e.getDefinitionsFor(h)||[];var g=SVMX.array.map(f,function(j){return j.config;});var d=SVMX.create("com.servicemax.client.lib.api.Event","SFMCONSOLE.RETRIEVE_DISPLAY_TAGS",this,{request:{moduleIds:g},responder:SVMX.create("com.servicemax.client.sfmconsole.commands.RetrieveDisplayTagsResponder",this,i)});this.triggerEvent(d);},onRetrieveDisplayTags:function(g,e,f){c=g.getDictionary("IPAD");b=g.getDictionary("FSA");var d=SVMX.create("com.servicemax.client.lib.api.Event","DISPLAY_TAGS_LOADED",this);SVMX.getClient().triggerEvent(d);f.call();},__discoverConsoleApps:function(){var e=SVMX.getClient().getDeclaration("com.servicemax.client.sfmconsole.consoleapp");var p=SVMX.getClient().getDefinitionsFor(e);if(p.length===0){this.__logger.error("No console apps defined.");return;}var h=[];for(var j=0;j<p.length;j++){var n=p[j].config.app.id;this.__consoleAppConfigs[n]=p[j].config;var s=this.__consoleAppConfigs[n].tooltip;var g=(typeof s==="object")?s[0]:s;var k=(typeof s==="object")?s[1]:s;var o=this.__consoleAppConfigs[n]["button-text"];var f=(typeof o==="object")?o[0]:o;var l=(typeof o==="object")?o[1]:o;var d=false;var r="";if(this.__consoleAppConfigs[n]["show-conflicts"]){d=true;r=this.__consoleAppConfigs[n]["conflict-badge-class"]||"";}if(this.__consoleAppConfigs[n].discover){h.push({weight:p[j].config.positionWeight,context:this,key:n,iconClass:this.__consoleAppConfigs[n].icon["large-css-class"],tooltip:g?c.T(g,k):"",buttonText:f?b.T(f,l):"",showConflictBadge:d,conflictBadgeCls:r});}}h.sort(function(t,i){return t.weight-i.weight;});for(var q=0;q<h.length;q++){if(h[q]){this.__registerLaunchableApp(h[q]);}}var m=SVMX.create("com.servicemax.client.lib.api.Event","CONSOLE_APPS_REGISTERED",this);SVMX.getClient().triggerEvent(m);},__buildRootContainer:function(){this.__root=this.__view.createComponent("ROOTCONTAINER",{renderTo:SVMX.getDisplayRootId(),console:this});},getAppConfig:function(d){return this.__consoleAppConfigs[d];},getRoot:function(){return this.__root;},forEachConsoleApp:function(d){SVMX.forEachProperty(this.__runningConsoleAppsByWindowId,function(f,e){d(e);});},getCurrentConsoleApp:function(){throw"Application subclass must implement getCurrentConsoleApp";},findConsoleAppByAppId:function(d){return this.__runningConsoleAppsByAppId[d];},findConsoleAppByWindowId:function(d){return this.__runningConsoleAppsByWindowId[d];},showConsoleApp:function(d){throw"Subclass must implement showConsoleApp";},launchConsoleApp:function(h,f){if(this.consoleAppLaunching(h)){return false;}f=f||{};var e;var d=this.getAppConfig(h);var g=d?!d.multiple:false;if(g){e=this.findConsoleAppByAppId(h);}if(g&&e){f.context=this;e.show();}else{e=this.createConsoleApp(h,f);if(e){f.context=this;e.show();e.__start(f);}}this.consoleAppLaunched(h);},createConsoleApp:function(i,f){var e;var d=this.getAppConfig(i);var h=d?!d.multiple:false;if(!d){this.__logger.error("Console App Not Defined: "+i);}else{f.isClosable=!h;try{e=this.__createConsoleAppInternal(i,f);this.__runningConsoleAppsByAppId[e.getAppTypeId()]=e;this.__runningConsoleAppsByWindowId[e.getId()]=e;}catch(g){this.__logger.error(g);return false;}}return e;},consoleAppLaunching:function(e){if(!this.__launchingConsoleAppsById[e]){var d=this;setTimeout(function(){d.__launchingConsoleAppsById[e]=null;},1000);return false;}return true;},consoleAppLaunched:function(d){this.__launchingConsoleAppsById[d]=true;},__createConsoleAppInternal:function(e,d){return SVMX.create(this.getAppConfig(e).app["class-name"],{parent:this,rootContainer:this.__root,appConfig:this.getAppConfig(e),options:d});
},closeClosableApps:function(){this.forEachConsoleApp(SVMX.proxy(this,function(d){if(d.__appConfig.multiple){this.destroyConsoleApp(d);}}));},applyAppInfo:function(d,e){},__getSyncImpl:function(){if(!this.__syncImpl){var f=SVMX.getClient().getDeclaration("com.servicemax.client.sfmconsole.synchronizer");var e=SVMX.getClient().getDefinitionsFor(f);if(e.length===0){this.__logger.error("Unable to load console synchronizer");return;}var d=e[0].config.impl["class-name"];this.__syncImpl=SVMX.create(d,this);}return this.__syncImpl;},getSyncImpl:function(){return this.__syncImpl;},changeApplicationState:function(d){switch(d.state){case"BLOCK":this.showSpinner();break;case"UNBLOCK":this.hideSpinner();break;}},showSpinner:function(d){if(this.__notificationService){this.__notificationService.waitingMessage(d);}else{this.__logger.error("showSpinner failed because there is no notification service");}},hideSpinner:function(d){if(this.__notificationService){this.__notificationService.endWaitingMessage(d);}},runManualSyncBackground:function(){this.__getSyncImpl().performSync("ONECALLSYNC");},getUserInfo:function(){return SVMX.cloneObject(this.__userInfo)||{};},setUserInfo:function(d){if(!d){return;}var e=d&&!this.__userInfo||d&&this.__userInfo&&this.__userInfo.UserSessionId!=d.UserSessionId;this.__userInfo=d;if(this.__userInfo.TimezoneOffset===undefined){this.__userInfo.TimezoneOffset=com.servicemax.client.lib.datetimeutils.DatetimeUtil.getLocalUTCOffsetString();}var g=com.servicemax.client.lib.datetimeutils.DatetimeUtil;g.setDateFormat(d.DateFormat);g.setTimeFormat(d.TimeFormat);g.setTimezoneOffset(d.TimezoneOffset);if(d.Timezone){g.setTimezone(d.Timezone);}else{g.setTimezoneOffset(d.TimezoneOffset);}if(e){var f=SVMX.create("com.servicemax.client.lib.api.Event","GLOBAL.HANDLE_USER_INFO",this,d);SVMX.getClient().triggerEvent(f);}},closeConsoleApp:function(d){if(d){d.onCanClose(SVMX.proxy(this,function(e){if(e===true){this.destroyConsoleApp(d);}}));}},destroyConsoleApp:function(d){if(d){d.onClose();delete this.__runningConsoleAppsByWindowId[d.getId()];if(this.__runningConsoleAppsByAppId[d.getAppTypeId()]==d){delete this.__runningConsoleAppsByWindowId[d.getAppTypeId()];}this.__root.manageConsoleAppContainerClose(d);d.destroy();}},goToHome:function(){this.__openFirstConsoleApp(true);},__getFirstConsoleApp:function(){var d=(SVMX.getClient().getApplicationParameter("sfmconsole-runtime-start")||null);if(!d||d===""){this.__logger.error("sfmconsole-runtime-start is not set in application config.");return false;}return d;},__openFirstConsoleApp:function(){var d=this.__getFirstConsoleApp();if(d){this.launchConsoleApp(d,{});}},__startIncrementalReSync:function(){if(this.__userInfo&&this.__userInfo.reSync){this.runManualSyncBackground();}},setApplicationStateHandler:function(d){this.__stateHandlers.applicationStateHandler=d;},getApplicationStateHandler:function(){return this.__stateHandlers.applicationStateHandler||this;},setApplicationErrorHandler:function(d){this.__stateHandlers.applicationErrorHandler=d;},getApplicationErrorHandler:function(){return this.__stateHandlers.applicationErrorHandler||this;},setApplicationMessageUIHandler:function(d){this.__stateHandlers.applicationMessageUIHandler=d;},getApplicationMessageUIHandler:function(){return this.__stateHandlers.applicationMessageUIHandler||this;},setApplicationQuickMessageHandler:function(d){this.__stateHandlers.applicationQuickMessageHandler=d;},getApplicationQuickMessageHandler:function(){return this.__stateHandlers.applicationQuickMessageHandler||this;},showQuickMessage:function(e,f,d){if(this.__notificationService){this.__notificationService.quickMessage(e,f,d);}else{this.__logger.error("showQuickMessage failed because there is no notification service");}},notifyApplicationError:function(d){if(this.__notificationService){var e=c.T("FSA007_TAG005","Error Message");this.__notificationService.errorMessage(d,e);}else{this.__logger.error("notifyApplicationError failed because there is no notification service");}},showMessage:function(e){var d;if(this.__notificationService){if(!e.title){e.title=c.T("FSA007_TAG006","Information");}d=this.__notificationService.showMessage(e);}else{this.__logger.error("showMessage failed because there is no notification service");}return d;},checkForMessageId:function(d){return(this.__notificationService&&this.__notificationService.checkForMessageId(d))?true:false;}},{});a.Class("CompositionEngine",com.servicemax.client.lib.api.Object,{__metamodel:null,__parent:null,__constructor:function(d,e){this.__metamodel=d;this.__parent=e;},compose:function(){var d=this.__parent.__self.composition;return this.__composeInternal(this.__metamodel,d,this.__parent);},__composeInternal:function(e,f,p){var d=f.length,k;for(k=0;k<d;k++){var g=f[k];var q=e.getChildNode(g.name);if(q){var l=null,n=g.className;if(q instanceof Array===false){q=[q];}var m=q.length,h,o;for(h=0;h<m;h++){o=q[h];if(o.title){o.title=Ext.String.htmlEncode(o.title);}l=SVMX.create(n,{compositionMetamodel:o});
if(l.__self.composition!==undefined){this.__composeInternal(o,l.__self.composition,l);}p.onCompositionChildCreate(l,g.name);}}}}},{});})();